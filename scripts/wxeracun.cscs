Import(strTrim(mpath()) + "CSCS.Math.dll");

args = CommandLineArgs(); 
if(Size(args) > 1){
    companyCode = args[2]; // e.g. Y3
    if(companyCode != ""){  
        CoSet(companyCode);
    }else{
        MessageBox("Nedostaje šifra tvrtke u argumentima.");
        exit;
    }    
    userCode = args[3]; // e.g. ANA
    if(userCode != ""){  
    }else{  
        MessageBox("Nedostaje šifra korisnika u argumentima.");
        exit;
    }    
    invNum = args[4]; // e.g. 90100002
    if(invNum != 0){  
    }else{  
        MessageBox("Nedostaje broj računa u argumentima.");
        exit;
    }    
    attachmentPdfPath = args[5]; // e.g. C:\Temp\90100002.pdf
    if (attachmentPdfPath != ""){     
    }else{
        MessageBox("Nedostaje putanja PDF privitka u argumentima.");
        exit;
    }
    CopyIndicator = args[6]; // 'D' - duplicate, '' - original
    if (CopyIndicator != ""){     
    }else{
        CopyIndicator = "";
    }
}else{
    MessageBox("Nedostaju argumenti komandne linije.");
    exit;
}   

// NKSYCCYR
sqlQueryString = "select SY_CC_USER, SY_CC_DBASE from " + strtrim(CommonDBGet()) + ".dbo.NKSYCCYR WHERE SY_CC_CODE = '" + companyCode + "'";
try
{
    sqlResult = sqlQuery(sqlQueryString);
}
catch(exc)
{
    MessageBox("NKSYCCYR reading error: " + exc);
    exit;
}
if (size(sqlResult) > 1)
{
    // imeFirme = sqlResult[1][0].trim(); // KAMEND
    // ovagod_h = sqlResult[1][1].trim(); // 2022
    SY_CC_USER = sqlResult[1][0].trim(); // KAMEND
    databaseName = sqlResult[1][1].trim(); // ime baze
}    
  


// KPSYMSTR
sqlQueryString = " SELECT TOP 1 KPSY_REZERVA, KPSY_COMP_NAME, KPSY_COMP_ADD1, KPSY_GL_RETEARN, KPSY_COMP_CSZ, KPSY_COMP_ZIP,
                KPSY_COMP_JMBFI, KPSY_COMP_PHONE, KPSY_COMP_EMAIL, KPSY_PO_FREIGHT, KPSY_REZERVAX,KPSY_PR_R1_R2
                    FROM " + databaseName + ".dbo.KPSYMSTR";
try
{
    sqlResult = sqlQuery(sqlQueryString);
}
catch(exc)
{
    MessageBox("KPSYMSTR reading error: " + exc);
    exit;
}
if (size(sqlResult) > 1)
{
    // proslaGodina = (int(ovagod_h) - 1);
    // nazivFirme = sqlResult[1][0].trim();
    // kpsy_po_freight= sqlResult[1][1].trim();
    // fiscal_yr = sqlResult[1][2];
    // local = sqlResult[1][3];

    KPSY_REZERVA = sqlResult[1][0].trim();
    KPSY_COMP_NAME = sqlResult[1][1].trim();
    KPSY_COMP_ADD1 = sqlResult[1][2].trim();
    KPSY_GL_RETEARN = sqlResult[1][3].trim();
    KPSY_COMP_CSZ = sqlResult[1][4].trim();
    KPSY_COMP_ZIP = sqlResult[1][5];
    KPSY_COMP_JMBFI = sqlResult[1][6].trim();
    KPSY_COMP_PHONE = sqlResult[1][7].trim();
    KPSY_COMP_EMAIL = sqlResult[1][8].trim();
    KPSY_PO_FREIGHT = substring(sqlResult[1][9], 0, 2).trim();
    KPSY_REZERVAX = sqlResult[1][10].trim(); // Supplier GLN
    KPSY_PR_R1_R2 = sqlResult[1][11].trim(); // PDV ID za R1/R2 izvještaje
    supOIB = Substring(KPSY_REZERVA, 0, 11); // ??? a ča ne 11(OIB) znakova ?? ili 13(JMBG) + trim() ??
    //supOIBParts = supOIB.split(" ");
    //supOIB = supOIBParts[0].trim();
} 



// NKSYSYCO
sqlQueryString = " SELECT NKSYS_FIELD, NKSYS_VALUE 
    FROM " + databaseName + ".dbo.NKSYSYCO 
    WHERE NKSYS_MODUL = 'WKSY'
    AND NKSYS_GRUP = 'ERACUN'";
try
{
    sqlResult = sqlQuery(sqlQueryString);
}
catch(exc)
{
    MessageBox("NKSYSYCO reading error: " + exc);
    exit;
}
if (size(sqlResult) > 1)
{
    for(i = 1; i < Size(sqlResult); i++){
        if(sqlResult[i][0].trim() == "FILESPATH"){
            FILESPATH = sqlResult[i][1].trim();
        }
        elif(sqlResult[i][0].trim() == "PROVIDER")
        {
            PROVIDER = sqlResult[i][1].trim().Upper();
        }elif(sqlResult[i][0].trim() == "SCHEMASPATH")
        {
            SCHEMASPATH = sqlResult[i][1].trim();
        }
    }
} 

xmlFileName = "";

// generate xml
if(!GenerateUBLXml()){
    MessageBox("Greška pri generiranju UBL XML-a za račun " + invNum + "!");    
    exit;
}elif(NKSC_REZ10 == "P"){
    //LogNKSYELOG("A");
    //send xml
    // MessageBox("AAA ŠALJEM XML ZA RAČUN " + invNum);
    SendERacun(); 
    // MessageBox("BBB POSLAN XML ZA RAČUN " + invNum); 
}

exit;





//-----------------------------------------------------------
// XML GENERATION 
//-----------------------------------------------------------

function GenerateUBLXml() {
  
    // -----------------------------------------------------------
    // 1. Load Header
    // -----------------------------------------------------------
    
    sql_hdr = "SELECT
                NKPR_GL_NUM, NKPR_GL_OZNAKA, NKPR_GL_BROTP, NKPR_GL_REZ1, NKPR_GL_REZ3,
                CONVERT(VARCHAR(10), NKPR_GL_INVDTE, 23) as NKPR_GL_INVDTE,
                CONVERT(VARCHAR(8), NKPR_GL_TIMECR, 20) as NKPR_GL_TIMECR,
                CONVERT(VARCHAR(10), NKPR_GL_DVO, 23) as NKPR_GL_DVO,
                NKPR_GL_NOKAM, NKPR_GL_ROKPL,
                CONVERT(VARCHAR(10), NKPR_GL_ESD, 23) as NKPR_GL_ESD,
                NKPR_GL_PICTHDR, NKPR_GL_PICTFTR, NKPR_GL_CUSNME, NKPR_GL_JMBG,
                NKPR_GL_CUSA1, NKPR_GL_RO, NKPR_GL_CUSCTY, NKPR_GL_CUSZIP, NKPR_GL_DRZAVA, NKPR_GL_SIF_PL, NKPR_GL_MODEL,
                NKPR_GL_POZIV, NKPR_GL_RZRVA1, NKPR_GL_TOTAL, NKPR_GL_CUSORD, NKPR_GL_CUSST,
                NKPR_GL_ENTBY, NKPR_GL_BROPIS, NKPR_GL_BROPIS1,
                CONVERT(varchar(10), DATEADD(DAY, NKPR_GL_NOKAM + NKPR_GL_ROKPL, NKPR_GL_DVO), 23) as NKPR_GL_DUE_DATE,
                NKPR_GL_SCONTO,NKPR_GL_DANSC,NKPR_GL_REZ3,NKPR_GL_SHPCOD, NKPR_GL_SHPNME, NKPR_GL_SHPRO, NKPR_GL_SHPA1, 
                NKPR_GL_SHPZIP, NKPR_GL_SHPCTY,NKPR_GL_SHPST, NKPR_GL_UGOVOR,NKPR_GL_CUSCOD,NKPR_GL_RNALOG,
                SUBSTRING(NKSP_AD_REZ,37,13) as NKSP_AD_GLN ,SUBSTRING(NKSP_AD_REZ,51,20) as NKSP_AD_OBJED, 
                NKSC_SOP, NKSC_POSREDNIK, NKSC_REZ10, NKSC_TAX_DN, substring(NKSC_REZ, 42, 10) as POSREDNIK,
                PKKU_PP_OPIS
                FROM " + databaseName + ".dbo.NKPRINV LEFT JOIN " + databaseName + ".dbo.NKSCPART ON NKPR_GL_CUSCOD = NKSC_PARTCODE
                    LEFT JOIN " + databaseName + ".dbo.NKSPADRS ON nkpr_gl_cuscod= nksp_ad_code AND nkpr_gl_shpcod= nksp_ad_codeint
                    LEFT JOIN " + databaseName + ".dbo.PKKUPPUG ON nkpr_gl_ugovor= pkku_pp_broj
                WHERE NKPR_GL_NUM = @p1;";
    sqlParams = {};
    sqlParams.Add({"@p1", invNum});
    //SaveFile(sql_hdr, "c:\\winx\\sql_hdr.txt");   

    hdrRes = sqlQuery(sql_hdr, sqlParams);
    if (Size(hdrRes) < 2) {
        MessageBox("Ne postoji račun " + invNum + "!");
        return false;
    }


    NKPR_GL_NUM = hdrRes[1][0];
    NKPR_GL_OZNAKA = hdrRes[1][1].trim();
    NKPR_GL_BROTP = hdrRes[1][2];
    NKPR_GL_REZ1 = hdrRes[1][3];
    NKPR_GL_REZ3 = hdrRes[1][4];
    NKPR_GL_INVDTE = hdrRes[1][5].trim();
    NKPR_GL_TIMECR = hdrRes[1][6].trim();
    NKPR_GL_DVO = hdrRes[1][7].trim();
    NKPR_GL_NOKAM = hdrRes[1][8];
    NKPR_GL_ROKPL = hdrRes[1][9];
    NKPR_GL_ESD = hdrRes[1][10].trim();
    NKPR_GL_PICTHDR = hdrRes[1][11];
    NKPR_GL_PICTFTR = hdrRes[1][12];
    NKPR_GL_CUSNME = hdrRes[1][13].trim();
    NKPR_GL_JMBG = hdrRes[1][14].trim();
    NKPR_GL_CUSA1 = hdrRes[1][15].trim();
    NKPR_GL_RO = hdrRes[1][16].trim();
    NKPR_GL_CUSCTY = hdrRes[1][17].trim();
    NKPR_GL_CUSZIP = hdrRes[1][18];
    NKPR_GL_DRZAVA = hdrRes[1][19].trim();
    NKPR_GL_SIF_PL = hdrRes[1][20].trim();
    NKPR_GL_MODEL = hdrRes[1][21].trim();
    NKPR_GL_POZIV = hdrRes[1][22].trim();
    NKPR_GL_RZRVA1 = hdrRes[1][23].trim();
    NKPR_GL_TOTAL = hdrRes[1][24];
    NKPR_GL_CUSORD = hdrRes[1][25].trim();
    NKPR_GL_CUSST = hdrRes[1][26].trim();
    NKPR_GL_ENTBY = hdrRes[1][27].trim();
    NKPR_GL_BROPIS = hdrRes[1][28].trim();
    NKPR_GL_BROPIS1 = hdrRes[1][29].trim();
    NKPR_GL_DUE_DATE = hdrRes[1][30].trim();
    NKPR_GL_SCONTO = hdrRes[1][31].trim();
    NKPR_GL_DANSC = hdrRes[1][32].trim();
    NKPR_GL_REZ3 = hdrRes[1][33].trim();
    NKPR_GL_SHPCOD = hdrRes[1][34].trim();
    NKPR_GL_SHPNME = hdrRes[1][35].trim();
    NKPR_GL_SHPRO = hdrRes[1][36].trim();
    NKPR_GL_SHPA1 = hdrRes[1][37].trim();
    NKPR_GL_SHPZIP = hdrRes[1][38].trim();
    NKPR_GL_SHPCTY = hdrRes[1][39].trim();
    NKPR_GL_SHPST = hdrRes[1][40].trim();
    NKPR_GL_UGOVOR = hdrRes[1][41].trim();
    NKPR_GL_CUSCOD = hdrRes[1][42].trim();
    NKPR_GL_RNALOG = hdrRes[1][43].trim();
    NKSP_AD_GLN = hdrRes[1][44].trim();
    NKSP_AD_OBJED = hdrRes[1][45].trim();
    NKSC_SOP = hdrRes[1][46].trim(); // Customer GLN
    NKSC_POSREDNIK = hdrRes[1][47].trim().Upper(); // Not in use
    NKSC_REZ10 = hdrRes[1][48].trim().Upper(); // P - šalji na server / F = spremi file na disk / E - šalji na E-mail(NIJE U FUNKCIJI)
    NKSC_TAX_DN = hdrRes[1][49].trim().Upper(); // F - kupac po fakturiranoj realizaciji/ N = po naplaćenoj realizaciji / X - nije u sustavu PDV-a
    POSREDNIK = hdrRes[1][50].trim();
    PKKU_PP_OPIS = hdrRes[1][51].trim();

    if(NKSC_REZ10 == "E"){
        MessageBox("Način slanja e-računa e-mailom(E) nije podržan! Partner " + NKSC_PARTCODE + ".");
        exit;
    }elif(NKSC_REZ10 != "P" && NKSC_REZ10 != "F"){
        MessageBox("Neispravno konfiguriran način slanja e-računa(" + NKSC_REZ10 + ") za partnera " + NKSC_PARTCODE + "!");
        exit;
    }
    // NKSC_POSERDNIK SE KORISTI ISKLJUČIVO ZA MEGGLE EDITEL, OMNIZON, ...
    // if(NKSC_POSREDNIK != ""){    
    //     PROVIDER = NKSC_POSREDNIK;
    // }
    if(POSREDNIK != ""){    
        PROVIDER = POSREDNIK;
    }

    // msg("CCC Slanje eRačuna putem posrednika: " + PROVIDER);
    sql_erac = "SELECT
                ERAC_REZ1, ERAC_SERVER, ERAC_SERVERT, ERAC_USER, ERAC_PASS, ERAC_USERT, ERAC_PASST, ERAC_DESC,ERAC_CODE 
                FROM " + databaseName + ".dbo.NKSYERAC WHERE ERAC_CODE = @p1;";
    sqlParams = {};
    sqlParams.Add({"@p1", PROVIDER});
    
    eracRes = sqlQuery(sql_erac, sqlParams);
    if (Size(eracRes) < 2) {
        MessageBox("Nema podataka o posredniku " + PROVIDER + "!");
        return false;
    }

    ERAC_REZ1 = eracRes[1][0].trim();
    ERAC_SERVER = eracRes[1][1].trim();
    ERAC_SERVERT = eracRes[1][2].trim();
    ERAC_USER = eracRes[1][3].trim();
    ERAC_PASS = eracRes[1][4].trim();
    ERAC_USERT = eracRes[1][5].trim(); // cer certificate
    ERAC_PASST = eracRes[1][6].trim(); // p12 certificate
    ERAC_DESC = eracRes[1][7].trim();
    ERAC_CODE = eracRes[1][8].trim();
    //MessageBox("Slanje eRačuna putem posrednika: " + PROVIDER + " (" + ERAC_PASST + ")");

    // -----------------------------------------------------------
    // 2. Load Lines
    // -----------------------------------------------------------
    sql_lin = "SELECT
                NKPR_LN_PQTY,
                NKPR_LN_INVNM,
                NKPR_LN_AMT,
                NKPR_LN_PCODE,
                NKPR_LN_SASTAV,
                NKPR_LN_PDESC,
                NKPR_LN_GRUPA,
                NKPR_LN_TXBLE,
                NKPR_LN_PRNPR,
                NKPR_LN_JEDMJ,
                NKPR_LN_PPRCE,
                NKPR_LN_PEXT,
                NKPR_LN_PDISC,
                NKPR_LN_DISC2,
                NKPR_LN_DISC2T,
                NKPR_LN_DISC3,
                NKPR_LN_DISC3T,
                NKPR_LN_MA_US,
                NKPR_LN_BR_LN,
                NKPR_LN_BROPI,
                NKPR_LN_BROPI1,
                NKPR_LN_PSTOPA,
                NKPR_LN_POPU,
                NKPR_LN_POPL
                FROM " + databaseName + ".dbo.NKPRINVL WHERE NKPR_LN_INVNM = @p1 ORDER BY NKPR_LN_INVNM, NKPR_LN_BR_LN;";
    sqlParams = {};
    sqlParams.Add({"@p1", invNum});
    linRes = sqlQuery(sql_lin, sqlParams);
    if (Size(linRes) < 2) {
        MessageBox("Račun " + invNum + " nema linija!");
        return false;
    }
    
    // -----------------------------------------------------------
    // 2.1. Load KPSYUSER and find user OIB
    // -----------------------------------------------------------
    
    sql_KPSYUSER = "SELECT
                KPSY_USER_NAZIV, KPSY_USER_CODE
                FROM " + databaseName + ".dbo.KPSYUSER WHERE KPSY_USER_ZNAK = @p1";
    sqlParams = {};
    sqlParams.Add({"@p1", NKPR_GL_ENTBY});
    kpsyuserRes = sqlQuery(sql_KPSYUSER, sqlParams);
    if (Size(kpsyuserRes) < 2) {
        MessageBox("Nema podataka za o prodavaču " + NKPR_GL_ENTBY + "!");
        return false;
    }

    KPSY_USER_NAZIV = kpsyuserRes[1][0].trim();
    KPSY_USER_CODE = kpsyuserRes[1][1].trim();
    

    sql_oib = "SELECT
                NKSYS_VALUE
                FROM " + databaseName + ".dbo.NKSYSYCO WHERE NKSYS_MODUL = 'WKSY' AND NKSYS_GRUP = 'USER' AND NKSYS_GRUP2 = @p1 AND NKSYS_FIELD = 'OIB';";
    sqlParams = {};
    sqlParams.Add({"@p1", KPSY_USER_CODE});
    kpsyuserRes = sqlQuery(sql_oib, sqlParams);
    if (Size(kpsyuserRes) < 2) {
        MessageBox("Nema podataka za OIB prodavača " + NKPR_GL_ENTBY + "/" + KPSY_USER_CODE + "!");
        return false;
    }
    UserOib = kpsyuserRes[1][0].trim();

    // -----------------------------------------------------------
    // 3. Determine ProfileID, TypeCode, Invoice Type
    // -----------------------------------------------------------
    profileID = "P1";
    typeCode = "380";
    invType = "Izdavanje računa za isporuke prema neformalnom ugovoru";

    if (NKPR_GL_OZNAKA == "S") {
        if (NKPR_GL_BROTP != 0) {
            profileID = "P7";
            invType = "Račun s referencom na otpremnicu"; //samo jedna otpremnica po računu je moguća!
        } elif (NKPR_GL_CUSORD != "") {
            //u tom polju je referenca na narudžbenicu kupca
            profileID = "P3";
            invType = "Račun sa referencom na narudžbenicu kupca"; //samo jedna narudžbenica po računu je moguća!
        } elif (NKPR_GL_REZ1 != 0) {
            //u REZ1 je referenca na prethodni račun
            profileID = "P11";
            invType = "Djelomični i konačni račun";
        }
    } elif (NKPR_GL_OZNAKA == "P") {
        //za ovaj tip računa - PREDUJAM - ne treba unositit KPD!!!
        if (NKPR_GL_CUSORD == ""){
            profileID = "P4";
        } else {
            //a ako ima narudžbenicu onda je P6
            profileID = "P6";
        }
        typeCode = "386";
        invType = "Avansno plaćanje (plaćanje unaprijed)";
    } elif (NKPR_GL_OZNAKA == "R") {
        //Reklamacija ili povrat sa ovim tipom se isto može napraviti storno računa
        profileID = "P9";
        typeCode = "381";
        invType = "Reklamacija ili povrat robe (CreditNote)";
    } elif (NKPR_GL_OZNAKA == "T") {
        //sa ovim tipom se radi terećenje, iznosi su svi u plusu, ali element je DebitNote
        profileID = "P1";
        typeCode = "383";
        invType = "Terećenje (DebitNote)";
    } elif (NKPR_GL_OZNAKA == "O") {
        //Odobrenje
        if (NKPR_GL_REZ3 != 0 ) {
            //mora imati referencu na neki račun
            profileID = "P9";
            typeCode = "381";
            invType = "Kreditni račun (CreditNote)"; // (negativni iznosi, povrati) - u pravilu su iznosi u minusu, osim ako se odobrava cassa sconto";
        } else {
            MessageBox("Račun označen kao 'Odobrenje' mora imati referencu na broj i datum računa u polju Ref.Računa!");
            return false;    
        }
    } elif (NKPR_GL_OZNAKA == "X") {
        //ovo se tako koristi u Poslovnim knjigama, i iznosi u linijama su u minusu; sa ovim tipom može se unositi i terećenje ali ako su iznosi u PLUSU!!
        if (NKPR_GL_REZ3 != 0 ) {
            //mora imati referencu na neki račun
            profileID = "P10";
            typeCode = "384";
            invType = "Korektivni račun (storno ili ispravak)";
        } else {
            MessageBox("Račun označen kao " + invType + " mora imati referencu na broj i datum računa u polju Ref.Računa!");
            return false;    
        }
    }

    if(profileID == "P9"){
        //CreditNote
        formatNumOption = "abs";
    }else{
        formatNumOption = "";
    }
     

    // -----------------------------------------------------------
    // Tax Calculation
    // -----------------------------------------------------------
    //PKFK_TAX_TIP - '' - simple tax code; S= compound tax code Porez1+Porez2; Z - compound tax code Porez1*(1+Porez2)
    //PKFK_TAX_DOBOPC - Code of internal note about tax exempt
    //PKFK_TY_P_PORZ - 'P' -porez PDV; 'R' - pretporez PDV; T - porez na potrošnju; 'O' - ostali porezi 
    //PKFK_TAX_POR1 - first tax code if compound code
    //PKFK_TAX_POR2 - second tax code if compound code

    sql_tax = "SELECT SUM(NKPR_LN_POREZ) AS POREZ, SUM(NKPR_LN_AMT) AS OSNOVICA, NKPR_LN_PRNPR, PKFK_TAX_TARIFA , SUBSTRING(PKFK_TAX_DOBOPC,1,2) AS PKFK_TAX_DOBOPC,
              PKFK_TAX_TIP PKFK_TAX_TIP, PKFK_TAX_P_PORZ, PKFK_TAX_POR1, PKFK_TAX_POR2 " +
              "FROM " + databaseName + ".dbo.NKPRINVL LEFT JOIN " + databaseName + ".dbo.PKFKPORZ ON PKFK_TAX_CODE = NKPR_LN_TXBLE " +
              "WHERE NKPR_LN_INVNM = @p1 AND NKPR_LN_TXBLE <> 0 " +
              "GROUP BY NKPR_LN_PRNPR, PKFK_TAX_TARIFA,
              SUBSTRING(PKFK_TAX_DOBOPC,1,2), PKFK_TAX_TIP, PKFK_TAX_P_PORZ, PKFK_TAX_POR1, PKFK_TAX_POR2
              ORDER BY NKPR_LN_PRNPR;";
    sqlParams = {};
    sqlParams.Add({"@p1", invNum});
    taxRes = sqlQuery(sql_tax, sqlParams);

    // -----------------------------------------------------------
    // Create taxRes2 - Refactor compound tax codes into individual codes
    // -----------------------------------------------------------
    
    // First, get individual tax rates for compound tax codes
    sql_individual_taxes = "SELECT PKFK_TAX_CODE, PKFK_TAX_STOPA, PKFK_TAX_TARIFA, PKFK_TAX_P_PORZ,SUBSTRING(PKFK_TAX_DOBOPC,1,2) AS PKFK_TAX_DOBOPC " +
                          "FROM " + databaseName + ".dbo.PKFKPORZ " +
                          "WHERE PKFK_TAX_TIP = '' OR PKFK_TAX_TIP IS NULL;";
    individualTaxRes = sqlQuery(sql_individual_taxes, {});
    
    // Create a lookup for individual tax rates
    taxRateLookup = {};
    for (i = 1; i < Size(individualTaxRes); i++) {
        taxCode = individualTaxRes[i][0].trim();
        taxRate = individualTaxRes[i][1];
        taxCategory = individualTaxRes[i][2];
        taxType = individualTaxRes[i][3];
        taxExemptReason = individualTaxRes[i][4];
        taxRateLookup[taxCode] = {"rate": taxRate, "category": taxCategory, "type": taxType, "exemptReason": taxExemptReason};
    }
    
    // Create taxRes2 structure - same as taxRes but with compound taxes split
    taxRes2 = {};
    taxRes2.Add(taxRes[0]); // Copy header row
    
    for (i = 1; i < Size(taxRes); i++) {
        row = taxRes[i];
        
        POREZ = row[0];
        OSNOVICA = row[1]; 
        NKPR_LN_PRNPR = row[2].trim();
        PKFK_TAX_TARIFA = row[3].trim();
        PKFK_TAX_DOBOPC = row[4].trim();
        PKFK_TAX_TIP = row[5].trim();
        PKFK_TAX_P_PORZ = row[6].trim();
        PKFK_TAX_POR1 = row[7].trim();
        PKFK_TAX_POR2 = row[8].trim();
        
        if (PKFK_TAX_TIP == "S" && PKFK_TAX_POR1 != "" && PKFK_TAX_POR2 != "") {
            // This is a compound tax code (additive) - split into two individual codes
            
            // Get individual tax rates with error checking
            tax1Info = taxRateLookup[PKFK_TAX_POR1];
            tax2Info = taxRateLookup[PKFK_TAX_POR2];
            
            if (tax1Info == null) {
                MessageBox("Greška: Nije pronađen pojedinačni porez '" + PKFK_TAX_POR1 + "' za složeni porez!");
                return false;
            }
            if (tax2Info == null) {
                MessageBox("Greška: Nije pronađen pojedinačni porez '" + PKFK_TAX_POR2 + "' za složeni porez!");
                return false;
            }


            // Calculate individual tax amounts
            // For compound type 'S': total_rate = rate1 + rate2
            // So: tax1_amount = (rate1 / total_rate) * total_tax_amount
            //     tax2_amount = (rate2 / total_rate) * total_tax_amount
            
            rate1 = tax1Info["rate"];
            rate2 = tax2Info["rate"];
            totalCompoundRate = rate1 + rate2;
            
            if (totalCompoundRate > 0) {
                tax1Amount = (rate1 / totalCompoundRate) * POREZ;
                tax2Amount = (rate2 / totalCompoundRate) * POREZ;
            } else {
                tax1Amount = 0;
                tax2Amount = 0;
            }
            
            // Add first individual tax
            newRow1 = {};
            newRow1.Add(tax1Amount);                    // POREZ
            newRow1.Add(OSNOVICA);                      // OSNOVICA (same base amount)
            newRow1.Add(rate1);                         // NKPR_LN_PRNPR
            newRow1.Add(tax1Info["category"]);          // PKFK_TAX_TARIFA
            newRow1.Add(tax1Info["exemptReason"]);          // PKFK_TAX_DOBOPC);              // PKFK_TAX_DOBOPC
            newRow1.Add("");                            // PKFK_TAX_TIP (empty for individual)
            newRow1.Add(tax1Info["type"]);             // PKFK_TAX_P_PORZ
            newRow1.Add("");                            // PKFK_TAX_POR1 (empty for individual)
            newRow1.Add("");                            // PKFK_TAX_POR2 (empty for individual)
            taxRes2.Add(newRow1);
            
            // Add second individual tax
            newRow2 = {};
            newRow2.Add(tax2Amount);                    // POREZ
            newRow2.Add(OSNOVICA);                      // OSNOVICA (same base amount)
            newRow2.Add(rate2);                         // NKPR_LN_PRNPR
            newRow2.Add(tax2Info["category"]);          // PKFK_TAX_TARIFA
            newRow2.Add(tax2Info["exemptReason"]);          // PKFK_TAX_DOBOPC
            newRow2.Add("");                            // PKFK_TAX_TIP (empty for individual)
            newRow2.Add(tax2Info["type"]);             // PKFK_TAX_P_PORZ
            newRow2.Add("");                            // PKFK_TAX_POR1 (empty for individual)
            newRow2.Add("");                            // PKFK_TAX_POR2 (empty for individual)
            taxRes2.Add(newRow2);
            
        } elif (PKFK_TAX_TIP == "Z" && PKFK_TAX_POR1 != "" && PKFK_TAX_POR2 != "") {
            // This is a compound tax code (multiplicative) - Z type: rate1 * (1 + rate2)
            
            // Get individual tax rates with error checking
            tax1Info = taxRateLookup[PKFK_TAX_POR1];
            tax2Info = taxRateLookup[PKFK_TAX_POR2];
            
            if (tax1Info == null) {
                MessageBox("Greška: Nije pronađen pojedinačni porez '" + PKFK_TAX_POR1 + "' za složeni porez!");
                return false;
            }
            if (tax2Info == null) {
                MessageBox("Greška: Nije pronađen pojedinačni porez '" + PKFK_TAX_POR2 + "' za složeni porez!");
                return false;
            }

            rate1 = tax1Info["rate"];
            rate2 = tax2Info["rate"];
            
            // For type Z: effective_rate = rate1 * (1 + rate2/100)
            // Calculate base amounts for each tax proportionally
            baseForTax1 = OSNOVICA;
            tax1Amount = (baseForTax1 * rate1) / 100;
            
            baseForTax2 = OSNOVICA;
            tax2Amount = (baseForTax2 * rate2) / 100;
            
            // Add first individual tax
            newRow1 = {};
            newRow1.Add(tax1Amount);                    // POREZ
            newRow1.Add(baseForTax1);                   // OSNOVICA
            newRow1.Add(rate1);                         // NKPR_LN_PRNPR
            newRow1.Add(tax1Info["category"]);          // PKFK_TAX_TARIFA
            newRow1.Add(tax1Info["exemptReason"]);          // PKFK_TAX_DOBOPC
            newRow1.Add("");                            // PKFK_TAX_TIP (empty for individual)
            newRow1.Add(tax1Info["type"]);             // PKFK_TAX_P_PORZ
            newRow1.Add("");                            // PKFK_TAX_POR1 (empty for individual)
            newRow1.Add("");                            // PKFK_TAX_POR2 (empty for individual)
            taxRes2.Add(newRow1);
            
            // Add second individual tax
            newRow2 = {};
            newRow2.Add(tax2Amount);                    // POREZ
            newRow2.Add(baseForTax2);                   // OSNOVICA
            newRow2.Add(rate2);                         // NKPR_LN_PRNPR
            newRow2.Add(tax2Info["category"]);          // PKFK_TAX_TARIFA
            newRow2.Add(tax2Info["exemptReason"]);          // PKFK_TAX_DOBOPC
            newRow2.Add("");                            // PKFK_TAX_TIP (empty for individual)
            newRow2.Add(tax2Info["type"]);             // PKFK_TAX_P_PORZ
            newRow2.Add("");                            // PKFK_TAX_POR1 (empty for individual)
            newRow2.Add("");                            // PKFK_TAX_POR2 (empty for individual)
            taxRes2.Add(newRow2);
            
        } else {
            // This is already an individual tax code, copy as-is
            taxRes2.Add(row);
        }
    }

    // msg ("AAAA: " + taxRes2);
    totalPorez = 0;
    totalOsnovica = 0;
    TotaltaxOutOfScopeAmt = 0;

    for (i = 1; i < Size(taxRes2); i++) {
        row = taxRes2[i];
        //PKFK_TAX_P_PORZ = row[6].trim;
        PKFK_TAX_TARIFA = row[3].trim();
        if (PKFK_TAX_TARIFA == "POVNAK") // izvan PDV-a, stopa poreza je 0
        {
            TotaltaxOutOfScopeAmt += row[1]; //tu ide osnovica
            totalPorez += row[0];
            totalOsnovica += row[1];
        }
        elif (PKFK_TAX_TARIFA == "PP"){
            TotaltaxOutOfScopeAmt += row[0]; //tu treba uzet iznos poreza
        }
        else{
            totalPorez += row[0];
            totalOsnovica += row[1];
        }
    }

    // -----------------------------------------------------------
    // 4. Start XML Builder
    // -----------------------------------------------------------

    xml = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n";

    if (profileID == "P9") {
        xml += "<CreditNote xmlns=\"urn:oasis:names:specification:ubl:schema:xsd:CreditNote-2\"\n";
    } elif (NKPR_GL_OZNAKA == 'T') {
        xml += "<DebitNote xmlns=\"urn:oasis:names:specification:ubl:schema:xsd:DebitNote-2\"\n";
    } else {
        xml += "<Invoice xmlns=\"urn:oasis:names:specification:ubl:schema:xsd:Invoice-2\"\n";
    }
    
    xml += "    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n";
    xml += "    xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"\n";
    
    xml += "    xmlns:cac=\"urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2\"\n";
    xml += "    xmlns:cbc=\"urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2\"\n";
    xml += "    xmlns:ext=\"urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2\"\n";
    xml += "    xmlns:sac=\"urn:oasis:names:specification:ubl:schema:xsd:SignatureAggregateComponents-2\" \n";
    xml += "    xmlns:sig=\"urn:oasis:names:specification:ubl:schema:xsd:CommonSignatureComponents-2\" \n";
    xml += "    xmlns:hrextac=\"urn:mfin.gov.hr:schema:xsd:HRExtensionAggregateComponents-1\">\n";
    
    // xml += "    xsi:schemaLocation=\"urn:oasis:names:specification:ubl:schema:xsd:Invoice-2 ../xsd/ubl/maindoc/UBL-Invoice-2.1.xsd\">\n";
    //REVERSE CHarge ne treba ovo; ako je ReverseCherge onda to mora bit jedina stavka na računu
            taxOutOfScopeAmt = 0;
            InvoiceLevelCharge= 0;
            AllowChgMultiplierFactor = 0;
            AllowChgAmount = 0;
            AllowChgBaseAmount = 0;
            AllowChgExemptReason = "";
    if (NKPR_GL_RNALOG != "P") {
        // BT-1..126 Extension point; 0..n // ???
        xml += "<ext:UBLExtensions>\n";
        xml += "  <ext:UBLExtension>\n";
        xml += "    <ext:ExtensionContent>\n";
        //OVO treba urediti prema HR zahtjevima, za sada je samo primjer
        //potrebno je poreze potražit iz linija i sa for petljom popunit linije ispod
        xml += "        <hrextac:HRFISK20Data>\n";
        if (NKSC_TAX_DN == "N") {
            xml += "        <hrextac:HRObracunPDVPoNaplati>Obračun prema naplaćenoj naknadi</hrextac:HRObracunPDVPoNaplati>\n";
        }
        xml += "            <hrextac:HRTaxTotal>\n";
        xml += "                <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(totalPorez, 2, ".", formatNumOption) + "</cbc:TaxAmount>\n";
        for (i = 1; i < Size(taxRes2); i++) {
            row = taxRes2[i];

            POREZ = row[0];
            OSNOVICA = row[1];
            NKPR_LN_PRNPR = row[2];
            PKFK_TAX_TARIFA = row[3].trim();
            PKFK_TAX_DOBOPC = Substring(row[4], 0, 2).trim(); //šifra izjave za oslobođenje od poreza
            PKFK_TAX_P_PORZ = row[6]; // Get tax type (P=PDV, T=Consumption tax, etc.)
            exemptReason = "";
            //if (pkfk_tax_dobopc != "" && nkpr_ln_prnpr == 0) {
            if (pkfk_tax_dobopc != "") {
                //ovaj porez ima stopu 0 i ima izjavu koju treba unijet u polje u e-računu
                //to su zapravo svi porezi koji su oslobođeni PDV-a, kategorije E,K,O,
                sql_tax_exempt= "SELECT trim(KPSY_IZ_TEXT01)+' '+trim(KPSY_IZ_TEXT02)+' '+trim(KPSY_IZ_TEXT03)+' '+trim(KPSY_IZ_TEXT04)+' '+trim(KPSY_IZ_TEXT05)" +
                        " FROM " + databaseName + ".dbo.KPSYIZKU " +
                        " WHERE @p1 = KPSY_IZ_CODE;";
                sqlParams = {};
                sqlParams.Add({"@p1", PKFK_TAX_DOBOPC});
                exemptQuery = sqlQuery(sql_tax_exempt, sqlParams);
                if (Size(exemptQuery) > 1) {
                    exemptReason = exemptQuery[1][0].trim();
                }
            }
            xml += "                <hrextac:HRTaxSubtotal>\n"; //HR-BG-2
            taxName = "";

            //if (PKFK_TAX_P_PORZ == "T") { 
            if (PKFK_TAX_TARIFA == "PP") {
            
                //porez na potrošnju
                taxName = "HR:PP"; // + FormatNum(NKPR_LN_PRNPR, 0, ".", formatNumOption);
                taxSchemeID = "LOC";
                taxOutOfScopeAmt += POREZ;
                InvoiceLevelCharge += POREZ;
                xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(taxOutOfScopeAmt, 2, ".", formatNumOption) + "</cbc:TaxableAmount>\n"; //HR-BT-16
                xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + "0.00" + "</cbc:TaxAmount>\n"; //HR-BT-17
                xml += "                    <hrextac:HRTaxCategory>\n";
                xml += "                        <cbc:ID>" + "O" + "</cbc:ID>\n"; //HR-BT-18 1..1
                xml += "                        <cbc:Name>" + taxName + "</cbc:Name>\n"; //HR-BT-22
                xml += "                        <cbc:Percent>" + "0.00" + "</cbc:Percent>\n"; //HR-BT-19
                if (exemptReason != ""){
                    xml += "                        <cbc:TaxExemptionReason>#HR:PP#" + EscapeForXml(exemptReason) + "</cbc:TaxExemptionReason>\n"; //HR-BT-20
                }   
                xml += "                        <hrextac:HRTaxScheme>\n";
                xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
                xml += "                        </hrextac:HRTaxScheme>\n";
                xml += "                    </hrextac:HRTaxCategory>\n";
                //ovo ispod nam treba kod troškova na nivou dokumenta, koji u našem slučaju imamo samo kada je porez na potrošnju
                AllowChgMultiplierFactor = NKPR_LN_PRNPR;
                AllowChgAmount = taxOutOfScopeAmt;
                AllowChgBaseAmount = osnovica;
                AllowChgExemptReason = exemptReason;
            
            } elif (PKFK_TAX_TARIFA == "O"){ 
                //ostali porezi
                taxName = "HR:OTH"; //tu nema poreza
                taxSchemeID = "VAT";
                xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(OSNOVICA, 2, ".", formatNumOption) + "</cbc:TaxableAmount>\n";
                xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + "0.00" + "</cbc:TaxAmount>\n";
                //xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(POREZ, 2, ".", formatNumOption) + "</cbc:TaxAmount>\n";
                xml += "                    <hrextac:HRTaxCategory>\n";
                xml += "                        <cbc:ID>" + PKFK_TAX_TARIFA + "</cbc:ID>\n";
                xml += "                        <cbc:Name>" + taxName + "</cbc:Name>\n";
                xml += "                        <cbc:Percent>" + "0.00" + "</cbc:Percent>\n";
                if (exemptReason != ""){
                    xml += "                        <cbc:TaxExemptionReason>" + EscapeForXml(exemptReason) + "</cbc:TaxExemptionReason>\n";
                }   
                xml += "                        <hrextac:HRTaxScheme>\n";
                xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
                xml += "                        </hrextac:HRTaxScheme>\n";
                xml += "                    </hrextac:HRTaxCategory>\n";
            }
            elif (PKFK_TAX_TARIFA == "POVNAK"){ 
                //Povratna naknada
                taxName = "HR:POVNAK"; //nema poreza
                taxSchemeID = "OTH";
                xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(OSNOVICA, 2, ".", formatNumOption) + "</cbc:TaxableAmount>\n";
                xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + "0.00" + "</cbc:TaxAmount>\n";
                //xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(POREZ, 2, ".", formatNumOption) + "</cbc:TaxAmount>\n";
                xml += "                    <hrextac:HRTaxCategory>\n";
                xml += "                        <cbc:ID>" + "O" + "</cbc:ID>\n";
                xml += "                        <cbc:Name>" + taxName + "</cbc:Name>\n";
                xml += "                        <cbc:Percent>" + "0.00" + "</cbc:Percent>\n";
                if (exemptReason != ""){
                    xml += "                        <cbc:TaxExemptionReason>" + EscapeForXml(exemptReason) + "</cbc:TaxExemptionReason>\n";
                }   
                xml += "                        <hrextac:HRTaxScheme>\n";
                xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
                xml += "                        </hrextac:HRTaxScheme>\n";
                xml += "                    </hrextac:HRTaxCategory>\n";
            }
            elif (SUBSTRING(PKFK_TAX_TARIFA,0,3) == 'PDV'){
                taxName = "HR:" + PKFK_TAX_TARIFA; //+ FormatNum(NKPR_LN_PRNPR, 0, ".", formatNumOption);
                taxSchemeID = "VAT";
                xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(OSNOVICA, 2, ".", formatNumOption) + "</cbc:TaxableAmount>\n";
                xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(POREZ, 2, ".", formatNumOption) + "</cbc:TaxAmount>\n";
                xml += "                    <hrextac:HRTaxCategory>\n";
                xml += "                        <cbc:ID>S</cbc:ID>\n";
                xml += "                        <cbc:Name>" + taxName + "</cbc:Name>\n";
                xml += "                        <cbc:Percent>" + FormatNum(NKPR_LN_PRNPR, 0, ".", formatNumOption) + "</cbc:Percent>\n";
                xml += "                        <hrextac:HRTaxScheme>\n";
                xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
                xml += "                        </hrextac:HRTaxScheme>\n";
                xml += "                    </hrextac:HRTaxCategory>\n";
            }
            elif (PKFK_TAX_TARIFA == 'E'){  
                taxName = "HR:E"; // poreza nema + FormatNum(NKPR_LN_PRNPR, 0, ".", formatNumOption);
                taxSchemeID = "VAT";
                xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(OSNOVICA, 2, ".", formatNumOption) + "</cbc:TaxableAmount>\n";
                if(porez != 0){
                    //ne bi trebalo imati poreza tu! kontrola kod unosa!
                    xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(POREZ, 2, ".", formatNumOption) + "</cbc:TaxAmount>\n";
                }
                xml += "                    <hrextac:HRTaxCategory>\n";
                xml += "                        <cbc:ID>" + PKFK_TAX_TARIFA + "</cbc:ID>\n";
                xml += "                        <cbc:Name>" + taxName + "</cbc:Name>\n";
                xml += "                        <cbc:Percent>" + FormatNum(NKPR_LN_PRNPR, 0, ".", formatNumOption) + "</cbc:Percent>\n";
                if (exemptReason != ""){
                    xml += "                        <cbc:TaxExemptionReason>" + EscapeForXml(exemptReason) + "</cbc:TaxExemptionReason>\n";
                }   
                xml += "                        <hrextac:HRTaxScheme>\n";
                xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
                xml += "                        </hrextac:HRTaxScheme>\n";
                xml += "                    </hrextac:HRTaxCategory>\n";
            } elif (PKFK_TAX_TARIFA == 'K'){   
                taxName = "HR:K"; // poreza nema+ FormatNum(NKPR_LN_PRNPR, 0, ".", formatNumOption);
                taxSchemeID = "VAT";
                xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(OSNOVICA, 2, ".", formatNumOption) + "</cbc:TaxableAmount>\n";
                xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(POREZ, 2, ".", formatNumOption) + "</cbc:TaxAmount>\n";
                xml += "                    <hrextac:HRTaxCategory>\n";
                xml += "                        <cbc:ID>" + PKFK_TAX_TARIFA + "</cbc:ID>\n";
                xml += "                        <cbc:Name>" + taxName + "</cbc:Name>\n";
                xml += "                        <cbc:Percent>" + FormatNum(NKPR_LN_PRNPR, 0, ".", formatNumOption) + "</cbc:Percent>\n";
                if (exemptReason != ""){
                    xml += "                        <cbc:TaxExemptionReason>" + EscapeForXml(exemptReason) + "</cbc:TaxExemptionReason>\n";
                }   
                xml += "                        <hrextac:HRTaxScheme>\n";
                xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
                xml += "                        </hrextac:HRTaxScheme>\n";
                xml += "                    </hrextac:HRTaxCategory>\n";
            } elif (PKFK_TAX_TARIFA == 'O'){   
                taxName = "HR:"+PKFK_TAX_TARIFA; //porez= 0
                taxSchemeID = "VAT";
                xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(OSNOVICA, 2, ".", formatNumOption) + "</cbc:TaxableAmount>\n";
                xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(POREZ, 2, ".", formatNumOption) + "</cbc:TaxAmount>\n";
                xml += "                    <hrextac:HRTaxCategory>\n";
                xml += "                        <cbc:ID>" + PKFK_TAX_TARIFA + "</cbc:ID>\n";
                xml += "                        <cbc:Name>" + taxName + "</cbc:Name>\n";
                xml += "                        <cbc:Percent>" + FormatNum(NKPR_LN_PRNPR, 0, ".", formatNumOption) + "</cbc:Percent>\n";
                if (exemptReason != ""){
                    xml += "                        <cbc:TaxExemptionReason>" + EscapeForXml(exemptReason) + "</cbc:TaxExemptionReason>\n";
                }   
                xml += "                        <hrextac:HRTaxScheme>\n";
                xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
                xml += "                        </hrextac:HRTaxScheme>\n";
                xml += "                    </hrextac:HRTaxCategory>\n";
                }
            else{   
                taxName = "HR:"+PKFK_TAX_TARIFA;
                taxSchemeID = "VAT";
                xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(OSNOVICA, 2, ".", formatNumOption) + "</cbc:TaxableAmount>\n";
                xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(POREZ, 2, ".", formatNumOption) + "</cbc:TaxAmount>\n";
                xml += "                    <hrextac:HRTaxCategory>\n";
                xml += "                        <cbc:ID>" + PKFK_TAX_TARIFA + "</cbc:ID>\n";
                xml += "                        <cbc:Name>" + taxName + "</cbc:Name>\n"; //HR-BT-22
                xml += "                        <cbc:Percent>" + FormatNum(NKPR_LN_PRNPR, 0, ".", formatNumOption) + "</cbc:Percent>\n";
                if (exemptReason != ""){
                    xml += "                        <cbc:TaxExemptionReason>" + EscapeForXml(exemptReason) + "</cbc:TaxExemptionReason>\n"; //HR-BT-20
                }   
                xml += "                        <hrextac:HRTaxScheme>\n";
                xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n"; 
                xml += "                        </hrextac:HRTaxScheme>\n";
                xml += "                    </hrextac:HRTaxCategory>\n";
                }
            xml += "                </hrextac:HRTaxSubtotal>\n";
        }

        xml += "            </hrextac:HRTaxTotal>\n";
        xml += "            <hrextac:HRLegalMonetaryTotal>\n";
        xml += "              <cbc:TaxExclusiveAmount currencyID=\"EUR\">" + FormatNum(TotalOSNOVICA, 2, ".", formatNumOption) + "</cbc:TaxExclusiveAmount>\n"; //HR-BT-23
        xml += "              <hrextac:OutOfScopeOfVATAmount currencyID=\"EUR\">" + FormatNum(TotaltaxOutOfScopeAmt, 2, ".", formatNumOption) + "</hrextac:OutOfScopeOfVATAmount>\n"; //HR-BT-24 1..1
        //xml += "              <hrextac:OutOfScopeOfVATAmount currencyID=\"EUR\">" + "0.00" + "</hrextac:OutOfScopeOfVATAmount>\n"; //HR-BT-24 1..1
        xml += "            </hrextac:HRLegalMonetaryTotal>\n";
        xml += "        </hrextac:HRFISK20Data>\n";

        // xml += "      <sig:UBLDocumentSignatures>\n";
        // xml += "        <sac:SignatureInformation></sac:SignatureInformation>\n";
        // xml += "      </sig:UBLDocumentSignatures>\n";

        xml += "    </ext:ExtensionContent>\n";
        xml += "  </ext:UBLExtension>\n";
        xml += "</ext:UBLExtensions>\n";
    }
    xml += "<cbc:CustomizationID>urn:cen.eu:en16931:2017#compliant#urn:mfin.gov.hr:cius-2025:1.0#conformant#urn:mfin.gov.hr:ext-2025:1.0</cbc:CustomizationID>\n"; // BT-24; 1..1
    xml += "<cbc:ProfileID>" + profileID + "</cbc:ProfileID>\n"; // BT-23; 1..1
    // BT-1; Invoice number; 1..1
    // Invoice Number (8 digits: 90100002 -->> 00002-90-1)
    invNumStr = String(NKPR_GL_NUM); // 
    invID = Substring(invNumStr, 3, 5) + "-" + Substring(invNumStr, 0, 2) + "-" + Substring(invNumStr, 2, 1);
    xml += "<cbc:ID>" + invID + "</cbc:ID>\n";
    if (CopyIndicator == "D") {
        xml += "<cbc:CopyIndicator>true</cbc:CopyIndicator>\n"; // HR-BT-1; 0..1
    } else {
        xml += "<cbc:CopyIndicator>false</cbc:CopyIndicator>\n"; // HR-BT-1; 0..1
    }
    xml += "<cbc:IssueDate>" + NKPR_GL_INVDTE + "</cbc:IssueDate>\n"; // BT-2; 1..1
    xml += "<cbc:IssueTime>" + NKPR_GL_TIMECR + "</cbc:IssueTime>\n"; // HR-BT-2; 1..1

    note = "";
    if (NKPR_GL_BROPIS != "") {
        note = "\n";
        sql_note = "SELECT kppr_op_text FROM " + databaseName + ".dbo.KPPROPIS WHERE KPPR_OP_BROJ = @p1 ORDER BY KPPR_OP_BROJ, kppr_op_lin;";
        sqlParams = {};
        sqlParams.Add({"@p1", NKPR_GL_BROPIS});
        noteRes = sqlQuery(sql_note, sqlParams);
        if (Size(noteRes) >= 2) {
            for (j = 1; j < Size(noteRes); j++) {   
                note += noteRes[j][0];
            }
        }    
    }
    if (nkpr_gl_bropis1 != "") {
        note += "\n";
        sql_note = "SELECT kppr_op_text FROM " + databaseName + ".dbo.KPPROPIS WHERE KPPR_OP_BROJ = @p1 ORDER BY KPPR_OP_BROJ, kppr_op_lin;";
        sqlParams = {};
        sqlParams.Add({"@p1", NKPR_GL_bropis1});
        noteRes = sqlQuery(sql_note, sqlParams);
        if (Size(noteRes) >= 2) {
            for (j = 1; j < Size(noteRes); j++) {   
                note += noteRes[j][0];
            }
        }
    }

    if (profileID == "P9") { // credit note
        if (NKPR_GL_ESD != NKPR_GL_INVDTE){
            //ako je datum oporezivanja različit od datuma računa, treba ga unijeti; PROVJERI MATEMATIKU SA DATUMIMA!!!!
            xml += "<cbc:TaxPointDate>" + NKPR_GL_ESD + "</cbc:TaxPointDate>\n"; //BT-7; 0..1
        }
        xml += "<cbc:CreditNoteTypeCode>381</cbc:CreditNoteTypeCode>\n"; // BT-3; 1..1
        if (note.length > 2) {
            xml += "<cbc:Note>" + EscapeForXml(note) + "</cbc:Note>\n"; // BT-21, 0..1 (note code) and BT-22; 1..1 note text
        }
    } else {// invoice
        //samo za invoice, za Credit note ima u paymentmeans, ako treba
        // dueDate = NKPR_GL_DUE_DATE;
        if (NKPR_GL_DUE_DATE != '1900-01-01') {
            xml += "<cbc:DueDate>" + NKPR_GL_DUE_DATE + "</cbc:DueDate>\n"; //BT-9; 0..1
        }
        xml += "<cbc:InvoiceTypeCode>" + typeCode + "</cbc:InvoiceTypeCode>\n"; //BT-3; 1..1
        // xml += "<cbc:InvoiceType>" + invType + "</cbc:InvoiceType>\n";
        if (note.length > 2) {
            xml += "<cbc:Note>" + EscapeForXml(note) + "</cbc:Note>\n"; // BT-21, 0..1 (note code) and BT-22; 1..1 note text
        }

        if (NKPR_GL_ESD != NKPR_GL_INVDTE){
            //ako je datum oporezivanja različit od datuma računa, treba ga unijeti; PROVJERI MATEMATIKU SA DATUMIMA!!!!
            xml += "<cbc:TaxPointDate>" + NKPR_GL_ESD + "</cbc:TaxPointDate>\n"; //BT-7; 0..1
        }
    }

    xml += "<cbc:DocumentCurrencyCode>EUR</cbc:DocumentCurrencyCode>\n"; // BT-5; 1..1 
    xml += "<cbc:TaxCurrencyCode>EUR</cbc:TaxCurrencyCode>\n";

    if (NKPR_GL_UGOVOR != 0 && PKKU_PP_OPIS != "") {  
        xml += "<cac:ContractDocumentReference>";
            xml +=      "<cbc:ID>"+PKKU_PP_OPIS+"; INT.REF:"+NKPR_GL_UGOVOR+"</cbc:ID>"; //BT-12; 0..1
        xml += "</cac:ContractDocumentReference>";
    }
    if (NKPR_GL_CUSORD != "") {  
        xml += "<cac:OrderDocumentReference>";
            xml +=      "<cbc:ID>"+NKPR_GL_CUSORD+"</cbc:ID>"; //BT-14; 0..1
        xml += "</cac:OrderDocumentReference>";
    }

    // BillingReference for all document types (except standard invoices with NKPR_GL_OZNAKA = 'S')
    // Required when referencing another document (Credit Note, Corrective Invoice, Debit Note, etc.)
    if (ProfileID == 'P9' || ProfileID == 'P10' || ProfileID=='P11' || ProfileID == 'P2') {

        // Parse multiple invoice references from Note field using #REF() format
        referencedInvoices = {};
        
        // First, add primary reference from NKPR_GL_REZ3 if exists
        if (NKPR_GL_REZ3 != "" && NKPR_GL_REZ3 != "0") {
            referencedInvoices.Add(NKPR_GL_REZ3);
        }
        
        // Parse additional references from Note field using #REF() format
        if (note != "") {
            // Look for #REF( pattern
            refStartPos = strIndexOf(note, "#REF(");
            if (refStartPos >= 0) {
                // Find the closing parenthesis
                refEndPos = strIndexOf(note, ")", refStartPos);
                if (refEndPos >= 0) {
                    // Extract the content between #REF( and )
                    refContent = Substring(note, refStartPos + 5, refEndPos - refStartPos - 5);
                    
                    // Split by comma and process each reference
                    refNumbers = Split(refContent, ",");
                    for (refIdx = 0; refIdx < Size(refNumbers); refIdx++) {
                        refNum = refNumbers[refIdx].trim();
                        if (refNum != "" && refNum != "0") {
                            // Add to references list if not already present
                            found = false;
                            for (existIdx = 0; existIdx < Size(referencedInvoices); existIdx++) {
                                if (referencedInvoices[existIdx] == refNum) {
                                    found = true;
                                    break;
                                }
                            }
                            if (!found) {
                                referencedInvoices.Add(refNum);
                            }
                        }
                    }
                }
            }
        }
        
        // Generate BillingReference elements for each referenced invoice
        for (refIdx = 0; refIdx < Size(referencedInvoices); refIdx++) {
            refStr = String(referencedInvoices[refIdx]);
            refID = Substring(refStr, 3, 5) + "-" + Substring(refStr, 0, 2) + "-" + Substring(refStr, 2, 1);
            datumRefRacuna = "";
            //first see if thereis a referenced document/invoice specified in nkpr_gl_rez3
            //get date of referenced invoice
            sql_ref_inv_date = "SELECT CONVERT(VARCHAR(10), NKPR_GL_INVDTE, 23) as NKPR_GL_INVDTE FROM " + databaseName + ".dbo.NKPRINV WHERE NKPR_GL_NUM = @p1;";
            sqlParams = {};
            sqlParams.Add({"@p1", refStr}); //NKPR_GL_REZ3
            refInvDateRes = sqlQuery(sql_ref_inv_date, sqlParams);
            if (Size(refInvDateRes) < 2) {
                MessageBox("Ne postoji referentni račun " + refStr + " za račun " + invNum + "!");
                return false;
            }
            datumRefRacuna = refInvDateRes[1][0].trim();
    // messageBox("NKPR_GL_OZNAKA: " + NKPR_GL_OZNAKA+".... datumRefRacuna: " + datumRefRacuna);   


            xml += "<cac:BillingReference>\n";
            xml += "  <cac:InvoiceDocumentReference>\n"; // BG-3; 0..n
            xml += "    <cbc:ID>" + refID + "</cbc:ID>\n"; // BT-25; 1..1
            xml += "    <cbc:IssueDate>" + datumRefRacuna + "</cbc:IssueDate>\n"; // BT-26; 1..1
            xml += "  </cac:InvoiceDocumentReference>\n";
            xml += "</cac:BillingReference>\n";
        }
    }

    if (NKPR_GL_BROTP != 0 ) {  
        xml += "<cac:DespatchDocumentReference>";
            xml +=      "<cbc:ID>"+NKPR_GL_BROTP+"</cbc:ID>"; //BT-16; 0..1
        xml += "</cac:DespatchDocumentReference>";
    }

    


    // if (profileID != "P4") {
    //     ptDesc = "Rok plaćanja je " + NKPR_GL_NOKAM + " dana";
    //     if (NKPR_GL_ROKPL != 0) {
    //         ptDesc += " nakon roka za provjeru od " + NKPR_GL_ROKPL + " dana";
    //     }
    //     ptDesc += ". Rok plaćanja teče od: " + NKPR_GL_DVO;
    //     // xml += "<cbc:PaymentTermsDescription>" + ptDesc + "</cbc:PaymentTermsDescription>\n";

    //     // xml += "<cac:PaymentTerms>\n";
    //     // xml += "  <cbc:Note>Rok plaćanja teče od datuma " + NKPR_GL_DVO + "</cbc:Note>\n";
    //     // xml += "  <cbc:SettlementPeriodMeasure unitCode=\"DAY\">" + NKPR_GL_NOKAM + NKPR_GL_ROKPL + "</cbc:SettlementPeriodMeasure>\n";
    //     // xml += "</cac:PaymentTerms>\n";
    // }
    


    // -----------------------------------------------------------
    // main Račun pdf Attachment
    // -----------------------------------------------------------
    if (ERAC_REZ1 == 'D') { // !!!
        opis = "pdf dokumenta";
        if (Exists(attachmentPdfPath)) {
            mime = GetMimeType(attachmentPdfPath);
            b64 = File2Base64(attachmentPdfPath);
            xml += "<cac:AdditionalDocumentReference>\n";
            xml += "  <cbc:ID>" + "X7" + "</cbc:ID>\n"; 
            // xml += "  <cbc:DocumentTypeCode>130</cbc:DocumentTypeCode>\n"; //130 must be used for INVOICE type document
            xml += "  <cbc:DocumentDescription>" + EscapeForXml(opis) + "</cbc:DocumentDescription>\n";
            xml += "  <cac:Attachment>\n";
            xml += "    <cbc:EmbeddedDocumentBinaryObject mimeCode=\"" + mime + "\" filename=\"" + ParseFile(attachmentPdfPath, "pfName") + ParseFile(attachmentPdfPath, "pfExt") + "\">" + b64 + "</cbc:EmbeddedDocumentBinaryObject>\n";
            xml += "  </cac:Attachment>\n";
            // xml += "  <hrextac:DocumentValidationRef>" + NKPR_GL_PICTHDR + "</hrextac:DocumentValidationRef>\n";
            xml += "</cac:AdditionalDocumentReference>\n";
        }
    }
    
    // -----------------------------------------------------------
    // Header Attachments
    // -----------------------------------------------------------
    if (NKPR_GL_PICTHDR != 0) {
        sql_pic = "SELECT SY_SL_PATH, SY_SL_OPIS FROM " + databaseName + ".dbo.NKSYPICT WHERE SY_SL_NUM = @p1;";
        sqlParams = {};
        sqlParams.Add({"@p1", NKPR_GL_PICTHDR});
        picRes = sqlQuery(sql_pic, sqlParams);
        SY_SL_PATH = picRes[1][0].trim();
        SY_SL_OPIS = picRes[1][1].trim();
        if (Size(picRes) >= 2 && Exists(SY_SL_PATH)) {
            mime = GetMimeType(SY_SL_PATH);
            b64 = File2Base64(SY_SL_PATH);
            xml += "<cac:AdditionalDocumentReference>\n";
            xml += "  <cbc:ID>" + NKPR_GL_PICTHDR + "</cbc:ID>\n"; 
            // xml += "  <cbc:DocumentTypeCode>130</cbc:DocumentTypeCode>\n"; //130 must be used for INVOICE type document
            xml += "  <cbc:DocumentDescription>" + EscapeForXml(SY_SL_OPIS) + "</cbc:DocumentDescription>\n";
            xml += "  <cac:Attachment>\n";
            xml += "    <cbc:EmbeddedDocumentBinaryObject mimeCode=\"" + mime + "\" filename=\"" + ParseFile(SY_SL_PATH, "pfName") + ParseFile(SY_SL_PATH, "pfExt") + "\">" + b64 + "</cbc:EmbeddedDocumentBinaryObject>\n";
            xml += "  </cac:Attachment>\n";
            // xml += "  <hrextac:DocumentValidationRef>" + NKPR_GL_PICTHDR + "</hrextac:DocumentValidationRef>\n";
            xml += "</cac:AdditionalDocumentReference>\n";
        }
    }

    // -----------------------------------------------------------
    // Footer Attachments
    // -----------------------------------------------------------
    if (NKPR_GL_PICTFTR != 0) {
        sql_pic = "SELECT SY_SL_PATH, SY_SL_OPIS FROM " + databaseName + ".dbo.NKSYPICT WHERE SY_SL_NUM = @p1;";
        sqlParams = {};
        sqlParams.Add({"@p1", NKPR_GL_PICTFTR});
        picRes = sqlQuery(sql_pic, sqlParams);
        SY_SL_PATH = picRes[1][0].trim();
        SY_SL_OPIS = picRes[1][1].trim();
        if (Size(picRes) >= 2 && Exists(SY_SL_PATH)) {
            mime = GetMimeType(SY_SL_PATH);
            b64 = File2Base64(SY_SL_PATH);
            xml += "<cac:AdditionalDocumentReference>\n";
            xml += "  <cbc:ID>" + NKPR_GL_PICTFTR + "</cbc:ID>\n";
            // xml += "  <cbc:DocumentTypeCode>130</cbc:DocumentTypeCode>\n";
            xml += "  <cbc:DocumentDescription>" + EscapeForXml(SY_SL_OPIS) + "</cbc:DocumentDescription>\n";
            xml += "  <cac:Attachment>\n";
            xml += "    <cbc:EmbeddedDocumentBinaryObject mimeCode=\"" + mime + "\" filename=\"" + ParseFile(SY_SL_PATH, "pfName") + ParseFile(SY_SL_PATH, "pfExt") + "\">" + b64 + "</cbc:EmbeddedDocumentBinaryObject>\n";
            xml += "  </cac:Attachment>\n";
            // xml += "  <hrextac:DocumentValidationRef>" + NKPR_GL_PICTFTR + "</hrextac:DocumentValidationRef>\n";
            xml += "</cac:AdditionalDocumentReference>\n";
        }
    }


    for (j = 1; j < Size(linRes); j++) {

        fillInvoiceLine(j);

        if (NKPR_LN_SASTAV != 0) {
            sql_pic = "SELECT SY_SL_PATH, SY_SL_OPIS FROM " + databaseName + ".dbo.NKSYPICT WHERE SY_SL_NUM = @p1;";
            sqlParams = {};
            sqlParams.Add({"@p1", NKPR_LN_SASTAV});
            picRes = sqlQuery(sql_pic, sqlParams);
            SY_SL_PATH = picRes[1][0].trim();
            SY_SL_OPIS = picRes[1][1].trim();
            if (Size(picRes) >= 2 && Exists(SY_SL_PATH)) {
                mime = GetMimeType(SY_SL_PATH);
                b64 = File2Base64(SY_SL_PATH);
                xml += "<cac:AdditionalDocumentReference>\n";
                xml += "  <cbc:ID>" + NKPR_LN_SASTAV + "</cbc:ID>\n";
                // xml += "  <cbc:DocumentTypeCode>130</cbc:DocumentTypeCode>\n";
                xml += "  <cbc:DocumentDescription>" + "Linija " + NKPR_LN_BR_LN + ".: " + EscapeForXml(SY_SL_OPIS) + "</cbc:DocumentDescription>\n";
                xml += "  <cac:Attachment>\n";
                xml += "    <cbc:EmbeddedDocumentBinaryObject mimeCode=\"" + mime + "\" filename=\"" + ParseFile(SY_SL_PATH, "pfName") + ParseFile(SY_SL_PATH, "pfExt") + "\">" + b64 + "</cbc:EmbeddedDocumentBinaryObject>\n";
                xml += "  </cac:Attachment>\n";
                // xml += "  <hrextac:DocumentValidationRef>" + NKPR_LN_SASTAV + "</hrextac:DocumentValidationRef>\n";
                xml += "</cac:AdditionalDocumentReference>\n";
            }
        }
    }

    // -----------------------------------------------------------
    // Supplier
    // -----------------------------------------------------------
    supName = KPSY_COMP_NAME;
    supAddr = KPSY_COMP_ADD1 + (KPSY_GL_RETEARN != "" ? " " + KPSY_GL_RETEARN : "");
    supCity = KPSY_COMP_CSZ;
    supZip = KPSY_COMP_ZIP;

    KPSYSTEMQuery = "SELECT TOP 1 SY_SY_SIF_DRZAV FROM " + databaseName + ".dbo.KPSYSTEM;";
    KPSYSTEMResult = sqlQuery(KPSYSTEMQuery);
    if (Size(KPSYSTEMResult) > 1) {
        SY_SY_SIF_DRZAV = KPSYSTEMResult[1][0].trim();
    }else{
        SY_SY_SIF_DRZAV = "HR";
    }
    supCountry = SY_SY_SIF_DRZAV;

    IniPath = strtrim(wpath()) + SY_CC_USER + ".ini";
    if(!regedit("regOpen", IniPath, "rtFile")){
        MessageBox("Datoteka " + IniPath + " nije dostupna.");
        return false;
    }
    NazivFirme = regedit("regReadStr", 'COMPANY', 'NazivFirme');
    // SavePath = regedit("regReadStr", 'EMAIL', 'EmailFilePath');
    regedit("regClose");

    xml += "<cac:AccountingSupplierParty>\n";
    xml += "  <cac:Party>\n";
    
    // Use GLN (0088 scheme) if available and valid (13 characters), otherwise use OIB (9934 scheme)
    supSchemeID = "9934";
    supEndpointID = supOIB;
    supPartyID = "9934:" + supOIB;
    supPartyTaxScheme = "VAT";
    if (KPSY_PR_R1_R2 == "XX" || KPSY_PR_R1_R2 == "") {
        supPartyTaxScheme = "FRE";
    }
    // if (KPSY_REZERVAX != "" && KPSY_REZERVAX.length == 13) {
    //     supSchemeID = "0088";
    //     supEndpointID = KPSY_REZERVAX;
    //     supPartyID = "0088:" + KPSY_REZERVAX;
    // }
    
    xml += "    <cbc:EndpointID schemeID=\"" + supSchemeID + "\">" + supEndpointID + "</cbc:EndpointID>\n"; // !!! // ???
    xml += "    <cac:PartyIdentification><cbc:ID>" + supPartyID + "</cbc:ID></cac:PartyIdentification>\n";
    xml += "    <cac:PartyName><cbc:Name>" + EscapeForXml(supName) + "</cbc:Name></cac:PartyName>\n";
    
    xml += "    <cac:PostalAddress>\n";
    xml += "      <cbc:StreetName>" + EscapeForXml(supAddr) + "</cbc:StreetName>\n";
    xml += "      <cbc:CityName>" + EscapeForXml(supCity) + "</cbc:CityName>\n";
    xml += "      <cbc:PostalZone>" + EscapeForXml(supZip) + "</cbc:PostalZone>\n";
    xml += "      <cac:Country><cbc:IdentificationCode>" + EscapeForXml(supCountry) + "</cbc:IdentificationCode></cac:Country>\n";
    xml += "    </cac:PostalAddress>\n";
    
    xml += "    <cac:PartyTaxScheme><cbc:CompanyID>" + KPSY_PO_FREIGHT + supOIB + "</cbc:CompanyID>\n"; //BT-31
    xml += "      <cac:TaxScheme>\n";
    xml += "        <cbc:ID>" + supPartyTaxScheme + "</cbc:ID>\n";
    xml += "      </cac:TaxScheme>\n";
    xml += "    </cac:PartyTaxScheme>\n"; 

    RegistrationName = (NazivFirme != "" ? NazivFirme : KPSY_COMP_NAME);
    RegistrationName = RegistrationName.trim();


    xml += "    <cac:PartyLegalEntity>\n";
    xml += "      <cbc:RegistrationName>" + EscapeForXml(RegistrationName) + "</cbc:RegistrationName>\n";
    if (KPSY_COMP_JMBFI != "") {
        // xml += "      <cbc:CompanyID schemeID=\"MBS\">" + KPSY_COMP_JMBFI + "</cbc:CompanyID>\n";
        xml += "      <cbc:CompanyID>" + KPSY_COMP_JMBFI + "</cbc:CompanyID>\n";
    }
    xml += "    </cac:PartyLegalEntity>\n";


    // ??? - ovo ne?
    if (KPSY_COMP_PHONE != "" || KPSY_COMP_EMAIL != "") {
        xml += "    <cac:Contact>\n";
        if (KPSY_COMP_PHONE != "") { xml += "      <cbc:Telephone>" + KPSY_COMP_PHONE + "</cbc:Telephone>\n"; }
        if (KPSY_COMP_EMAIL != "") { xml += "      <cbc:ElectronicMail>" + EscapeForXml(KPSY_COMP_EMAIL) + "</cbc:ElectronicMail>\n"; }
        xml += "    </cac:Contact>\n";
    }

    xml += "  </cac:Party>\n";


    
    xml += "  <cac:SellerContact>\n"; //možda     bi tu trebalo zapravo OIB i naziv prodavača a ne operatera???? ali u dokumentaciji piše operatera!
    xml += "    <cbc:ID>" + UserOib + "</cbc:ID>\n"; //HR-BT-5; 1..1 ; OIB operatera
    xml += "    <cbc:Name>" + EscapeForXml(KPSY_USER_NAZIV) + "</cbc:Name>\n"; //HR-BT-4; 0..1 ; naziv operatera
    xml += "  </cac:SellerContact>\n";


    xml += "</cac:AccountingSupplierParty>\n";

    // -----------------------------------------------------------
    // Customer
    // -----------------------------------------------------------
    xml += "<cac:AccountingCustomerParty>\n";
    xml += "  <cac:Party>\n";
    

    // Use GLN (0088 scheme) if available and valid (13 characters), otherwise use OIB (9934 scheme)
    cusSchemeID = "9934";
    // NKPR_GL_JMBG = "82113036885";
    cusEndpointID = NKPR_GL_JMBG;
    cusPartyID = "9934:" + NKPR_GL_JMBG;
    cusPartyTaxScheme = "VAT";
    if (NKSC_TAX_DN == "N" || NKSC_TAX_DN == "") {
        cusPartyTaxScheme = "FRE";
    }
    // if (nksc_sop != "" && nksc_sop.length == 13) {
    //     cusSchemeID = "0088";
    //     cusEndpointID = nksc_sop;
    //     cusPartyID = "0088:" + nksc_sop;
    // }
    
    xml += "    <cbc:EndpointID schemeID=\"" + cusSchemeID + "\">" + cusEndpointID + "</cbc:EndpointID>\n";
    if (NKSP_AD_OBJED != "") {
        xml += "    <cbc:PartyIdentification><cbc:ID>>" + cusPartyID +"::HR99:" + EscapeForXml(NKSP_AD_OBJED) + "</cbc:ID></cac:PartyIdentification>\n"; 
    }else  {
        xml += "    <cac:PartyIdentification><cbc:ID>" + cusPartyID + "</cbc:ID></cac:PartyIdentification>\n";
    }
    xml += "    <cac:PartyName><cbc:Name>" + EscapeForXml(NKPR_GL_CUSNME) + "</cbc:Name></cac:PartyName>\n";
    xml += "    <cac:PostalAddress>\n";
    gl_ro = (NKPR_GL_RO != "" ? " " + NKPR_GL_RO : "");
    StreetName = NKPR_GL_CUSA1 + gl_ro;

    xml += "      <cbc:StreetName>" + EscapeForXml(StreetName) + "</cbc:StreetName>\n";
    // xml += "      <cbc:AdditionalStreetName>***put 6***</cbc:AdditionalStreetName>\n";
    xml += "      <cbc:CityName>" + EscapeForXml(NKPR_GL_CUSCTY) + "</cbc:CityName>\n";
    xml += "      <cbc:PostalZone>" + EscapeForXml(NKPR_GL_CUSZIP) + "</cbc:PostalZone>\n";
    // xml += "      <cbc:CountrySubentity>***Grad Zagreb***</cbc:CountrySubentity>\n";
    xml += "      <cac:Country><cbc:IdentificationCode>" + EscapeForXml(NKPR_GL_DRZAVA) + "</cbc:IdentificationCode></cac:Country>\n";
    xml += "    </cac:PostalAddress>\n";

    if(NKPR_GL_CUSST == ""){
        MessageBox("Kupac nema unesenu oznaku države uz OIB!");
        return false;
    }
    xml += "    <cac:PartyTaxScheme><cbc:CompanyID>" + nkpr_gl_cusst.trim() + NKPR_GL_JMBG + "</cbc:CompanyID>\n"; //BT-48
    xml += "      <cac:TaxScheme><cbc:ID>" + cusPartyTaxScheme + "</cbc:ID></cac:TaxScheme></cac:PartyTaxScheme>\n";
    //xml += "    <cac:PartyTaxScheme><cbc:CompanyID>" + NKPR_GL_JMBG + "</cbc:CompanyID><cac:TaxScheme><cbc:ID>VAT</cbc:ID></cac:TaxScheme></cac:PartyTaxScheme>\n";
    


    // ??? PartyLegalEntity
    xml += "    <cac:PartyLegalEntity>\n";
    xml += "      <cbc:RegistrationName>" + EscapeForXml(NKPR_GL_CUSNME) + "</cbc:RegistrationName>\n"; 
    // if (KPSY_COMP_JMBFI != "") {
    //     // xml += "      <cbc:CompanyID schemeID=\"MBS\">" + KPSY_COMP_JMBFI + "</cbc:CompanyID>\n";
    //     // xml += "      <cbc:CompanyID>" +  + "</cbc:CompanyID>\n";
    // }
    xml += "    </cac:PartyLegalEntity>\n";

    
    xml += "  </cac:Party>\n";
    xml += "</cac:AccountingCustomerParty>\n";
     // -----------------------------------------------------------
     // Delivery Location (if specified)
     // -----------------------------------------------------------
     // Check if any delivery location information is present
     if (NKPR_GL_SHPCOD != "" || NKPR_GL_SHPNME != "" || NKPR_GL_SHPRO != "") {

         xml += "<cac:Delivery>\n";
         xml += "  <cac:DeliveryLocation>\n";
     
         // Determine delivery location ID - preference: NKSP_AD_GLN (13 chars) > NKPR_GL_SHPCOD > 'ZZZZ'
         deliveryLocationID = "";
         deliverySchemeID = "";
      
        //  if (NKSP_AD_GLN != "") {
        //     // GLN number has preference (13 characters)
        //     if (NKSP_AD_GLN.Length == 13) {
        //         deliveryLocationID = NKSP_AD_GLN;
        //         deliverySchemeID = "0088"; // GLN scheme
        //     } else{
        //         deliveryLocationID = NKSP_AD_GLN;
        //         deliverySchemeID = "INTERNAL"; // GLN scheme
        //     }
        //     xml += "    <cbc:ID schemeID=\"" + deliverySchemeID + "\">" + deliveryLocationID + "</cbc:ID>\n";
        // } el
        if (NKPR_GL_SHPCOD != "") {
            // Internal delivery location code
            deliveryLocationID = NKPR_GL_SHPCOD;
            deliverySchemeID = "INTERNAL"; // Internal code scheme (Croatia)
            xml += "    <cbc:ID schemeID=\"" + deliverySchemeID + "\">" + deliveryLocationID + "</cbc:ID>\n";
        } else {
            // Ad hoc code when no specific ID available
            deliveryLocationID = "ZZZZ";
            //deliverySchemeID = "9934";
            xml += "    <cbc:ID>" + deliveryLocationID + "</cbc:ID>\n";
        }
        
        
        
         // Add delivery address if any address components are present
         if (NKPR_GL_SHPA1 != "" || NKPR_GL_SHPCTY != "" || NKPR_GL_SHPZIP != "" || NKPR_GL_SHPST != "") {
             xml += "    <cac:Address>\n";
            
             if (NKPR_GL_SHPA1 != "") {
                 xml += "      <cbc:StreetName>" + EscapeForXml(NKPR_GL_SHPA1) + "</cbc:StreetName>\n";
             }
            
             if (NKPR_GL_SHPCTY != "") {
                 xml += "      <cbc:CityName>" + EscapeForXml(NKPR_GL_SHPCTY) + "</cbc:CityName>\n";
             }
            
             if (NKPR_GL_SHPZIP != "") {
                 xml += "      <cbc:PostalZone>" + EscapeForXml(NKPR_GL_SHPZIP) + "</cbc:PostalZone>\n";
             }
            
             if (NKPR_GL_SHPST != "") {
                 xml += "      <cac:Country>\n";
                 xml += "        <cbc:IdentificationCode>" + EscapeForXml(NKPR_GL_SHPST) + "</cbc:IdentificationCode>\n";
                 xml += "      </cac:Country>\n";
             }
            
             xml += "    </cac:Address>\n";
         }
        
         xml += "  </cac:DeliveryLocation>\n";
        
         // Add delivery party information if name or province is available
         if (NKPR_GL_SHPNME != "" || NKPR_GL_SHPRO != "") {
             xml += "  <cac:DeliveryParty>\n";
            
             if (NKPR_GL_SHPNME != "") {
                 xml += "    <cac:PartyName>\n";
                 xml += "      <cbc:Name>" + EscapeForXml(NKPR_GL_SHPNME) + "</cbc:Name>\n";
                 xml += "    </cac:PartyName>\n";
             }
            
             // If province is different from delivery address, add it as party location
             if (NKPR_GL_SHPRO != "" && NKPR_GL_SHPRO != NKPR_GL_SHPST) {
                 xml += "    <cac:PhysicalLocation>\n";
                 xml += "      <cac:Address>\n";
                 xml += "        <cbc:CountrySubentity>" + EscapeForXml(NKPR_GL_SHPRO) + "</cbc:CountrySubentity>\n";
                 xml += "      </cac:Address>\n";
                 xml += "    </cac:PhysicalLocation>\n";
             }
            
             xml += "  </cac:DeliveryParty>\n";
         }
        
         xml += "</cac:Delivery>\n";
     }

    // -----------------------------------------------------------
    // Payment Means
    // -----------------------------------------------------------
    payCode = "30";
    KPKS_PL_OPIS = "Plaćanje virmanom";
    sql_pay = "SELECT KPKS_PL_NAZIV2, KPKS_PL_OPIS, KPKS_PL_TIP FROM " + databaseName + ".dbo.KPKSVRPL WHERE KPKS_PL_SIF_PL = @p1;";
    sqlParams = {};
    sqlParams.Add({"@p1", NKPR_GL_SIF_PL});
    payRes = sqlQuery(sql_pay, sqlParams);
    if (Size(payRes) >= 2) {
        KPKS_PL_NAZIV2 = payRes[1][0].trim();
        KPKS_PL_OPIS = payRes[1][1].trim();
        KPKS_PL_TIP = payRes[1][2].trim();

        code3 = int(Substring(payRes[1][0], 0, 2));
        if (code3 >= 30 && code3 <= 59) { // ???
            payCode = string(code3);
        }
    }
    xml += "<cac:PaymentMeans>\n";
    xml += "  <cbc:PaymentMeansCode>" + payCode + "</cbc:PaymentMeansCode>\n";
    xml += "  <cbc:InstructionNote>" + EscapeForXml(KPKS_PL_OPIS) + "</cbc:InstructionNote>\n";
    xml += "  <cbc:PaymentID>HR" + NKPR_GL_MODEL + " " + NKPR_GL_POZIV + "</cbc:PaymentID>\n";

    sql_bank = "SELECT NKSC_ZR_KONTO, NKSC_ZR_NAZIV FROM " + databaseName + ".dbo.NKSCZIRO WHERE NKSC_ZR_BANKA = @p1;";
    sqlParams = {};
    sqlParams.Add({"@p1", NKPR_GL_RZRVA1});
    bankRes = sqlQuery(sql_bank, sqlParams);
    if (Size(bankRes) >= 1) {
        NKSC_ZR_KONTO = bankRes[1][0].trim();
        NKSC_ZR_NAZIV = bankRes[1][1].trim();
        xml += "  <cac:PayeeFinancialAccount>\n";
        xml += "    <cbc:ID>" + NKSC_ZR_KONTO + "</cbc:ID>\n";
        // xml += "    <cbc:AccountType>TRAN</cbc:AccountType>\n";
        xml += "    <cbc:Name>" + EscapeForXml(NKSC_ZR_NAZIV) + "</cbc:Name>\n";
        xml += "  </cac:PayeeFinancialAccount>\n";
    }
    xml += "</cac:PaymentMeans>\n";

    //tu treba AllowanceCharge na nivou računa ako postoji rabat ili dodatni trošak na razini računa; rabat se u Knjigama ne koristi, samo trošak može
    if (invoiceLevelCharge != 0) {
        xml += "<cac:AllowanceCharge>\n"; //BG-21
        if (invoiceLevelCharge > 0) {
            xml += "  <cbc:ChargeIndicator>true</cbc:ChargeIndicator>\n"; // true = charge, false = allowance
            xml += "  <cbc:AllowanceChargeReason>#HR:PP#Poez na potrošnju</cbc:AllowanceChargeReason>\n"; //HR-BT-7
            xml += "	<cbc:MultiplierFactorNumeric>" + AllowChgMultiplierFactor + "</cbc:MultiplierFactorNumeric>\n"; //BT-101
            xml += "	<cbc:Amount currencyID=\"EUR\">" + FormatNum(AllowChgAmount, 2, ".", formatNumOption) + "</cbc:Amount>\n"; //BT-99

            xml += "	<cbc:BaseAmount currencyID=\"EUR\">" + FormatNum(AllowChgBaseAmount, 2, ".", formatNumOption) + "</cbc:BaseAmount>\n"; //BT-100
            xml += "	<cac:TaxCategory>\n";
            xml += "		<cbc:ID>E</cbc:ID>\n"; //BT-102
            xml += "		<cbc:Name>HR:PP</cbc:Name>\n"; //HR-BT-6
            xml += "		<cbc:Percent>0.00</cbc:Percent>\n"; //BT-103
            xml += "        <cbc:TaxExemptionReason>#"+EscapeForXml(AllowChgExemptReason)+"</cbc:TaxExemptionReason>\n"; 
            xml += "		<cac:TaxScheme>\n";
            xml += "			<cbc:ID>VAT</cbc:ID>\n";
            xml += "		</cac:TaxScheme>\n";
            xml += "	</cac:TaxCategory>\n";
        } else {
            xml += "  <cbc:ChargeIndicator>false</cbc:ChargeIndicator>\n"; // true = charge, false = allowance
            xml += "  <cbc:AllowanceChargeReason>Discount at invoice level</cbc:AllowanceChargeReason>\n";
            xml += "  <cbc:Amount currencyID=\"EUR\">" + FormatNum(Abs(invoiceLevelCharge), 2, ".", formatNumOption) + "</cbc:Amount>\n";
        }
    xml += "</cac:AllowanceCharge>\n";
    }   
    // FORMAT mora bit npr. 123.45, ne 123,45... i 123.00 ne 123 // ???

    xml += "            <cac:TaxTotal>\n";
    xml += "                <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(totalPorez, 2, ".", formatNumOption) + "</cbc:TaxAmount>\n";
    
    // Group taxes by category and sum amounts
    taxCategoryGroups = {};
    
    for (i = 1; i < Size(taxRes2); i++) {
        row = taxRes2[i];
    
        POREZ = row[0];
        OSNOVICA = row[1];
        NKPR_LN_PRNPR = row[2];
        PKFK_TAX_TARIFA = row[3].trim();
        PKFK_TAX_DOBOPC = Substring(row[4], 0, 2).trim(); //šifra izjave za oslobođenje od poreza
        PKFK_TAX_P_PORZ = row[6]; // Get tax type (P=PDV, T=Consumption tax, etc.)
    
        // Map tax categories - all PDV variants (PDV25, PDV13, PDV5) should be 'S'
        categoryID = PKFK_TAX_TARIFA;
        if (SUBSTRING(PKFK_TAX_TARIFA, 0, 3) == 'PDV') {
            categoryID = "S"; // Standard rate for all PDV variants
        }
        elif (PKFK_TAX_TARIFA == 'POVNAK') {
            categoryID = "E"; // Standard rate for all PDV variants
        }

        // Create unique key for grouping: categoryID + taxRate + exemptCode
        groupKey = categoryID + "_" + NKPR_LN_PRNPR + "_" + PKFK_TAX_DOBOPC;

        if (!Contains(taxCategoryGroups, groupKey)) {
            // First entry for this group
            taxCategoryGroups[groupKey] = {
                "categoryID": categoryID,
                "originalTarifa": PKFK_TAX_TARIFA,
                "taxRate": NKPR_LN_PRNPR,
                "exemptCode": PKFK_TAX_DOBOPC,
                "taxType": PKFK_TAX_P_PORZ,
                "totalTaxAmount": POREZ,
                "totalTaxableAmount": OSNOVICA
            };
        } else {
            // Add to existing group
            taxCategoryGroups[groupKey]["totalTaxAmount"] += POREZ;
            taxCategoryGroups[groupKey]["totalTaxableAmount"] += OSNOVICA;
        }
    }
    
    // Generate TaxSubtotal for each category group
    for (group : taxCategoryGroups) {
        // MSG("groupKey: " + groupKey);

        // group = taxCategoryGroups[groupKey];
        categoryID = group["categoryID"];
        originalTarifa = group["originalTarifa"];
        taxRate = group["taxRate"];
        exemptCode = group["exemptCode"];
        taxType = group["taxType"];
        totalTaxAmount = group["totalTaxAmount"];
        totalTaxableAmount = group["totalTaxableAmount"];
        
        exemptReason = "";
        chargeTotAmt = 0;
        //if (exemptCode != "" && taxRate == 0) {
        if (exemptCode != "") {
            //ovaj porez ima stopu 0 i ima izjavu koju treba unijet u polje u e-računu
            //to su zapravo svi porezi koji su oslobođeni PDV-a, kategorije E,K,O,
            sql_tax_exempt= "SELECT trim(KPSY_IZ_TEXT01)+' '+trim(KPSY_IZ_TEXT02)+' '+trim(KPSY_IZ_TEXT03)+' '+trim(KPSY_IZ_TEXT04)+' '+trim(KPSY_IZ_TEXT05)" +
                      " FROM " + databaseName + ".dbo.KPSYIZKU " +
                      " WHERE @p1 = KPSY_IZ_CODE;";
            sqlParams = {};
            sqlParams.Add({"@p1", exemptCode});
            exemptQuery = sqlQuery(sql_tax_exempt, sqlParams);
            if (Size(exemptQuery) > 1) {
                exemptReason =exemptQuery[1][0].trim();
            }
        }
        xml += "                <cac:TaxSubtotal>\n";
        taxOutOfScopeAmt = 0;
        taxName = "";
        taxSchemeID = "VAT";
        
        if (originalTarifa == "PP") {
            //porez na potrošnju
            taxName = "HR:PP"; 
            taxSchemeID = "VAT";
            taxOutOfScopeAmt = FormatNum(totalTaxAmount, 2, ".", formatNumOption);
            xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(totalTaxAmount, 2, ".", formatNumOption) + "</cbc:TaxableAmount>\n"; // BT-116
            xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + "0.00" + "</cbc:TaxAmount>\n";
            xml += "                    <cac:TaxCategory>\n";
            xml += "                        <cbc:ID>" + "E" + "</cbc:ID>\n"; // BT-118
            //xml += "                        <cbc:Name>" + EscapeForXml(taxName) + "</cbc:Name>\n";
            xml += "                        <cbc:Percent>" + "0.00" + "</cbc:Percent>\n";
            if (exemptReason != ""){
                xml += "                        <cbc:TaxExemptionReason>#HR_PP#" + EscapeForXml(exemptReason) + "</cbc:TaxExemptionReason>\n"; //BT-120
            }   
            xml += "                        <cac:TaxScheme>\n";
            xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
            xml += "                        </cac:TaxScheme>\n";
            xml += "                    </cac:TaxCategory>\n";
            chargeTotAmt += totalTaxAmount;
           
        } elif (originalTarifa == "O"){ 
            //ostali porezi
            taxName = "HR:OTH"; //tu nema poreza
            xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(totalTaxableAmount, 2, ".", formatNumOption) + "</cbc:TaxableAmount>\n";
            xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + "0.00" + "</cbc:TaxAmount>\n";
            xml += "                    <cac:TaxCategory>\n";
            xml += "                        <cbc:ID>" + "E" + "</cbc:ID>\n";
            //xml += "                        <cbc:Name>" + EscapeForXml(taxName) + "</cbc:Name>\n";
            xml += "                        <cbc:Percent>" + "0.00" + "</cbc:Percent>\n";
            if (exemptReason != ""){
                xml += "                        <cbc:TaxExemptionReason>" + taxName + EscapeForXml(exemptReason) + "</cbc:TaxExemptionReason>\n"; //BT-120
            }   
            xml += "                        <cac:TaxScheme>\n";
            xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
            xml += "                        </cac:TaxScheme>\n";
            xml += "                    </cac:TaxCategory>\n";
        }
        elif (originalTarifa == "POVNAK"){ 
            //Povratna naknada
            taxName = "HR:POVNAK"; //nema poreza
            xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(totalTaxableAmount, 2, ".", formatNumOption) + "</cbc:TaxableAmount>\n";
            xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + "0.00" + "</cbc:TaxAmount>\n";
            xml += "                    <cac:TaxCategory>\n";
            xml += "                        <cbc:ID>E</cbc:ID>\n";
            //xml += "                        <cbc:Name>" + EscapeForXml(taxName) + "</cbc:Name>\n";
            xml += "                        <cbc:Percent>" + "0.00" + "</cbc:Percent>\n";
            if (exemptReason != ""){
                xml += "                        <cbc:TaxExemptionReason>" + "#" + taxName + "#" + EscapeForXml(exemptReason) + "</cbc:TaxExemptionReason>\n";
            }   
            xml += "                        <cac:TaxScheme>\n";
            xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
            xml += "                        </cac:TaxScheme>\n";
            xml += "                    </cac:TaxCategory>\n";
        }
        elif (SUBSTRING(originalTarifa, 0, 3) == 'PDV'){
            taxName = "HR:" + originalTarifa;
            xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(totalTaxableAmount, 2, ".", formatNumOption) + "</cbc:TaxableAmount>\n";
            xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(totalTaxAmount, 2, ".", formatNumOption) + "</cbc:TaxAmount>\n";
            xml += "                    <cac:TaxCategory>\n";
            xml += "                        <cbc:ID>S</cbc:ID>\n"; // All PDV variants use 'S' category
            //xml += "                        <cbc:Name>" + taxName + "</cbc:Name>\n";
            xml += "                        <cbc:Percent>" + FormatNum(taxRate, 0, ".", formatNumOption) + "</cbc:Percent>\n";
            xml += "                        <cac:TaxScheme>\n";
            xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
            xml += "                        </cac:TaxScheme>\n";
            xml += "                    </cac:TaxCategory>\n";
        }
        elif (originalTarifa == 'E'){  
            taxName = "HR:E";
            xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(totalTaxableAmount, 2, ".", formatNumOption) + "</cbc:TaxableAmount>\n";
            xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(totalTaxAmount, 2, ".", formatNumOption) + "</cbc:TaxAmount>\n";
            xml += "                    <cac:TaxCategory>\n";
            xml += "                        <cbc:ID>" + categoryID + "</cbc:ID>\n";
            //xml += "                        <cbc:Name>" + EscapeForXml(taxName) + "</cbc:Name>\n";
            xml += "                        <cbc:Percent>" + FormatNum(taxRate, 0, ".", formatNumOption) + "</cbc:Percent>\n";
            if (exemptReason != ""){
                xml += "                        <cbc:TaxExemptionReason>" + taxName + EscapeForXml(exemptReason) + "</cbc:TaxExemptionReason>\n";
            }   
            xml += "                        <cac:TaxScheme>\n";
            xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
            xml += "                        </cac:TaxScheme>\n";
            xml += "                    </cac:TaxCategory>\n";
        } elif (originalTarifa == 'K'){   
            taxName = "HR:K";
            xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(totalTaxableAmount, 2, ".", formatNumOption) + "</cbc:TaxableAmount>\n";
            xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(totalTaxAmount, 2, ".", formatNumOption) + "</cbc:TaxAmount>\n";
            xml += "                    <cac:TaxCategory>\n";
            xml += "                        <cbc:ID>" + "E" + "</cbc:ID>\n";
            //xml += "                        <cbc:Name>" + EscapeForXml(taxName) + "</cbc:Name>\n";
            xml += "                        <cbc:Percent>" + FormatNum(taxRate, 0, ".", formatNumOption) + "</cbc:Percent>\n";
            if (exemptReason != ""){
                xml += "                        <cbc:TaxExemptionReason>" + EscapeForXml(exemptReason) + "</cbc:TaxExemptionReason>\n";
            }   
            xml += "                        <cac:TaxScheme>\n";
            xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
            xml += "                        </cac:TaxScheme>\n";
            xml += "                    </cac:TaxCategory>\n";
        }
        else{   
            taxName = "HR:"+originalTarifa;
            xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(totalTaxableAmount, 2, ".", formatNumOption) + "</cbc:TaxableAmount>\n";
            xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(totalTaxAmount, 2, ".", formatNumOption) + "</cbc:TaxAmount>\n";
            xml += "                    <cac:TaxCategory>\n";
            xml += "                        <cbc:ID>" + categoryID + "</cbc:ID>\n";
            //xml += "                        <cbc:Name>" + EscapeForXml(taxName) + "</cbc:Name>\n";
            xml += "                        <cbc:Percent>" + FormatNum(taxRate, 0, ".", formatNumOption) + "</cbc:Percent>\n";
            if (exemptReason != ""){
                xml += "                        <cbc:TaxExemptionReason>" + taxName + EscapeForXml(exemptReason) + "</cbc:TaxExemptionReason>\n";
            }   
            xml += "                        <cac:TaxScheme>\n";
            xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
            xml += "                        </cac:TaxScheme>\n";
            xml += "                    </cac:TaxCategory>\n";
        }
        xml += "                </cac:TaxSubtotal>\n";
    }

    xml += "            </cac:TaxTotal>\n";


    // LegalMonetaryTotal
    total = NKPR_GL_TOTAL;
    prepaid = (profileID == "P11" ? NKPR_GL_REZ1 : 0);
    payable = total - prepaid;
    rounding = total - (totalOsnovica + totalPorez);

    xml += "<cac:LegalMonetaryTotal>\n";
    xml += "  <cbc:LineExtensionAmount currencyID=\"EUR\">" + FormatNum(totalOsnovica, 2, ".", formatNumOption) + "</cbc:LineExtensionAmount>\n"; // BT-106
    xml += "  <cbc:TaxExclusiveAmount currencyID=\"EUR\">" + FormatNum(total - totalPorez, 2, ".", formatNumOption) + "</cbc:TaxExclusiveAmount>\n"; // BT-109
    xml += "  <cbc:TaxInclusiveAmount currencyID=\"EUR\">" + FormatNum(total, 2, ".", formatNumOption) + "</cbc:TaxInclusiveAmount>\n"; // BT-110
    xml += "  <cbc:ChargeTotalAmount currencyID=\"EUR\">" + FormatNum(ChargeTotAmt, 2, ".", formatNumOption) + "</cbc:ChargeTotalAmount>\n"; // BT-108
    if (prepaid > 0) { xml += "  <cbc:PrepaidAmount currencyID=\"EUR\">" + FormatNum(prepaid, 2, ".", formatNumOption) + "</cbc:PrepaidAmount>\n"; } // BT-113
    xml += "  <cbc:PayableAmount currencyID=\"EUR\">" + FormatNum(payable, 2, ".", formatNumOption) + "</cbc:PayableAmount>\n"; // BT-115
    // if (rounding != 0) { xml += "  <cbc:PayableRoundingAmount currencyID=\"EUR\">" + FormatNum(rounding, 2, ".", formatNumOption) + "</cbc:PayableRoundingAmount>\n"; }
    xml += "</cac:LegalMonetaryTotal>\n";
    
    // -----------------------------------------------------------
    // Invoice Lines
    // -----------------------------------------------------------
    for (j = 1; j < Size(linRes); j++) {

        fillInvoiceLine(j);

        grossAmount = NKPR_LN_PQTY * NKPR_LN_PPRCE;
        netAmount = NKPR_LN_AMT;
        
        // Calculate different discount components
        // a. Invoice level discount (NKPR_GL_SCONTO) - only if NKPR_GL_DANSC = 0
        invoiceLevelDiscountAmount = 0;
        if (NKPR_GL_DANSC == "0" && NKPR_LN_POPU != 0) {
            invoiceLevelDiscountAmount = NKPR_LN_POPU; // Amount from invoice discount distributed to this line
        }
        
        // b. Line level discounts - NKPR_LN_POPL contains total discount including invoice discount
        // So line discount amount = NKPR_LN_POPL - NKPR_LN_POPU
        lineLevelDiscountAmount = NKPR_LN_POPL - NKPR_LN_POPU;
        
        // Current discountTotal calculation for verification
        discountTotal = grossAmount - netAmount;

        noteText= "";
        if (NKPR_LN_BROPI1 != 0) {
            sql_note = "SELECT kppr_op_text FROM " + databaseName + ".dbo.KPPROPIS WHERE KPPR_OP_BROJ = @p1 ORDER BY KPPR_OP_BROJ, kppr_op_lin;";
            sqlParams = {};
            sqlParams.Add({"@p1", NKPR_LN_BROPI1});
            noteRes = sqlQuery(sql_note, sqlParams);
            if (Size(noteRes) >= 2) {
                for (m = 1; m < Size(noteRes); m++) {   
                    noteText += noteRes[m][0];
                }
            }    
        }
        if (NKPR_LN_BROPI != 0) {
            sql_note = "SELECT kppr_op_text FROM " + databaseName + ".dbo.KPPROPIS WHERE KPPR_OP_BROJ = @p1 ORDER BY KPPR_OP_BROJ, kppr_op_lin;";
            sqlParams = {};
            sqlParams.Add({"@p1", NKPR_LN_BROPI});
            noteRes = sqlQuery(sql_note, sqlParams);
            if (Size(noteRes) >= 2) {
                for (N = 1; N < Size(noteRes); N++) {   
                    noteText += noteRes[N][0];
                }
            }    
        }

        if (profileID == "P9") {
            xml += "<cac:CreditNoteLine>\n";
            xml += "  <cbc:ID>" + NKPR_LN_BR_LN + "</cbc:ID>\n";
            if(noteText != ""){
                xml += "  <cbc:Note>" + noteText.trim() + "</cbc:Note>\n"; //BT-127, 0..1   
            }
            xml += "  <cbc:CreditedQuantity unitCode=\"" + GetUNUnitCode(NKPR_LN_JEDMJ) + "\">" + FormatNum(NKPR_LN_PQTY, 4, ".", formatNumOption) + "</cbc:CreditedQuantity>\n";
        } elif (nkpr_gl_oznaka == 'T') {
            xml += "<DebitNoteLine>\n";
            xml += "  <cbc:ID>" + NKPR_LN_BR_LN + "</cbc:ID>\n";
            if(noteText != ""){
                xml += "  <cbc:Note>" + noteText.trim() + "</cbc:Note>\n"; //BT-127, 0..1   
            }
            xml += "  <cbc:DebitedQuantity unitCode=\"" + GetUNUnitCode(NKPR_LN_JEDMJ) + "\">" + FormatNum(NKPR_LN_PQTY, 4, ".", formatNumOption) + "</cbc:DebitedQuantity>\n";
        } else {
            xml += "<cac:InvoiceLine>\n";
            xml += "  <cbc:ID>" + NKPR_LN_BR_LN + "</cbc:ID>\n";
            if(noteText != ""){
                xml += "  <cbc:Note>" + noteText.trim() + "</cbc:Note>\n"; //BT-127, 0..1   
            }
            xml += "  <cbc:InvoicedQuantity unitCode=\"" + GetUNUnitCode(NKPR_LN_JEDMJ) + "\">" + FormatNum(NKPR_LN_PQTY, 4, ".", formatNumOption) + "</cbc:InvoicedQuantity>\n";
        }
        xml += "  <cbc:LineExtensionAmount currencyID=\"EUR\">" + FormatNum(NKPR_LN_AMT, 2, ".", formatNumOption) + "</cbc:LineExtensionAmount>\n"; //BT-131
        // xml += "  <cbc:ItemInternalID>" + NKPR_LN_PCODE + "</cbc:ItemInternalID>\n";

        // Line discount - standardni popust na IZNOS stavke!
        //ako je u nksysyco - 'IR','','','PopustNaCijenu'= 'D' onda se popust ne prikazuje ovdje nego u cijeni malo niže, i to samo prvi popust u polju nkpr_ln_disc
        //inače se oba popusta prikazuju ovdje - nkpr_ln_disc i nkpr_ln_pstop
        //znači ako je discounttotal<> 0 i ako nije 'D' u nksysyco onda se prikazuje ovdje oba popusta
        //iznos popusta u linijama je u polju nkpr_ln_popl i to je ukupan popust koji uključuje polja nlpr_ln_disc, nkpr_ln_pstop i popust iz zaglavlja (na cijeli račun)
        //u plju nkpr_ln_popu je samo popust iz zaglavlja nkpr_gl_sconto koji je tu prenešen na linije, a računa se samo ako je u polju NKPR_GL_DANSC= 0
        
        // Generate AllowanceCharge elements for different discount types
        
        // 1. Invoice level discount (if NKPR_GL_DANSC = 0 and NKPR_LN_POPU > 0)
        if (invoiceLevelDiscountAmount > 0) {
            xml += "  <cac:AllowanceCharge>\n";
            xml += "    <cbc:ChargeIndicator>false</cbc:ChargeIndicator>\n";
            xml += "    <cbc:AllowanceChargeReason>Popust na osnovu računa (" + NKPR_GL_SCONTO + "%)</cbc:AllowanceChargeReason>\n";
            xml += "    <cbc:MultiplierFactorNumeric>" + FormatNum((invoiceLevelDiscountAmount / grossAmount) * 100, 2, ".", formatNumOption) + "</cbc:MultiplierFactorNumeric>\n";
            xml += "    <cbc:Amount currencyID=\"EUR\">" + FormatNum(invoiceLevelDiscountAmount, 2, ".", formatNumOption) + "</cbc:Amount>\n";
            xml += "    <cbc:BaseAmount currencyID=\"EUR\">" + FormatNum(grossAmount, 2, ".", formatNumOption) + "</cbc:BaseAmount>\n";
            xml += "  </cac:AllowanceCharge>\n";
        }
       
        // 2. Line level discounts (NKPR_LN_PDISC and NKPR_LN_PSTOPA combined)
        if (lineLevelDiscountAmount > 0) {
            xml += "  <cac:AllowanceCharge>\n";
            xml += "    <cbc:ChargeIndicator>false</cbc:ChargeIndicator>\n";
            reasonText = "Popust na stavku";
            if (NKPR_LN_PDISC != 0 && NKPR_LN_PSTOPA != 0) {
                reasonText += " (" + FormatNum(NKPR_LN_PDISC, 2, ".", formatNumOption) + "% + " + FormatNum(NKPR_LN_PSTOPA, 2, ".", formatNumOption) + "%)";
            } elif (NKPR_LN_PDISC != 0) {
                reasonText += " (" + FormatNum(NKPR_LN_PDISC, 2, ".", formatNumOption) + "%)";
            } elif (NKPR_LN_PSTOPA != 0) {
                reasonText += " (" + FormatNum(NKPR_LN_PSTOPA, 2, ".", formatNumOption) + "%)";
            }
            xml += "    <cbc:AllowanceChargeReason>" + EscapeForXml(reasonText) + "</cbc:AllowanceChargeReason>\n";
            xml += "    <cbc:MultiplierFactorNumeric>" + FormatNum((lineLevelDiscountAmount / grossAmount) * 100, 2, ".", formatNumOption) + "</cbc:MultiplierFactorNumeric>\n";
            xml += "    <cbc:Amount currencyID=\"EUR\">" + FormatNum(lineLevelDiscountAmount, 2, ".", formatNumOption) + "</cbc:Amount>\n";
            xml += "    <cbc:BaseAmount currencyID=\"EUR\">" + FormatNum(grossAmount, 2, ".", formatNumOption) + "</cbc:BaseAmount>\n";
            xml += "  </cac:AllowanceCharge>\n";
        } elif (lineLevelDiscountAmount < 0) {
            // Negative line discount = charge
            xml += "  <cac:AllowanceCharge>\n";
            xml += "    <cbc:ChargeIndicator>true</cbc:ChargeIndicator>\n";
            xml += "    <cbc:AllowanceChargeReason>Naplata na stavku</cbc:AllowanceChargeReason>\n";
            xml += "    <cbc:MultiplierFactorNumeric>" + FormatNum((Math.abs(lineLevelDiscountAmount) / grossAmount) * 100, 2, ".", formatNumOption) + "</cbc:MultiplierFactorNumeric>\n";
            xml += "    <cbc:Amount currencyID=\"EUR\">" + FormatNum(Math.abs(lineLevelDiscountAmount), 2, ".", formatNumOption) + "</cbc:Amount>\n";
            xml += "    <cbc:BaseAmount currencyID=\"EUR\">" + FormatNum(grossAmount, 2, ".", formatNumOption) + "</cbc:BaseAmount>\n";
            xml += "  </cac:AllowanceCharge>\n";
        }
        
        // 3. If no discounts, add a zero allowance for completeness (optional)
        if (invoiceLevelDiscountAmount == 0 && lineLevelDiscountAmount == 0) {
            xml += "  <cac:AllowanceCharge>\n";
            xml += "    <cbc:ChargeIndicator>false</cbc:ChargeIndicator>\n";
            xml += "    <cbc:AllowanceChargeReason>Bez popusta</cbc:AllowanceChargeReason>\n";
            xml += "    <cbc:MultiplierFactorNumeric>0.00</cbc:MultiplierFactorNumeric>\n";
            xml += "    <cbc:Amount currencyID=\"EUR\">0.00</cbc:Amount>\n";
            xml += "    <cbc:BaseAmount currencyID=\"EUR\">" + FormatNum(grossAmount, 2, ".", formatNumOption) + "</cbc:BaseAmount>\n";
            xml += "  </cac:AllowanceCharge>\n";
        }
       
        // Verification: Check if our calculation matches the current discountTotal
        calculatedDiscountTotal = invoiceLevelDiscountAmount + lineLevelDiscountAmount;
        if (Math.abs(calculatedDiscountTotal - discountTotal) > 0.01) {
            // Add comment for debugging if there's a discrepancy
            xml += "  <!-- DISCOUNT VERIFICATION: Calculated=" + FormatNum(calculatedDiscountTotal, 2, ".", formatNumOption) + 
                   " vs Current=" + FormatNum(discountTotal, 2, ".", formatNumOption) + " -->\n";
        }
        
        xml += "  <cac:Item>\n";
        xml += "    <cbc:Name>" + EscapeForXml(NKPR_LN_PDESC) + "</cbc:Name>\n";

        // Item codes
        sql_art = "SELECT ARTI_ARTIKL, ARTI_SIFART_BAR, ARTI_PRELIMTEZ FROM " + databaseName + ".dbo.NKMKARTI WHERE ARTI_ARTIKL = @p1 ORDER BY ARTI_ARTIKL;";
        sqlParams = {};
        sqlParams.Add({"@p1", NKPR_LN_PCODE});
        artRes = sqlQuery(sql_art, sqlParams);
        ean = "";
        intCode = "";
        if (Size(artRes) >= 2) {
            ARTI_ARTIKL = artRes[1][0].trim();
            ARTI_SIFART_BAR = artRes[1][1].trim();
            ARTI_PRELIMTEZ = artRes[1][2].trim();

            if (ARTI_SIFART_BAR.length == 13) {
                ean = ARTI_SIFART_BAR;
                intCode = ARTI_ARTIKL;
            } elif(ARTI_ARTIKL.length == 13) {
                ean = ARTI_ARTIKL;
                intCode = ARTI_SIFART_BAR;
            } else {
                intCode = ARTI_ARTIKL;
                ean = "";
            }
        }
        xml += "    <cac:SellersItemIdentification><cbc:ID>" + intCode + "</cbc:ID></cac:SellersItemIdentification>\n";
        if (ean.length == 13) {
            xml += "    <cac:StandardItemIdentification><cbc:ID schemeID=\"0160\">" + ean + "</cbc:ID></cac:StandardItemIdentification>\n";
        }

        // KPD
        kpd = NKPR_LN_GRUPA;
        if (kpd == "" && Size(artRes) >= 2) { 
            kpd = ARTI_PRELIMTEZ; 
        }

        // ???
        //Uzimati samo tipove artikla R G S N P za KPD - redovni gotovi proizvodi, sastavljeni, usluge i povratna naknada!    
        if (kpd.length == 6 && (NKPR_LN_MA_US == "R" || NKPR_LN_MA_US == "G" || NKPR_LN_MA_US == "S" || NKPR_LN_MA_US == "N" || NKPR_LN_MA_US == "P")) {
            xml += "    <cac:CommodityClassification>\n";
            xml += "      <cbc:ItemClassificationCode listID=\"CG\">" + Substring(kpd, 0, 2) + "." + Substring(kpd, 2, 2) + "." + Substring(kpd, 4, 2) + "</cbc:ItemClassificationCode>\n";
            xml += "    </cac:CommodityClassification>\n";
        }
        // Tax
        sql_taxc = "SELECT PKFK_TAX_TARIFA,pkfk_tax_p_porz,pkfk_tax_dobopc,PKFK_TAX_TIP,pkfk_tax_por1,pkfk_tax_por2 FROM " + databaseName + ".dbo.PKFKPORZ WHERE PKFK_TAX_CODE = @p1;";
        sqlParams = {};
        sqlParams.Add({"@p1", NKPR_LN_TXBLE});
        taxcRes = sqlQuery(sql_taxc, sqlParams);
        //PKFK_TAX_TARIFA = "S";
        if (Size(taxcRes) >= 2) {
            PKFK_TAX_TARIFA = taxcRes[1][0].trim();
            PKFK_TAX_P_PORZ = Substring(taxcRes[1][1], 0, 2).trim();
            PKFK_TAX_DOBOPC = Substring(taxcRes[1][2], 0, 2).trim(); //šifra izjave za oslobođenje od poreza
            PKFK_TAX_TIP = taxcRes[1][3].trim();
            PKFK_TAX_POR1 = taxcRes[1][4].trim();
            PKFK_TAX_POR2 = taxcRes[1][5].trim();
        }
        if (PKFK_TAX_TIP == ""){
            if(SUBSTRING(PKFK_TAX_TARIFA, 0, 3) == "PDV") {
                PKFK_TAX_TARIFA = "S";
                taxName = "HR:PDV" + FormatNum(NKPR_LN_PRNPR, 0, ".", formatNumOption);
            }
            elif (PKFK_TAX_TARIFA == "AE") {
                taxName = "HR:"+PKFK_TAX_TARIFA;
            }    
            else{
                PKFK_TAX_TARIFA = "E";
                taxName = "HR:"+PKFK_TAX_TARIFA;
            }    
            exemptReason = "";
            if (PKFK_TAX_DOBOPC != "" && nkpr_ln_prnpr == 0) {
                //ovaj porez ima stopu 0 i ima izjavu koju treba unijet u polje u e-računu
                //to su zapravo svi porezi koji su oslobođeni PDV-a, kategorije E,K,O,
                sql_tax_exempt= "SELECT trim(KPSY_IZ_TEXT01)+' '+trim(KPSY_IZ_TEXT02)+' '+trim(KPSY_IZ_TEXT03)+' '+trim(KPSY_IZ_TEXT04)+' '+trim(KPSY_IZ_TEXT05)" +
                        " FROM " + databaseName + ".dbo.KPSYIZKU " +
                        " WHERE @p1 = KPSY_IZ_CODE;";
                sqlParams = {};
                sqlParams.Add({"@p1", PKFK_TAX_DOBOPC});
                exemptQuery = sqlQuery(sql_tax_exempt, sqlParams);
                if (Size(exemptQuery) > 1) {
                    exemptReason =exemptQuery[1][0].trim();
                }
            }
            
            xml += "    <cac:ClassifiedTaxCategory>\n";
            xml += "      <cbc:ID>" + PKFK_TAX_TARIFA + "</cbc:ID>\n"; //BT-151
            xml += "      <cbc:Name>" + EscapeForXml(taxName) + "</cbc:Name>\n";
            xml += "      <cbc:Percent>" + FormatNum(NKPR_LN_PRNPR, 0, ".", formatNumOption) + "</cbc:Percent>\n";
            if (exemptReason != ""){
                xml += "                        <cbc:TaxExemptionReason>" + "#" + taxName +"#"+ EscapeForXml(exemptReason) + "</cbc:TaxExemptionReason>\n"; //BT-120
            }   
            taxSchemeID = "VAT";
            xml += "      <cac:TaxScheme><cbc:ID>" + taxSchemeID + "</cbc:ID></cac:TaxScheme>\n";
            xml += "    </cac:ClassifiedTaxCategory>\n";
        }elif (PKFK_TAX_TIP == "S" && PKFK_TAX_POR1 != 0 && PKFK_TAX_POR2 != 0) {
            //ovo je primjer kada imamo sastavljeni porez, neki standardni i dodano je porez na potrošnju PP
            //sme mora biti unutar istog itema!!!
            sql_taxc = "SELECT PKFK_TAX_TARIFA,pkfk_tax_p_porz,pkfk_tax_dobopc,PKFK_TAX_STOPA FROM " + databaseName + ".dbo.PKFKPORZ WHERE PKFK_TAX_CODE = @p1;";
            sqlParams = {};
            sqlParams.Add({"@p1", PKFK_TAX_POR1});
            taxcRes = sqlQuery(sql_taxc, sqlParams);
            if (Size(taxcRes) >= 2) {
                PKFK_TAX_TARIFA = taxcRes[1][0].trim();
                PKFK_TAX_P_PORZ = Substring(taxcRes[1][1], 0, 2).trim();
                PKFK_TAX_DOBOPC = Substring(taxcRes[1][2], 0, 2).trim(); //šifra izjave za oslobođenje od poreza
                PKFK_TAX_STOPA = taxcRes[1][3]; //porezna stopa
            }
            if(SUBSTRING(PKFK_TAX_TARIFA, 0, 3) == "PDV") {
                PKFK_TAX_TARIFA = "S";
                taxName = "HR:PDV" + FormatNum(PKFK_TAX_STOPA, 0, ".", formatNumOption);
            }
            xml += "    <cac:ClassifiedTaxCategory>\n";
            xml += "      <cbc:ID>" + PKFK_TAX_TARIFA + "</cbc:ID>\n"; //BT-151
            xml += "      <cbc:Name>" + EscapeForXml(taxName) + "</cbc:Name>\n";
            xml += "      <cbc:Percent>" + FormatNum(PKFK_TAX_STOPA, 0, ".", formatNumOption) + "</cbc:Percent>\n";
            taxSchemeID = "VAT";
            xml += "      <cac:TaxScheme><cbc:ID>" + taxSchemeID + "</cbc:ID></cac:TaxScheme>\n";
            xml += "    </cac:ClassifiedTaxCategory>\n";
            /*
            sql_taxc = "SELECT PKFK_TAX_TARIFA,pkfk_tax_p_porz,pkfk_tax_dobopc,PKFK_TAX_STOPA FROM " + databaseName + ".dbo.PKFKPORZ WHERE PKFK_TAX_CODE = @p1;";
            sqlParams = {};
            sqlParams.Add({"@p1", PKFK_TAX_POR2});
            taxcRes = sqlQuery(sql_taxc, sqlParams);
            if (Size(taxcRes) >= 2) {
                PKFK_TAX_TARIFA = taxcRes[1][0].trim();
                PKFK_TAX_P_PORZ = Substring(taxcRes[1][1], 0, 2).trim();
                PKFK_TAX_DOBOPC = Substring(taxcRes[1][2], 0, 2).trim(); //šifra izjave za oslobođenje od poreza
                PKFK_TAX_STOPA = taxcRes[1][3]; //porezna stopa
            }
            PKFK_TAX_TARIFA = "S";
            taxName = "PP";
            xml += "    <cac:ClassifiedTaxCategory>\n";
            xml += "      <cbc:ID>" + PKFK_TAX_TARIFA + "</cbc:ID>\n"; //BT-151
            xml += "      <cbc:Name>" + EscapeForXml(taxName) + "</cbc:Name>\n";
            xml += "      <cbc:Percent>" + FormatNum(PKFK_TAX_STOPA, 0, ".", formatNumOption) + "</cbc:Percent>\n";
            taxSchemeID = "LOC";
            xml += "      <cac:TaxScheme><cbc:ID>" + taxSchemeID + "</cbc:ID></cac:TaxScheme>\n";
            xml += "    </cac:ClassifiedTaxCategory>\n";
            */
        }

        xml += "  </cac:Item>\n";

        // Price
        xml += "  <cac:Price>\n";
        xml += "    <cbc:PriceAmount currencyID=\"EUR\">" + FormatNum(NKPR_LN_PPRCE, 4, ".", formatNumOption) + "</cbc:PriceAmount>\n";
        xml += "    <cbc:BaseQuantity unitCode=\"" + GetUNUnitCode(NKPR_LN_JEDMJ) + "\">1.00</cbc:BaseQuantity>\n";
        xml += "  </cac:Price>\n";

        if (profileID == "P9") {
            xml += "</cac:CreditNoteLine>\n"; // ???
        } elif (nkpr_gl_oznaka == 'T') {
            xml += "</cac:DebitNoteLine>\n";
        } else {
            xml += "</cac:InvoiceLine>\n";
        }

    }

    // Close root
    if (profileID == "P9") {
        xml += "</CreditNote>\n";
    } elif (nkpr_gl_oznaka == 'T') {
        xml += "</DebitNote>\n";
    } else {
        xml += "</Invoice>\n";
    }


    // -----------------------------------------------------------
    // ...Save xml BEFORE validation
    // -----------------------------------------------------------
    if(NKSC_REZ10 == "F"){
        xmlFileName = parsefile(attachmentPdfPath, "pfPath") + parsefile(attachmentPdfPath, "pfName") + ".xml";
    }elif(NKSC_REZ10 == "P"){
        xmlFileName = FILESPATH + "IR\\" + parsefile(attachmentPdfPath, "pfName") + ".xml";
    }
    
    // msg(xmlFileName);

    SaveFile(xml, xmlFileName);

    // -----------------------------------------------------------
    // 8.0. VALIDATION 
    // -----------------------------------------------------------

    // IniPath = strtrim(wpath()) + "winx.ini";
    // if(!regedit("regOpen", IniPath, "rtFile")){
    //     MessageBox("Datoteka " + IniPath + " nije dostupna.");
    //     return false;
    // }
    // SchemasPath = regedit("regReadStr", 'ERACUN', 'SchemasPath');
    // regedit("regClose");
    

    xsdValidationResultOutputFile = FILESPATH + "IR\\" + parsefile(attachmentPdfPath, "pfName") + "_XSD.err";
    schValidationResultOutputFile = FILESPATH + "IR\\" + parsefile(attachmentPdfPath, "pfName") + "_SCH.err";
    

    // -----------------------------------------------------------
    // 8.1. DELETE OLDER VALIDATION OUTPUT FILES (IF EXIST)
    // -----------------------------------------------------------
    if(Exists(xsdValidationResultOutputFile)){
        Delete(xsdValidationResultOutputFile);
    }
    
    if(Exists(schValidationResultOutputFile)){
        Delete(schValidationResultOutputFile);
    }


    // -----------------------------------------------------------
    // 8.2. XSD VALIDATION 
    // -----------------------------------------------------------
    xsdFiles = {};
    if (profileID == "P9") {
        xsdFiles.Add(SCHEMASPATH + "xsd\\maindoc\\UBL-CreditNote-2.1.xsd");
    } else {
        xsdFiles.Add(SCHEMASPATH + "xsd\\maindoc\\UBL-Invoice-2.1.xsd");
    }

    if (!ValidateXsd(xml, xsdFiles, xsdValidationResultOutputFile)) {
        // LogError("XSD_FAIL", "Validation failed for " + invNum, validationErrors);
        MessageBox("XML nije prošao XSD validaciju\n\nProvjerite _XSD.err datoteku za detalje.");
        return false;
    }

    // // signature
    // MessageBox(SignXml(xmlFileName, "C:\\temp\\cert\\p12_aurasoft_demo.p12", "Aurasoft1", SavePath + parsefile(attachmentPdfPath, "pfName") + "_signed.xml"));
    // return false;




    // -----------------------------------------------------------
    // 8.3. SCH VALIDATION 
    // -----------------------------------------------------------
    
    schFiles = {};
    schFiles.Add(SCHEMASPATH + "schematron\\HR-CIUS-EXT-EN16931-UBL.sch");
    //  schFiles.Add(SCHEMASPATH + "schematron\\preprocessed\\EN16931-UBL-validation-preprocessed.sch");
    if(!ValidateSch(xml, schFiles, SCHEMASPATH + "schematron\\transpile.xsl", schValidationResultOutputFile)){
        MessageBox("xml FAILED SCH validation\n\nSee _SCH.err file for details.");
        return false;
    }
     

    // //ako je sve prošlo bez greške, XML fajl je validiran, potpisan i poslat - u NKSYELOG treba upisati zapis o slanju, najprije status A pa konačno C
    // sql_ins = "INSERT INTO " + databaseName + ".dbo.NKSYELOG (sy_elog_date, sy_elog_num, sy_elog_status, sy_elog_person, sy_elog_estring, sy_elog_type, sy_elog_time,sy_elog_desc, sy_elog_rez3) " +
    //           "VALUES (@p1, @p2, @p3, @p4, @p5, @p6, @p7, @p8, @p9);";
    // sqlParams = {};
    // sqlParams.Add({"@p1", NKPR_GL_INVDTE});
    // sqlParams.Add({"@p2", invNum});
    // sqlParams.Add({"@p3", "A"});
    // sqlParams.Add({"@p4", userCode});
    // sqlParams.Add({"@p5", "" });
    // sqlParams.Add({"@p6", "IR"});
    // sqlParams.Add({"@p7", Now("HH:mm:ss")});
    // sqlParams.Add({"@p8", ""}); //"New Invoice/HOA Sent with attachment: " + xmlFileName});
    // sqlParams.Add({"@p9", Now("yyyy-MM-dd")});
    // sqlQuery(sql_ins, sqlParams);
    // //
    // sql_ins = "INSERT INTO " + databaseName + ".dbo.NKSYELOG (sy_elog_date, sy_elog_num, sy_elog_status, sy_elog_person, sy_elog_estring, sy_elog_type, sy_elog_time,sy_elog_desc, sy_elog_rez3) " +
    //           "VALUES (@p1, @p2, @p3, @p4, @p5, @p6, @p7, @p8, @p9);";
    // sqlParams = {};
    // sqlParams.Add({"@p1", NKPR_GL_INVDTE});
    // sqlParams.Add({"@p2", invNum});
    // sqlParams.Add({"@p3", "C"});
    // sqlParams.Add({"@p4", userCode});
    // sqlParams.Add({"@p5", "" });
    // sqlParams.Add({"@p6", "IR"});
    // sqlParams.Add({"@p7", Now("HH:mm:ss")}); 
    // sqlParams.Add({"@p8",""}); //"New Invoice/HOA Sent with attachment: " + xmlFileName});
    // sqlParams.Add({"@p9", Now("yyyy-MM-dd")});
    // sqlQuery(sql_ins, sqlParams);




    // if (Exists(path + fileName)) {
    //     MessageBox(2 + ": " + path + fileName);
    //     Copy(path + fileName, path + fileName + ".bak");
    // }
    // MessageBox(3);
    // SaveFile(xml);
    // //LogError("UBL_VALIDATED", "Generated & VALIDATED: " + fileName, "");
    // MessageBox("UBL generated & VALIDATED: " + fileName);
    return true;
}

function EscapeForXml(inputString){
    // return inputString.Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("\"", "&quot;").Replace("'", "&apos;");
    return inputString.Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;");
}

function fillInvoiceLine(lineNum){
    NKPR_LN_PQTY = linRes[lineNum][0];
    NKPR_LN_INVNM = linRes[lineNum][1];
    NKPR_LN_AMT = linRes[lineNum][2];
    NKPR_LN_PCODE = linRes[lineNum][3].trim();
    NKPR_LN_SASTAV = linRes[lineNum][4];
    NKPR_LN_PDESC = linRes[lineNum][5].trim();
    NKPR_LN_GRUPA = linRes[lineNum][6].trim();
    NKPR_LN_TXBLE = linRes[lineNum][7];
    NKPR_LN_PRNPR = linRes[lineNum][8];
    NKPR_LN_JEDMJ = linRes[lineNum][9].trim();
    NKPR_LN_PPRCE = linRes[lineNum][10];
    NKPR_LN_PEXT = linRes[lineNum][11];
    NKPR_LN_PDISC = linRes[lineNum][12];
    NKPR_LN_DISC2 = linRes[lineNum][13];
    NKPR_LN_DISC2T = linRes[lineNum][14].trim();
    NKPR_LN_DISC3 = linRes[lineNum][15];
    NKPR_LN_DISC3T = linRes[lineNum][16].trim();
    NKPR_LN_MA_US = linRes[lineNum][17].trim();
    NKPR_LN_BR_LN = linRes[lineNum][18];
    NKPR_LN_BROPI = linRes[lineNum][19];
    NKPR_LN_BROPI1 = linRes[lineNum][20];
    NKPR_LN_PSTOPA = linRes[lineNum][21];
    NKPR_LN_POPU = linRes[lineNum][22];
    NKPR_LN_POPL = linRes[lineNum][23];
    return;
}


function GetUNUnitCode(jedmj) {
    if (jedmj == "KOM") { return "H87"; }
    if (jedmj == "KG")  { return "KGM"; }
    if (jedmj == "LIT") { return "LTR"; }
    if (jedmj == "MX2") { return "MTK"; }
    if (jedmj == "MX3") { return "MTQ"; }
    if (jedmj == "TON" || jedmj == "T") { return "TNE"; }
    if (jedmj == "GR"  || jedmj == "G") { return "GRM"; }
    if (jedmj == "SAT") { return "HUR"; }
    if (jedmj == "DAN") { return "DAY"; }
    if (jedmj == "MET" || jedmj == "M") { return "MTR"; }
    if (jedmj == "KAR") { return "XCT"; }
    if (jedmj == "PAL") { return "XPB"; }
    if (jedmj == "JED") { return "C62"; }
    return "C62";
}


function GetMimeType(file) {
    ext = ParseFile(file, "pfExt").Lower(); // StrLower(string)
    if (ext == ".pdf")  { return "application/pdf"; }
    if (ext == ".doc")  { return "application/msword"; }
    if (ext == ".docx") { return "application/vnd.openxmlformats-officedocument.wordprocessingml.document"; }
    if (ext == ".xls")  { return "application/vnd.ms-excel"; }
    if (ext == ".xlsx") { return "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"; }
    if (ext == ".odt")  { return "application/vnd.oasis.opendocument.text"; }
    if (ext == ".jpg" || ext == ".jpeg") { return "image/jpeg"; }
    if (ext == ".png")  { return "image/png"; }
    return "application/octet-stream";
}


// -----------------------------------------------------------
// SLANJE ERACUNA
// -----------------------------------------------------------

function SendERacun(){
    if(PROVIDER == "MER" || PROVIDER == "MERDEMO"){
        //koristimo M.E.R. način slanja
        escapedXml = StrReplace(xml, "\n", " ");
        escapedXml = EscapeQuotesInXml(xml);
        
        jsonLoad = '{"Username": "' + ERAC_USER + '", "Password": "' + ERAC_PASS + '", "CompanyId": "' + supOIB + '"'/*uzet iz KPSYMSTR*/ + ', "SoftwareId": "' + ERAC_DESC + '", "File": "' + escapedXml + '"}';

        webRequestResult = WebRequest("POST", ERAC_SERVER + "apis/v2/send", jsonLoad, invID,
                    "MERSuccess", "MERFailure", "application/json", null, 1000 * 20, false);

        //  MSG("webRequestResult = " + webRequestResult);
    }
    elif(PROVIDER == "EPOS" || PROVIDER == "EPOSDEMO")
    {
        //koristimo ePoslovanje.hr način slanja
        SendToEPOS();
        return;
    }
    elif(PROVIDER == "FINA" || PROVIDER == "FINADEMO")
    {
        //koristimo FINA način slanja
        // za test koristimo račun "90100003"
        

        SendToFINA();
        //SendToFINA_2();
        // ...

        return;
    }
    elif(PROVIDER == "EDITEL" || PROVIDER == "EDITELDEMO"){
        //koristimo EDITEL način slanja
        MessageBox("Slanje eRačuna putem posrednika " + PROVIDER + " nije predviđeno ovim programom.");
        // SendToEDITEL();
        return;
    }
    else
    {
        MessageBox("Nepoznat tip posrednika " + ERAC_CODE + " za slanje na eRačun: " + tip);
        return;
    }    
}

// function SendToEDITEL() {
//     // Editel provider - samo spremanje XML datoteke na disk
//     try {
//         // Determine output directory based on provider configuration
//         outputPath = ERAC_SERVER;  // Use ERAC_SERVER as output directory path
//         if (PROVIDER == "EDITEL") {
//             outputPath = ERAC_SERVERT;  // Use ERAC_SERVERT for demo/test
//         }

//         if (outputPath == "") {
//             outputPath = FILESPATH + "editel\\";  // Default to subfolder in FILESPATH
//         }

//         // Ensure output directory exists
//         if (!DIR_EXISTS(outputPath)) {
//             try {
//                 MAKE_DIR(outputPath);
//             } catch (dirEx) {
//                 MessageBox("Greška pri stvaranju direktorija za Editel: " + outputPath + "\n" + dirEx);
//                 return;
//             }
//         }

//         // Generate filename with timestamp for uniqueness
//         timestamp = Now("yyyyMMdd_HHmmss");
//         editelFileName = "Invoice_" + invNum + "_" + timestamp + ".xml";
//         editelFilePath = outputPath + editelFileName;

//         // Read the XML content from the generated file
//         xmlContent = ReadFile(xmlFileName);
//         if (xmlContent == "") {
//             MessageBox("Greška pri čitanju XML datoteke za Editel.");
//             return;
//         }

//         // Save XML to Editel output location
//         SaveFile(xmlContent, editelFilePath, "");

//         // Show success message
//         MessageBox("Editel XML datoteka uspješno spremljena:\n" + editelFilePath);

//         // Optional: Log to file for audit trail (not to NKSYELOG)
//         LogEditelOperation(invNum, editelFilePath, "XML_SAVED");

//     } catch (ex) {
//         MessageBox("Greška pri radu s Editel providerom: " + ex);
//     }
// }

// // Helper function for Editel audit logging (separate from NKSYELOG)
// function LogEditelOperation(invoiceNum, filePath, operation) {
//     try {
//         if (!DIR_EXISTS(FILESPATH + "editel_logs\\")) {
//             MAKE_DIR(FILESPATH + "editel_logs\\");
//         }

//         logFilePath = FILESPATH + "editel_logs\\editel_" + Now("yyyyMM") + ".log";
//         logEntry = Now("yyyy-MM-dd HH:mm:ss") + " | " + operation + " | Invoice: " + invoiceNum + " | File: " + filePath + "\n";
        
//         SaveFile(logEntry, logFilePath, "a");  // Append mode
//     } catch (logEx) {
//         // Non-critical error, don't interrupt the main process
//         MSG("Editel logging error: " + logEx);
//     }
// }

function MERSuccess(_invID, responseCode, res) {
    // MSG("MERSuccess");

    try{
        LogResponse(responseCode, res);

        resObject = DeserializeJson(res);    
        if(Contains(resObject, "StatusId") && resObject["StatusId"] == 20){
            // MessageBox('resObject["StatusId"] == 20');

            LogNKSYELOG("A");
            LogNKSYELOG("C");

            MessageBox("Dokument poslan.");
        }
        else{
            MessageBox("GREŠKA slanja dokumenta.");

            // LogNKSYELOG("B", 'Debug: NEPOZNATA GREŠKA'); // !!!
        }

        // if(Contains(resObject, "File")){
        //     MessageBox("File = " + resObject["File"]);
        // }

        // MessageBox("ElectronicId = " + resObject["ElectronicId"]);
        // MessageBox("DocumentNr = " + resObject["DocumentNr"]);
        // MessageBox("DocumentTypeId = " + resObject["DocumentTypeId"]);
        // MessageBox("DocumentTypeName = " + resObject["DocumentTypeName"]);
        // MessageBox("StatusId = " + resObject["StatusId"]); // 20
        // MessageBox("StatusName = " + resObject["StatusName"]); // Odrađeno
        // MessageBox("RecipientBusinessNumber = " + resObject["RecipientBusinessNumber"]);
        // MessageBox("RecipientBusinessUnit = " + resObject["RecipientBusinessUnit"]);
        // MessageBox("RecipientBusinessName = " + resObject["RecipientBusinessName"]);
        // MessageBox("Created = " + resObject["Created"]);
        // MessageBox("Sent = " + resObject["Sent"]);
        // MessageBox("Modified = " + resObject["Modified"]);
        // MessageBox("Delivered = " + resObject["Delivered"]);        
    }
    catch(ex){
        MessageBox("MERSuccessException - Greška pri parsiranju odgovora poslužitelja:\n" + ex);
        // LogNKSYELOG();
    }
    
}

function MERFailure(_invID, responseCode, res) {
    MSG("MERFailure");

    try{
        LogResponse(responseCode, res);

        MSG("Slanje računa broj " + _invID + " NEUSPJEŠNO!");

        // MessageBox("SendingFailure.ResponseCode = " + responseCode);


        // resObject = DeserializeJson(res);
        // MSG(resObject);


        // MessageBox("ElectronicId = " + resObject["ElectronicId"]);
        // MessageBox("DocumentNr = " + resObject["DocumentNr"]);
        // MessageBox("DocumentTypeId = " + resObject["DocumentTypeId"]);
        // MessageBox("DocumentTypeName = " + resObject["DocumentTypeName"]);
        // MessageBox("StatusId = " + resObject["StatusId"]);
        // MessageBox("StatusName = " + resObject["StatusName"]);
        // MessageBox("RecipientBusinessNumber = " + resObject["RecipientBusinessNumber"]);
        // MessageBox("RecipientBusinessUnit = " + resObject["RecipientBusinessUnit"]);
        // MessageBox("RecipientBusinessName = " + resObject["RecipientBusinessName"]);
        // MessageBox("Created = " + resObject["Created"]);
        // MessageBox("Sent = " + resObject["Sent"]);
        // MessageBox("Modified = " + resObject["Modified"]);
        // MessageBox("Delivered = " + resObject["Delivered"]);        
    }
    catch(ex){
        MessageBox("MERFailureException - Greška pri parsiranju odgovora poslužitelja:\n" + ex);
    }
}

logFilePath = "";

function LogResponse(responseCode, response) 
{
    if(!DIR_EXISTS(FILESPATH + "IR\\" + "responses\\"))
    {
        MAKE_DIR(FILESPATH + "IR\\" + "responses\\");
    }
    logFilePath = FILESPATH + "IR\\" + "responses\\" + parsefile(attachmentPdfPath, "pfName") + ".response"; //FILESPATH + "responses\\" + parsefile(attachmentPdfPath, "pfName") + ".response";
// messageBox("Logging response to file: " + logFilePath);
    
    appendText = Now("yyyy-MM-dd HH:mm:ss") + " -----------------------------------\n\n" + "StatusCode = " + responseCode + "\n\n" + "Response:\n" + response + "\n\n";
// messageBox("Log text: " + appendText);
    try {
        SaveFile(appendText, logFilePath, "a");        
    } catch (ex) {
        MessageBox("CRITICAL: Cannot write to log file: " + logFilePath + "\nError: " + ex);
    }
}

function LogException(exText) 
{
    if(!DIR_EXISTS(FILESPATH + "IR\\" + "responses\\"))
    {
        MAKE_DIR(FILESPATH + "IR\\" + "responses\\");
    }
    logFilePath = FILESPATH + "IR\\" + "responses\\" + parsefile(attachmentPdfPath, "pfName") + ".response"; //FILESPATH + "responses\\" + parsefile(attachmentPdfPath, "pfName") + ".response";
    // messageBox("Logging response to file: " + logFilePath);
    
    appendText = Now("yyyy-MM-dd HH:mm:ss") + " -----------------------------------\n\n" + "Exception = " + exText + "\n\n";
    // messageBox("Log text: " + appendText);
    try {
        SaveFile(appendText, logFilePath, "a");        
    } catch (ex) {
        MessageBox("CRITICAL: Cannot write to log file: " + logFilePath + "\nError: " + ex);
    }
}



function SendToFINA_2() {

    endpoint = ERAC_SERVER + "SendB2BOutgoingInvoicePKIWebService/services/SendB2BOutgoingInvoicePKIWebService";


    base64Ubl = File2Base64(xmlFileName);

    bodyId = "id-" + UUID();
    messageId = "msg-" + UUID();

    soapEnvelope = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n";
    soapEnvelope += "<SOAP-ENV:Envelope xmlns:SOAP-ENV=\"http://schemas.xmlsoap.org/soap/envelope/\"
                   xmlns:wsu=\"http://schemas.xmlsoap.org/ws/2002/12/utility\"
                   xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"
                   xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n";
    soapEnvelope += "  <SOAP-ENV:Header/>\n";
    soapEnvelope += "  <SOAP-ENV:Body Id=\"Body\"
                   d2p1:Id=\"Body\"
                   wsu:Id=\"" + bodyId + "\"
                   xmlns:d2p1=\"http://schemas.xmlsoap.org/ws/2002/12/utility\"
                   xmlns:util=\"http://schemas.xmlsoap.org/ws/2002/12/utility\"
                   xmlns:wsu=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd\">\n";

    soapEnvelope += "    <fin:SendB2BOutgoingInvoiceMsg>\n";
    soapEnvelope += "      <HeaderSupplier>\n";
    soapEnvelope += "        <MessageID>" + messageId + "</MessageID>\n";
    soapEnvelope += "        <SupplierID>9934:" + supOIB + "</SupplierID>\n";
    // soapEnvelope += "        <AdditionalSupplierID>0088:" + KPSY_REZERVAX + "</AdditionalSupplierID>\n";
    soapEnvelope += "        <MessageType>9001</MessageType>\n";
    soapEnvelope += "      </HeaderSupplier>\n";
    soapEnvelope += "      <Data>\n";
    soapEnvelope += "        <B2BOutgoingInvoiceEnvelope>\n";
    soapEnvelope += "          <XMLStandard>UBL</XMLStandard>\n";
    /* // !!!
    SpecificationIdentifier - Prilagodba XML dokumenta:
    "urn:cen.eu:en16931:2017"
    ili
    "urn:cen.eu:en16931:2017#compliant#urn:fdc:peppol.eu:2017:poacc:billing:3.0"
    */
    soapEnvelope += "          <SpecificationIdentifier>urn:cen.eu:en16931:2017#compliant#urn:mfin.gov.hr:cius-2025:1.0</SpecificationIdentifier>\n";
    soapEnvelope += "          <SupplierInvoiceID>" + invID + "</SupplierInvoiceID>\n";
    soapEnvelope += "          <BuyerID>9934:" + NKPR_GL_JMBG + "</BuyerID>\n";
    // soapEnvelope += "          <BuyerID>9934:" + "82113036885" + "</BuyerID>\n"; // !!! FINA-in OIB
    
    soapEnvelope += "          <InvoiceEnvelope>" + base64Ubl + "</InvoiceEnvelope>\n";
    // ILI
    // soapEnvelope += "          <CreditNoteEnvelope>" + base64Ubl + "</CreditNoteEnvelope>\n";

    soapEnvelope += "        </B2BOutgoingInvoiceEnvelope>\n";
    soapEnvelope += "      </Data>\n";
    soapEnvelope += "    </fin:SendB2BOutgoingInvoiceMsg>\n";

    soapEnvelope += "  </SOAP-ENV:Body>\n";
    soapEnvelope += "</SOAP-ENV:Envelope>";

    // MSG("AAAA: SOAP Envelope prepared for FINA:\n\n" + soapEnvelope);
    //Test99();
    //exit;


    // Sign SOAP with client certificate (WS-Security)
    signedSoap = SignSoapWithCert(soapEnvelope, ERAC_PASST, ERAC_PASS);
    // MSG("BBBB: Signed SOAP for FINA:\n\n" + signedSoap);

    // if (signedSoap == "") {
    //     LogError("FINA_SIGN_FAIL", "SOAP signing failed", "");
    //     return false;
    // }

    headers = {};
    headers["Content-Type"] = "text/xml; charset=utf-8";
    // headers["SOAPAction"] = "";

    try {
        response = WebRequest(
            "POST",                     // method
            endpoint,                   // URL
            signedSoap,                 // load
            invID,                     // trackingId
            "FINASuccess",              // OnSuccess
            "FINAFailure",              // OnFailure
            "text/xml; charset=utf-8",  // contentType
            headers,                    // headers dictionary
            1000 * 30,                  // timeout (30 seconds)
            false                       // justFire
        );
        // SaveResponseLog(response, "FINA");
    MSG("CCCC: Response from FINA:\n\n" + response);

        // ackStatus = ExtractXML(response, "AckStatus");
        // zki = ExtractXML(response, "ZKI");
        // jir = ExtractXML(response, "JIR");

        // if (ackStatus == "10") {  // ACCEPTED
        //     LogError("FINA_OK", "Invoice accepted", "ZKI=" + zki + " JIR=" + jir);
        //     return true;
        // } else {
        //     errorMsg = ExtractXML(response, "ErrorMessage");
        //     LogError("FINA_REJECT", "Invoice rejected", "Status=" + ackStatus + " Msg=" + errorMsg);
        //     return false;
        // }
    } catch (ex) {
        // LogError("FINA_EXCEPTION", "WebRequest failed", ex);
        // return false;
    }
}



function SendToEPOS() {
    MessageBox("Slanje na EPOS nije implementirano.");
    return;




    // Determine endpoint based on provider configuration
    endpoint = ERAC_SERVER;
    if (PROVIDER == "EPOSDEMO") {
        endpoint = ERAC_SERVER;
    }

    if (endpoint == "") {
        MessageBox("Endpoint za ePoslovanje provider nije definiran u NKSYERAC.");
        return;
    }

    // Read the XML file content
    xmlContent = ReadFile(xmlFileName);
    if (xmlContent == "") {
        MessageBox("Greška pri čitanju XML datoteke za ePoslovanje.");
        return;
    }

    // Prepare JSON payload for ePoslovanje API v2
    // Using DocumentSendRequest schema from API documentation
    jsonPayload = {
        "document": xmlContent,
        "softwareId": ERAC_DESC
    };

    jsonLoad = SerializeJson(jsonPayload);

    // Prepare headers with API key authentication
    headers = {};
    headers["Authorization"] = ERAC_USER; // API Key stored in ERAC_USER field
    headers["Content-Type"] = "application/json";

    try {
        // Send to ePoslovanje API v2 document send endpoint
        webRequestResult = WebRequest(
            "POST",                         // method
            endpoint + "/api/v2/document/send",  // URL with API v2 endpoint
            jsonLoad,                       // JSON payload
            invID,                         // tracking ID
            "EPOSSuccess",                  // success callback
            "EPOSFailure",                  // failure callback
            "application/json",             // content type
            headers,                        // headers with API key
            1000 * 30,                      // 30 second timeout
            false                           // not fire-and-forget
        );
    } catch (ex) {
        MessageBox("Greška pri slanju na ePoslovanje: " + ex);
        LogNKSYELOG("B", "EPOS WebRequest exception: " + ex);
    }
}


function SendToFINA() {
    
    // // TEST ECHO CALL
    // try {
    //     MSG("izvršavam ECHO test prema FINA-i putem WSDL-a!");

    //     ack = FINA_B2B_ECHO(
    //         ERAC_SERVER + "SendB2BOutgoingInvoicePKIWebService/services/SendB2BOutgoingInvoicePKIWebService",
    //         ERAC_DESC, // "e-invoice" / NE "e-racun-winx" !
    //         ERAC_USERT, // servisni certifikat
    //         ERAC_PASST, // p12 certifikat (klijentski)
    //         ERAC_PASS, // password za p12 certifikat
    //         "9500095", // ERPID

    //         UUID(), // messageId
    //         "ECHO TEXT STRING.............", // echoText
    //         supOib // supplierOib
    //     );
    //     MSG("ack = " + ack);

    //     if(ack["AckStatusCode"] == 10){
    //         MessageBox("Uspješan ECHO test prema FINA-i!");
    //     }
    // }catch(ex){
    //     MessageBox("Nepoznata greška:\n" + ex);
    //     LogException(ex);
    // }
    


    // SEND RAČUN
    try {
        // MSG("šaljem račun!\nKoristim WSDL!");

        
        if (profileID == "P9") {
            invoiceOrCreditNote = "CreditNote";
        } else {
            invoiceOrCreditNote = "Invoice";
        }
        // invoiceOrCreditNote = "CreditNote"; // TEST !!!

        // Msg("Slanje " + invoiceOrCreditNote + " na FINA-u putem WSDL-a...");
        
        ack = FINA_SEND_B2B_OUTGOING_INVOICE(
            ERAC_SERVER + "SendB2BOutgoingInvoicePKIWebService/services/SendB2BOutgoingInvoicePKIWebService",
            ERAC_DESC, // "e-invoice" / NE "e-racun-winx" !
            ERAC_USERT, // servisni certifikat
            ERAC_PASST, // p12 certifikat (klijentski)
            ERAC_PASS, // password za p12 certifikat
            "9500095", // ERPID

            UUID(), // messageId
            "9934:" + supOib, // supplierId
            "9934:" + NKPR_GL_JMBG, // buyerId // "9934:" + "82113036885" FINA-in OIB
            invID, // supplierInvoiceId
            invoiceOrCreditNote, // itemType -> Invoice ili CreditNote
            xmlFileName // unsignedXmlPath
        );
        // MSG("ack = " + ack);
        responseCode= 'AAQQ';
        LogResponse(responseCode, ack);
 
        if(ack["AckStatusCode"] == 10){
            // MessageBox("Uspješno poslan RAČUN prema FINA-i!");

            // MSG("ack[\"Correct\"] = " + ack["Correct"]);
            if(ack["Correct"]){
                LogNKSYELOG("A");
                LogNKSYELOG("C");

                // ako TAS ne čeka odgovor onda CSCS mora upisat status i datum u NKPRINV !!

                MSG("Uspješno poslan dokument.\n" + "Šifra računa kod FINA-e (ack[\"InvoiceID\"]) = " + ack["InvoiceID"]);
            }else{
                MSG("ack[\"ErrorCode\"] = " + ack["ErrorCode"]);
                MSG("ack[\"ErrorMessage\"] = " + ack["ErrorMessage"]);
            }
        }else{
            MessageBox("AckStatusText = " + ack["AckStatusText"]);
            // MessageBox("NEUSPJEŠNO poslan RAČUN prema FINA-i!");
        }
    }catch(ex){
        MessageBox("Nepoznata greška:\n" + ex);
        LogException(ex);
    }
    

    // // GET STATUS RAČUNA
    // try {
    //     MSG("provjeravam status računa putem WSDL-a!");

    //         ack = FINA_GET_B2B_OUTGOING_INVOICE_STATUS(
    //         ERAC_SERVER + "SendB2BOutgoingInvoicePKIWebService/services/SendB2BOutgoingInvoicePKIWebService",
    //         ERAC_DESC, // "e-invoice" / NE "e-racun-winx" !
    //         ERAC_USERT, // servisni certifikat
    //         ERAC_PASST, // p12 certifikat (klijentski)
    //         ERAC_PASS, // password za p12 certifikat
    //         "9500095", // ERPID

    //         UUID(),
    //         "9934:" + supOib, // supplierId
    //         invID, // supplierInvoiceId
    //         "2024" // invoiceYear
    //     );
    //     MSG("ack = " + ack);

    //     for(i = 0; i < Size(ack["DocumentStatuses"]); i++){
    //         MSG("ack[\"DocumentStatuses\"][" + i + "] = " + ack["DocumentStatuses"][i]);
    //     }

    //     // StatusText = ack["DocumentStatuses"][0]["StatusText"];
    //     // MSG(StatusText);

    // }catch(ex){
    //     MessageBox("Nepoznata greška:\n" + ex);
    //     LogException(ex);
    // }





    // // TEST FINA eIzvjestavanje
    // try {
    //     // MSG("Izvještavam na eIzvještavanje putem FINA WSDL-a!");

    //     //     ack = FINA_SEND_B2B_OUTGOING_INVOICE_REPORTING(
    //     //     ERAC_SERVER + "SendB2BOutgoingInvoicePKIWebService/services/SendB2BOutgoingInvoicePKIWebService",
    //     //     ERAC_DESC, // "e-invoice" / NE "e-racun-winx" !
    //     //     ERAC_USERT, // servisni certifikat
    //     //     ERAC_PASST, // p12 certifikat (klijentski)
    //     //     ERAC_PASS, // password za p12 certifikat
            
    //     //     UUID(),
    //     //     "9934:" + supOib, // supplierId
    //     //     invID, // supplierInvoiceId
    //     //     "2024" // invoiceYear
    //     // );
    //     // MSG("ack = " + ack);

    //     // // for(i = 0; i < Size(ack["DocumentStatuses"]); i++){
    //     // //     MSG("ack[\"DocumentStatuses\"][" + i + "] = " + ack["DocumentStatuses"][i]);
    //     // // }

    //     // // // StatusText = ack["DocumentStatuses"][0]["StatusText"];
    //     // // // MSG(StatusText);

    // }catch(ex){
    //     MessageBox("Nepoznata greška:\n" + ex);
    //     LogException(ex);
    // }


    return;










//     if (ERAC_SERVER == "") {
//         MessageBox("Endpoint za FINA provider nije definiran u NKSYERAC.");
//         return;
//     }

//     // Determine endpoint based on provider configuration
//     endpoint = ERAC_SERVER + "SendB2BOutgoingInvoicePKIWebService/services/SendB2BOutgoingInvoicePKIWebService";
    

//     // 1. Prepare the XML body for the SOAP request
//     base64Ubl = File2Base64(xmlFileName);
// MessageBox("1111" + ": base64Ubl length = " + base64Ubl.Length);
//     uuid = UUID();
//     buyerOIB= "85821130368"; // !!! FINA-in OIB 

//     xmlBody = "<SendB2BOutgoingInvoiceMsg xmlns='http://fina.hr/eracun/b2b/pki/SendB2BOutgoingInvoice/v0.1'>\n";
//     xmlBody += "  <HeaderSupplier xmlns='http://fina.hr/eracun/b2b/invoicewebservicecomponents/v0.1'>\n";
//     xmlBody += "    <MessageID>" + uuid + "</MessageID>\n";
//     xmlBody += "    <SupplierID>9934:" + supOIB + "</SupplierID>\n";
//     xmlBody += "    <MessageType>9001</MessageType>\n";
//     xmlBody += "  </HeaderSupplier>\n";
//     xmlBody += "  <Data>\n";
//     xmlBody += "    <B2BOutgoingInvoiceEnvelope>\n";
//     xmlBody += "      <XMLStandard>UBL</XMLStandard>\n";
//      //xmlBody += "      <SpecificationIdentifier>urn:cen.eu:en16931:2017#compliant#urn:mfin.gov.hr:cius-2025:1.0#conformant#urn:mfin.gov.hr:ext-2025:1.0</SpecificationIdentifier>\n";
//     xmlBody += "         <SpecificationIdentifier>urn:cen.eu:en16931:2017#compliant#urn:mfin.gov.hr:cius-2025:1.0</SpecificationIdentifier>\n";
//     xmlBody += "      <SupplierInvoiceID>" + invID + "</SupplierInvoiceID>\n";
//     xmlBody += "      <BuyerID>9934:" + buyerOIB + "</BuyerID>\n"; // !!! tu je sada OIB od FINA-e
//     xmlBody += "      <InvoiceEnvelope>" + base64Ubl + "</InvoiceEnvelope>\n";
//     xmlBody += "    </B2BOutgoingInvoiceEnvelope>\n";
//     xmlBody += "  </Data>\n";
//     xmlBody += "</SendB2BOutgoingInvoiceMsg>\n";

//     // 2. Define the SOAPAction (often empty for FINA services)
//     soapAction = "";
// MessageBox("2222" + ": Prepared XML Body for FINA:\n\n" + xmlBody);
//     // 3. Call the unified CreateSOAP function
//     try {
//         msg(CreateAndSendSOAPMsg(xmlBody, soapAction, endpoint, ERAC_PASST, ERAC_PASS, 60));
//         msg("exiting");
//         exit;

//         // CreateSOAP handles signing and sending the request, and returns the response.
//         // It expects: xmlBody, soapAction, endpoint, certIdentifier, certPassword
// MessageBox("3333" + ": Calling CreateSOAP... : "+soapAction+".... "+endpoint+".... "+ERAC_PASST+".... "+ERAC_PASS);
//         response = CreateSOAP(
//             xmlBody,
//             soapAction,
//             endpoint,
//             ERAC_PASST, // Certificate path from NKSYERAC
//             ERAC_PASS,   // Certificate password from NKSYERAC
//             60
//         );

//         MSG(response);

//         // // 4. Process the response
//          if (response.StartsWith("ERROR:") || response.StartsWith("HTTP_ERROR:") || response.StartsWith("EXCEPTION:")) {
//              FINAFailure(invID, 0, response);
//          } else {
//              FINASuccess(invID, 200, response);
//          }
//     } catch (ex) {
//         FINAFailure(invID, 0, "Greška pri pozivu CreateSOAP funkcije: " + ex);
//     }
}

function EPOSSuccess(_invID, responseCode, res) {
    MSG("EPOSSuccess");

    try {
        LogResponse(responseCode, res);

        resObject = DeserializeJson(res);
        
        // ePoslovanje API v2 returns DocumentSendResponse
        if (Contains(resObject, "id") && Contains(resObject, "insertedOn")) {
            documentId = resObject["id"];
            insertedOn = resObject["insertedOn"];
            message = Contains(resObject, "message") ? resObject["message"] : "Dokument uspješno poslan";
            
            MSG("ePoslovanje Document ID: " + documentId);
            MSG("Inserted On: " + insertedOn);
            MSG("Message: " + message);
            
            // Log successful sending
            LogNKSYELOG("A", "EPOS Success - Doc ID: " + documentId);
            LogNKSYELOG("C", "EPOS Success - Doc ID: " + documentId);
            
            // Optional: Store document ID for future reference
            StoreEPOSDocumentId(_invID, documentId, insertedOn);
        }
        else {
            MSG("ePoslovanje response structure unexpected");
            LogNKSYELOG("B", "EPOS Success but unexpected response structure");
        }
    }
    catch (ex) {
        MessageBox("EPOSSuccess - Greška pri parsiranju odgovora poslužitelja:\n" + ex);
        LogNKSYELOG("B", "EPOS Success parsing error: " + ex);
    }
}

function EPOSFailure(_invID, responseCode, res) {
    MSG("EPOSFailure");

    try {
        LogResponse(responseCode, res);

        MSG("Slanje računa broj " + _invID + " na ePoslovanje NEUSPJEŠNO!");
        MSG("Response Code: " + responseCode);

        // Try to parse error response
        if (res != "") {
            try {
                resObject = DeserializeJson(res);
                
                // ePoslovanje API v2 ErrorResponse structure
                if (Contains(resObject, "error")) {
                    errorMsg = resObject["error"];
                    details = Contains(resObject, "details") ? resObject["details"] : "";
                    
                    MSG("ePoslovanje Error: " + errorMsg);
                    if (details != "") {
                        MSG("Error Details: " + details);
                    }
                    
                    LogNKSYELOG("B", "EPOS Error: " + errorMsg + (details != "" ? " - " + details : ""));
                    MessageBox("Greška ePoslovanje:\n" + errorMsg + (details != "" ? "\n\nDetalji: " + details : ""));
                }
                else {
                    MSG("ePoslovanje error response format unknown");
                    LogNKSYELOG("B", "EPOS unknown error format: " + res);
                    MessageBox("Nepoznata greška ePoslovanje:\n" + res);
                }
            }
            catch (parseEx) {
                MSG("Cannot parse ePoslovanje error response: " + parseEx);
                LogNKSYELOG("B", "EPOS error parsing failed: " + parseEx);
                MessageBox("Greška ePoslovanje (unparseable):\n" + res);
            }
        }
        else {
            MSG("ePoslovanje error with empty response");
            LogNKSYELOG("B", "EPOS error with empty response, code: " + responseCode);
            MessageBox("ePoslovanje greška bez odgovora. Status kod: " + responseCode);
        }
    }
    catch (ex) {
        MessageBox("EPOSFailure - Greška pri obradi neuspjeha:\n" + ex);
        LogNKSYELOG("B", "EPOS Failure processing error: " + ex);
    }
}

// Helper function to store ePoslovanje document ID for future reference
function StoreEPOSDocumentId(invoiceNum, documentId, insertedOn) {
    try {
        sqlQueryString = "UPDATE " + databaseName + ".dbo.NKPRINV SET NKPR_EPOS_ID = @p1, NKPR_EPOS_DATE = @p2 WHERE NKPR_GL_NUM = @p3";
        sqlParams = {};
        sqlParams.Add({"@p1", documentId});
        sqlParams.Add({"@p2", insertedOn});
        sqlParams.Add({"@p3", invoiceNum});
        
        sqlQuery(sqlQueryString, sqlParams);
        MSG("ePoslovanje document ID stored in database");
    }
    catch (ex) {
        MSG("Warning: Could not store ePoslovanje document ID: " + ex);
        // Non-critical error, continue processing
    }
}

// function FINASuccess(_invID, responseCode, res) {
//     MSG("FINASuccess");

//     // Check if the response from FINA is successful but empty.
//     // This is expected behavior for this specific web service.
//     if (res == null || res.Trim() == "") {
//         res = "FINA server returned HTTP 200 OK with an empty body. This indicates the request was accepted for processing.";
//         LogNKSYELOG("A", "FINA request accepted (empty response).");
//         LogNKSYELOG("C", "FINA request accepted (empty response).");
//     } else {
//         LogNKSYELOG("A", "FINA request accepted (empty response).");
//         LogNKSYELOG("C", "FINA request successful.");
//     }

//     LogResponse(responseCode, res);
// }

// function FINAFailure(_invID, responseCode, res) {
//     MSG("FINAFailure");

//     LogResponse(responseCode, res);
// }






// -----------------------------------------------------------
// ERROR LOGGING
// -----------------------------------------------------------

function LogNKSYELOG(elogStatusCode, description = ""){
    sqlQueryString = "INSERT INTO " + databaseName + ".dbo.NKSYELOG 
    (sy_elog_num, sy_elog_date, sy_elog_status, sy_elog_person, sy_elog_estring, sy_elog_type, sy_elog_time, sy_elog_desc, sy_elog_rez3)
    VALUES (@p1, @p2, @p3, @p4, @p5, @p6, @p7, @p8, @p9);";

    sqlParams = {};
    sqlParams.Add({"@p1", NKPR_GL_NUM});
    sqlParams.Add({"@p2", NKPR_GL_INVDTE});
    sqlParams.Add({"@p3", elogStatusCode.Upper()});
    sqlParams.Add({"@p4", userCode});
    sqlParams.Add({"@p5", "" });
    sqlParams.Add({"@p6", "IR"});
    sqlParams.Add({"@p7", Now("HH:mm:ss")});
    sqlParams.Add({"@p8", description});
    sqlParams.Add({"@p9", Now("yyyy-MM-dd")});
    sqlQuery(sqlQueryString, sqlParams);
    return;
}

/*

//error logging

// // ---------------------------------------------------------------
// // Comprehensive Error Logging System for UBL Generation
// // ---------------------------------------------------------------
// function LogError(context, message, exception = "") {
//     logPath = "fiskal_error.log";
//     timestamp = FormatDate(Now(), "yyyy-MM-dd HH:mm:ss");
//     logLine = timestamp + " | " + context + " | " + message;
//     if (exception != "") {
//         logLine += " | Exception: " + exception;
//     }
//     logLine += "\r\n";
 
//     try {
//         SaveFile(logPath, logLine); ovo mi se čini da ni u sintaxi ali imamo i append
//     } catch (e) {
//         MessageBox("CRITICAL: Cannot write to log file: " + logPath + "\nError: " + e);
//     }
// }
 
//Primjer :
// LogError("INPUT", "Invalid invoice number", "invNum=" + invNum);
 
//I datoteke:
 
2025-11-06 23:05:11 | START | Generating UBL for invoice | invNum=90100002
2025-11-06 23:05:12 | DB_HEADER_RETRY | Attempt 1 failed | Connection timeout
2025-11-06 23:05:13 | LINE_PROCESS | Failed line 3 | Null reference
2025-11-06 23:05:14 | SUCCESS | UBL generated | UBL_90100002.xml

*/

/*

// ===============================================================
// ePOSLOVANJE PROVIDER CONFIGURATION SETUP GUIDE
// ===============================================================
//
// To set up ePoslovanje.hr as a provider, you need to configure:
//
// 1. NKSYSYCO table - Set provider type:
//    INSERT INTO NKSYSYCO (NKSYS_MODUL, NKSYS_GRUP, NKSYS_FIELD, NKSYS_VALUE)
//    VALUES ('WKSY', 'ERACUN', 'PROVIDER', 'EPOS');
//    -- For test environment use 'EPOSDEMO'
//
// 2. NKSYERAC table - Set endpoint and API key:
//    INSERT INTO NKSYERAC (
//        ERAC_CODE, ERAC_SERVER, ERAC_SERVERT, ERAC_USER, ERAC_PASS, ERAC_DESC
//    ) VALUES (
//        'EPOS',                                    -- Provider code
//        'https://eracun.eposlovanje.hr',          -- Production endpoint
//        'https://test.eposlovanje.hr',             -- Test endpoint
//        'your-api-key-here',                       -- API Key (získať z ePoslovanje.hr)
//        '',                                        -- Password not needed for API key auth
//        'YOUR-SOFTWARE-ID'                         -- Software identifier
//    );
//
// ePoslovanje API v2 Endpoints:
// - Production: https://eracun.eposlovanje.hr/api/v2/document/send
// - Test: https://test.eposlovanje.hr/api/v2/document/send
//
// API Key Authentication:
// - Register at: https://eracun.eposlovanje.hr/client/register (production)
//                https://test.eposlovanje.hr/client/register (test)
// - Get API key from account settings or via API
// - Store API key in ERAC_USER field
//
// Pricing (as of 2025):
// - 0.08 EUR + VAT per invoice
// - Prepaid: minimum 4.00 EUR + VAT (valid for 6 months)
// - Postpaid: 4.00 EUR + VAT monthly (includes 50 invoices)
//
// Features included:
// - Automatic fiscalization 2.0 for outgoing documents
// - eReporting to tax authorities
// - Archive of sent/received invoices (free)
// - Interconnection with other providers (FINA, Hrvatski Telekom, etc.)
//
// Database Schema Extensions (optional):
// ALTER TABLE NKPRINV ADD NKPR_EPOS_ID VARCHAR(50);    -- ePoslovanje document ID
// ALTER TABLE NKPRINV ADD NKPR_EPOS_DATE VARCHAR(50);  -- Insertion timestamp
//
// Testing:
// 1. Set PROVIDER to 'EPOSDEMO' in NKSYSYCO
// 2. Register test account at https://test.eposlovanje.hr/client/register
// 3. Configure NKSYERAC with test endpoint and API key
// 4. Send test invoices to Test d.o.o. (OIB: 50930104221)
//
// ===============================================================

*/



