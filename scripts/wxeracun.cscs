Import(strTrim(mpath()) + "CSCS.Math.dll");

args = CommandLineArgs(); 
if(Size(args) > 2){
    companyCode = args[2]; // e.g. Y3
    CoSet(companyCode);

    if(Size(args) > 3){
        userCode = args[3]; // e.g. ANA

        if(Size(args) > 4){
            invNum = args[4]; // e.g. 90100002

            if(Size(args) > 5){
                attachmentPdfPath = args[5]; // e.g. C:\Temp\90100002.pdf
            }else{
                attachmentPdfPath = "";
            }
        }else{
            MessageBox("Nedostaje broj računa u argumentima.");
            exit;
        }
    }else{
        MessageBox("Nedostaje user code u argumentima.");
        exit;
    }
}else{
    companyCode = Substring(CoGet(), 1, 2);
}



// NKSYCCYR
sqlQueryString = "select SY_CC_USER, SY_CC_DBASE from " + strtrim(CommonDBGet()) + ".dbo.NKSYCCYR WHERE SY_CC_CODE = '" + companyCode + "'";
try
{
    sqlResult = sqlQuery(sqlQueryString);
}
catch(exc)
{
    MessageBox("NKSYCCYR reading error: " + exc);
    exit;
}
if (size(sqlResult) > 1)
{
    // imeFirme = sqlResult[1][0].trim(); // KAMEND
    // ovagod_h = sqlResult[1][1].trim(); // 2022
    SY_CC_USER = sqlResult[1][0].trim(); // KAMEND
    databaseName = sqlResult[1][1].trim(); // ime baze
}    
  


// KPSYMSTR
sqlQueryString = " SELECT TOP 1 KPSY_REZERVA, KPSY_COMP_NAME, KPSY_COMP_ADD1, KPSY_GL_RETEARN, KPSY_COMP_CSZ, KPSY_COMP_ZIP,
                KPSY_COMP_JMBFI, KPSY_COMP_PHONE, KPSY_COMP_EMAIL, KPSY_PO_FREIGHT, KPSY_REZERVAX
                    FROM " + databaseName + ".dbo.KPSYMSTR";
try
{
    sqlResult = sqlQuery(sqlQueryString);
}
catch(exc)
{
    MessageBox("KPSYMSTR reading error: " + exc);
    exit;
}
if (size(sqlResult) > 1)
{
    // proslaGodina = (int(ovagod_h) - 1);
    // nazivFirme = sqlResult[1][0].trim();
    // kpsy_po_freight= sqlResult[1][1].trim();
    // fiscal_yr = sqlResult[1][2];
    // local = sqlResult[1][3];

    KPSY_REZERVA = sqlResult[1][0].trim();
    KPSY_COMP_NAME = sqlResult[1][1].trim();
    KPSY_COMP_ADD1 = sqlResult[1][2].trim();
    KPSY_GL_RETEARN = sqlResult[1][3].trim();
    KPSY_COMP_CSZ = sqlResult[1][4].trim();
    KPSY_COMP_ZIP = sqlResult[1][5];
    KPSY_COMP_JMBFI = sqlResult[1][6].trim();
    KPSY_COMP_PHONE = sqlResult[1][7].trim();
    KPSY_COMP_EMAIL = sqlResult[1][8].trim();
    KPSY_PO_FREIGHT = substring(sqlResult[1][9], 0, 2).trim();
    KPSY_REZERVAX = sqlResult[1][10].trim(); // Supplier GLN

    supOIB = Substring(KPSY_REZERVA, 0, 13); // ??? a ča ne 11(OIB) znakova ?? ili 13(JMBG) + trim() ??
    supOIBParts = supOIB.split(" ");
    supOIB = supOIBParts[0];
} 



// NKSYSYCO
sqlQueryString = " SELECT NKSYS_FIELD, NKSYS_VALUE 
    FROM " + databaseName + ".dbo.NKSYSYCO 
    WHERE NKSYS_MODUL = 'WKSY'
    AND NKSYS_GRUP = 'ERACUN'";
try
{
    sqlResult = sqlQuery(sqlQueryString);
}
catch(exc)
{
    MessageBox("NKSYSYCO reading error: " + exc);
    exit;
}
if (size(sqlResult) > 1)
{
    for(i = 1; i < Size(sqlResult); i++){
        if(sqlResult[i][0].trim() == "FILESPATH"){
            FILESPATH = sqlResult[i][1].trim();
        }
        elif(sqlResult[i][0].trim() == "PROVIDER")
        {
            PROVIDER = sqlResult[i][1].trim().Upper();
        }elif(sqlResult[i][0].trim() == "SCHEMASPATH")
        {
            SCHEMASPATH = sqlResult[i][1].trim();
        }
    }
} 

xmlFileName = "";

// generate xml
if(!GenerateUBLXml()){
    MessageBox("Greška pri generiranju UBL XML-a za račun " + invNum + "!");    
    exit;
}else{
    LogNKSYELOG("A");
}

//send xml
SendERacun();  
exit;



//-----------------------------------------------------------
// XML GENERATION 
//-----------------------------------------------------------

function GenerateUBLXml() {
    
    // -----------------------------------------------------------
    // 1. Load Header
    // -----------------------------------------------------------
    
    sql_hdr = "SELECT
                NKPR_GL_NUM, NKPR_GL_OZNAKA, NKPR_GL_BROTP, NKPR_GL_REZ1, NKPR_GL_REZ3,
                CONVERT(VARCHAR(10), NKPR_GL_INVDTE, 23) as NKPR_GL_INVDTE,
                CONVERT(VARCHAR(8), NKPR_GL_TIMECR, 20) as NKPR_GL_TIMECR,
                CONVERT(VARCHAR(10), NKPR_GL_DVO, 23) as NKPR_GL_DVO,
                NKPR_GL_NOKAM, NKPR_GL_ROKPL,
                CONVERT(VARCHAR(10), NKPR_GL_ESD, 23) as NKPR_GL_ESD,
                NKPR_GL_PICTHDR, NKPR_GL_PICTFTR, NKPR_GL_CUSNME, NKPR_GL_JMBG,
                NKPR_GL_CUSA1, NKPR_GL_RO, NKPR_GL_CUSCTY, NKPR_GL_CUSZIP, NKPR_GL_DRZAVA, NKPR_GL_SIF_PL, NKPR_GL_MODEL,
                NKPR_GL_POZIV, NKPR_GL_RZRVA1, NKPR_GL_TOTAL, NKPR_GL_CUSORD, NKPR_GL_CUSST,
                NKPR_GL_ENTBY, NKPR_GL_BROPIS, NKPR_GL_BROPIS1,
                CONVERT(varchar(10), DATEADD(DAY, NKPR_GL_NOKAM + NKPR_GL_ROKPL, NKPR_GL_DVO), 23) as NKPR_GL_DUE_DATE,
                NKPR_GL_SCONTO,NKPR_GL_DANSC,NKPR_GL_REZ3,NKPR_GL_SHPCOD, NKPR_GL_SHPNME, NKPR_GL_SHPRO, NKPR_GL_SHPA1, 
                NKPR_GL_SHPZIP, NKPR_GL_SHPCTY,NKPR_GL_SHPST, SUBSTRING(NKSP_AD_REZ,37,13) as NKSP_AD_GLN,
                NKSC_SOP, NKSC_POSREDNIK
                FROM " + databaseName + ".dbo.NKPRINV LEFT JOIN " + databaseName + ".dbo.NKSCPART ON NKPR_GL_CUSCOD = NKSC_PARTCODE
                    LEFT JOIN " + databaseName + ".dbo.NKSPADRS ON nkpr_gl_cuscod= nksp_ad_code AND nkpr_gl_shpcod= nksp_ad_codeint
                WHERE NKPR_GL_NUM = @p1;";
    sqlParams = {};
    sqlParams.Add({"@p1", invNum});
    hdrRes = sqlQuery(sql_hdr, sqlParams);
    if (Size(hdrRes) < 2) {
        MessageBox("Ne postoji račun " + invNum + "!");
        return false;
    }

    //------------------------

    // hdr1stRow = hdrRes[1];

    // hdr = {};
    // for(i = 0; i < Size(hdrRes[0]); i++){
    //     hdr[hdrRes[0][i]] = hdrRes[1][i];
    // }

    //------------------------

    // hdr["NKPR_GL_NUM"] = hdrRes[0];
    // hdr["NKPR_GL_OZNAKA"] = hdrRes[1];
    // hdr["NKPR_GL_BROTP"] = hdrRes[2];
    // hdr["NKPR_GL_REZ1"] = hdrRes[3];
    // hdr["NKPR_GL_REZ3"] = hdrRes[4];
    // hdr["NKPR_GL_INVDTE"] = hdrRes[5];
    // hdr["NKPR_GL_TIMECR"] = hdrRes[6];
    // hdr["NKPR_GL_DVO"] = hdrRes[7];
    // hdr["NKPR_GL_NOKAM"] = hdrRes[8];
    // hdr["NKPR_GL_ROKPL"] = hdrRes[9];
    // hdr["NKPR_GL_ESD"] = hdrRes[10];
    // hdr["NKPR_GL_PICTHDR"] = hdrRes[11];
    // hdr["NKPR_GL_CUSNME"] = hdrRes[12];
    // ...
   
    //------------------------

    // MessageBox(hdr);

    //------------------------
    
    // class hdrClass = {
    //     NKPR_GL_NUM = null;
    //     NKPR_GL_OZNAKA = null;
    //     NKPR_GL_BROTP = null;
    //     NKPR_GL_REZ1 = null;
    //     NKPR_GL_REZ3 = null;
    //     NKPR_GL_INVDTE = null;
    //     NKPR_GL_TIMECR = null;
    //     NKPR_GL_DVO = null;
    //     NKPR_GL_NOKAM = null;
    //     NKPR_GL_ROKPL = null;
    //     NKPR_GL_ESD = null;
    //     NKPR_GL_PICTHDR = null;
    //     NKPR_GL_CUSNME = null;
    //     NKPR_GL_JMBG = null;
    //     NKPR_GL_CUSA1 = null;
    //     NKPR_GL_RO = null;
    // ...

    //     hdrClass(sqlRow){
    //         NKPR_GL_NUM = sqlRow[0];
    //         NKPR_GL_OZNAKA = sqlRow[1];
    //         NKPR_GL_BROTP = sqlRow[2];
    //         NKPR_GL_REZ1 = sqlRow[3];
    //         NKPR_GL_REZ3 = sqlRow[4];
    //         NKPR_GL_INVDTE = sqlRow[5];
    //         NKPR_GL_TIMECR = sqlRow[6];
    //         NKPR_GL_DVO = sqlRow[7];
    //         NKPR_GL_NOKAM = sqlRow[8];
    // ...
    // };

    // hdr = new hdrClass(hdrRes[1]);

    // MessageBox(hdr.NKPR_GL_BROTP);

    //------------------------

    NKPR_GL_NUM = hdrRes[1][0];
    NKPR_GL_OZNAKA = hdrRes[1][1].trim();
    NKPR_GL_BROTP = hdrRes[1][2];
    NKPR_GL_REZ1 = hdrRes[1][3];
    NKPR_GL_REZ3 = hdrRes[1][4];
    NKPR_GL_INVDTE = hdrRes[1][5].trim();
    NKPR_GL_TIMECR = hdrRes[1][6].trim();
    NKPR_GL_DVO = hdrRes[1][7].trim();
    NKPR_GL_NOKAM = hdrRes[1][8];
    NKPR_GL_ROKPL = hdrRes[1][9];
    NKPR_GL_ESD = hdrRes[1][10].trim();
    NKPR_GL_PICTHDR = hdrRes[1][11];
    NKPR_GL_PICTFTR = hdrRes[1][12];
    NKPR_GL_CUSNME = hdrRes[1][13].trim();
    NKPR_GL_JMBG = hdrRes[1][14].trim();
    NKPR_GL_CUSA1 = hdrRes[1][15].trim();
    NKPR_GL_RO = hdrRes[1][16].trim();
    NKPR_GL_CUSCTY = hdrRes[1][17].trim();
    NKPR_GL_CUSZIP = hdrRes[1][18];
    NKPR_GL_DRZAVA = hdrRes[1][19].trim();
    NKPR_GL_SIF_PL = hdrRes[1][20].trim();
    NKPR_GL_MODEL = hdrRes[1][21].trim();
    NKPR_GL_POZIV = hdrRes[1][22].trim();
    NKPR_GL_RZRVA1 = hdrRes[1][23].trim();
    NKPR_GL_TOTAL = hdrRes[1][24];
    NKPR_GL_CUSORD = hdrRes[1][25].trim();
    NKPR_GL_CUSST = hdrRes[1][26].trim();
    NKPR_GL_ENTBY = hdrRes[1][27].trim();
    NKPR_GL_BROPIS = hdrRes[1][28].trim();
    NKPR_GL_BROPIS1 = hdrRes[1][29].trim();
    NKPR_GL_DUE_DATE = hdrRes[1][30].trim();
    NKPR_GL_SCONTO = hdrRes[1][31].trim();
    NKPR_GL_DANSC = hdrRes[1][32].trim();
    NKPR_GL_REZ3 = hdrRes[1][33].trim();
    NKPR_GL_SHPCOD = hdrRes[1][34].trim();
    NKPR_GL_SHPNME = hdrRes[1][35].trim();
    NKPR_GL_SHPRO = hdrRes[1][36].trim();
    NKPR_GL_SHPA1 = hdrRes[1][37].trim();
    NKPR_GL_SHPZIP = hdrRes[1][38].trim();
    NKPR_GL_SHPCTY = hdrRes[1][39].trim();
    NKPR_GL_SHPST = hdrRes[1][40].trim();
    NKPR_AD_GLN = hdrRes[1][41].trim();
    NKSC_SOP = hdrRes[1][42].trim(); // Customer GLN
    NKSC_POSREDNIK = hdrRes[1][43].trim().Upper(); // Intermediary GLN


    

    // MessageBox(NKPR_GL_NUM );
    // MessageBox(NKPR_GL_OZNAKA);
    // MessageBox(NKPR_GL_BROTP );
    // MessageBox(NKPR_GL_REZ1);
    // MessageBox(NKPR_GL_REZ3);
    // MessageBox(NKPR_GL_INVDTE);
    // MessageBox(NKPR_GL_TIMECR);
    // MessageBox(NKPR_GL_DVO);
    // MessageBox(NKPR_GL_NOKAM);
    // MessageBox(NKPR_GL_ROKPL);
    // MessageBox(NKPR_GL_ESD);
    // ...


    // -----------------------------------------------------------
    // 2. Load Lines
    // -----------------------------------------------------------
    sql_lin = "SELECT
                NKPR_LN_PQTY,
                NKPR_LN_INVNM,
                NKPR_LN_AMT,
                NKPR_LN_PCODE,
                NKPR_LN_SASTAV,
                NKPR_LN_PDESC,
                NKPR_LN_GRUPA,
                NKPR_LN_TXBLE,
                NKPR_LN_PRNPR,
                NKPR_LN_JEDMJ,
                NKPR_LN_PPRCE,
                NKPR_LN_PEXT,
                NKPR_LN_PDISC,
                NKPR_LN_DISC2,
                NKPR_LN_DISC2T,
                NKPR_LN_DISC3,
                NKPR_LN_DISC3T,
                NKPR_LN_MA_US,
                NKPR_LN_BR_LN,
                NKPR_LN_BROPI,
                NKPR_LN_BROPI1,
                NKPR_LN_PSTOPA,
                NKPR_LN_POPU,
                NKPR_LN_POPL
                FROM " + databaseName + ".dbo.NKPRINVL WHERE NKPR_LN_INVNM = @p1 ORDER BY NKPR_LN_INVNM, NKPR_LN_BR_LN;";
    sqlParams = {};
    sqlParams.Add({"@p1", invNum});
    linRes = sqlQuery(sql_lin, sqlParams);
    if (Size(linRes) < 2) {
        MessageBox("Račun " + invNum + " nema linija!");
        return false;
    }
    
    // -----------------------------------------------------------
    // 2.1. Load KPSYUSER and find user OIB
    // -----------------------------------------------------------
    sql_KPSYUSER = "SELECT
                KPSY_USER_NAZIV, KPSY_USER_CODE
                FROM " + databaseName + ".dbo.KPSYUSER WHERE KPSY_USER_ZNAK = @p1";
    sqlParams = {};
    sqlParams.Add({"@p1", NKPR_GL_ENTBY});
    kpsyuserRes = sqlQuery(sql_KPSYUSER, sqlParams);
    if (Size(kpsyuserRes) < 2) {
        MessageBox("Nema podataka za o prodavaču " + NKPR_GL_ENTBY + "!");
        return false;
    }

    KPSY_USER_NAZIV = kpsyuserRes[1][0].trim();
    KPSY_USER_CODE = kpsyuserRes[1][1].trim();
    

    sql_oib = "SELECT
                NKSYS_VALUE
                FROM " + databaseName + ".dbo.NKSYSYCO WHERE NKSYS_MODUL = 'WKSY' AND NKSYS_GRUP = 'USER' AND NKSYS_GRUP2 = @p1 AND NKSYS_FIELD = 'OIB';";
    sqlParams = {};
    sqlParams.Add({"@p1", KPSY_USER_CODE});
    kpsyuserRes = sqlQuery(sql_oib, sqlParams);
    if (Size(kpsyuserRes) < 2) {
        MessageBox("Nema podataka za OIB prodavača " + NKPR_GL_ENTBY + "/" + KPSY_USER_CODE + "!");
        return false;
    }
    UserOib = kpsyuserRes[1][0].trim();

    // -----------------------------------------------------------
    // 3. Determine ProfileID, TypeCode, Invoice Type
    // -----------------------------------------------------------
    profileID = "P1";
    typeCode = "380";
    invType = "Izdavanje računa za isporuke prema ugovoru";

    if (NKPR_GL_OZNAKA == "S") {
        if (NKPR_GL_BROTP != 0) {
            profileID = "P7";
            invType = "Račun s referencama na otpremnicu";
        } elif (NKPR_GL_REZ1 != 0) {
            profileID = "P11";
            invType = "Djelomični i konačni račun";
        }
    } elif (NKPR_GL_OZNAKA == "P") {
        //za ovaj tip računa - PREDUJAM - ne treba unositit KPD!!!
        if (NKPR_GL_CUSORD == ""){
            profileID = "P4";
        } else {
            //a ako ima narudžbenicu onda je P6
            profileID = "P6";
        }
        typeCode = "386";
        invType = "Avansno plaćanje (plaćanje unaprijed)";
    } elif (NKPR_GL_OZNAKA == "R") {
        //Reklamacija ili povrat sa ovim tipom se isto može napraviti storno računa
        profileID = "P9";
        typeCode = "381";
        invType = "Reklamacija ili povrat robe (CreditNote)";
    } elif (NKPR_GL_OZNAKA == "T") {
        //sa ovim tipom se radi terećenje, iznosi su svi u plusu, ali element je DebitNote
        profileID = "P1";
        typeCode = "383";
        invType = "Terećenje (DebitNote)";
    } elif (NKPR_GL_OZNAKA == "O") {
        //Odobrenje
        if (NKPR_GL_REZ3 != 0) {
            profileID = "P9";
            typeCode = "381";
            invType = "Kreditni račun (CreditNote)"; // (negativni iznosi, povrati) - u pravilu su iznosi u minusu, osim ako se odobrava cassa sconto";
        }
    } elif (NKPR_GL_OZNAKA == "X") {
        //ovo se tako koristi u Poslovnim knjigama, i iznosi u linijama su u minusu; sa ovim tipom može se unositi i terećenje ali ako su iznosi u PLUSU!!
        profileID = "P10";
        typeCode = "384";
        invType = "Korektivni račun (storno ili ispravak)";
    }

    // -----------------------------------------------------------
    // Tax Calculation
    // -----------------------------------------------------------
    //PKFK_TAX_TIP - '' - simple tax code; S= compound tax code Porez1+Porez2; Z - compound tax code Porez1*(1+Porez2)
    //PKFK_TAX_DOBOPC - Code of internal note about tax exempt
    //PKFK_TY_P_PORZ - 'P' -porez PDV; 'R' - pretporez PDV; T - porez na potrošnju; 'O' - ostali porezi 
    //PKFK_TAX_POR1 - first tax code if compound code
    //PKFK_TAX_POR2 - second tax code if compound code

    sql_tax = "SELECT SUM(NKPR_LN_POREZ) AS POREZ, SUM(NKPR_LN_AMT) AS OSNOVICA, NKPR_LN_PRNPR, PKFK_TAX_OBJED , PKFK_TAX_DOBOPC, PKFK_TAX_TIP, PKFK_TAX_P_PORZ, PKFK_TAX_POR1, PKFK_TAX_POR2 " +
              "FROM " + databaseName + ".dbo.NKPRINVL LEFT JOIN " + databaseName + ".dbo.PKFKPORZ ON PKFK_TAX_CODE = NKPR_LN_TXBLE " +
              "WHERE NKPR_LN_INVNM = @p1 AND NKPR_LN_TXBLE <> 0 " +
              "GROUP BY NKPR_LN_PRNPR, PKFK_TAX_OBJED,
              PKFK_TAX_DOBOPC, PKFK_TAX_TIP, PKFK_TAX_P_PORZ, PKFK_TAX_POR1, PKFK_TAX_POR2
              ORDER BY NKPR_LN_PRNPR;";
    sqlParams = {};
    sqlParams.Add({"@p1", invNum});
    taxRes = sqlQuery(sql_tax, sqlParams);

    
    totalPorez = 0;
    totalOsnovica = 0;

    for (i = 1; i < Size(taxRes); i++) {
        row = taxRes[i];
        totalPorez += row[0];
        totalOsnovica += row[1];
    }

    // -----------------------------------------------------------
    // Create taxRes2 - Refactor compound tax codes into individual codes
    // -----------------------------------------------------------
    
    // First, get individual tax rates for compound tax codes
    sql_individual_taxes = "SELECT PKFK_TAX_CODE, PKFK_TAX_STOPA, PKFK_TAX_OBJED, PKFK_TAX_P_PORZ " +
                          "FROM " + databaseName + ".dbo.PKFKPORZ " +
                          "WHERE PKFK_TAX_TIP = '' OR PKFK_TAX_TIP IS NULL;";
    individualTaxRes = sqlQuery(sql_individual_taxes, {});
    
    // Create a lookup for individual tax rates
    taxRateLookup = {};
    for (i = 1; i < Size(individualTaxRes); i++) {
        taxCode = individualTaxRes[i][0];
        taxRate = individualTaxRes[i][1];
        taxCategory = individualTaxRes[i][2];
        taxType = individualTaxRes[i][3];
        taxRateLookup[taxCode] = {"rate": taxRate, "category": taxCategory, "type": taxType};
    }
    
    // Create taxRes2 structure - same as taxRes but with compound taxes split
    taxRes2 = {};
    taxRes2.Add(taxRes[0]); // Copy header row
    
    for (i = 1; i < Size(taxRes); i++) {
        row = taxRes[i];
        
        POREZ = row[0];
        OSNOVICA = row[1]; 
        NKPR_LN_PRNPR = row[2];
        PKFK_TAX_OBJED = row[3];
        PKFK_TAX_DOBOPC = row[4];
        PKFK_TAX_TIP = row[5];
        PKFK_TAX_P_PORZ = row[6];
        PKFK_TAX_POR1 = row[7];
        PKFK_TAX_POR2 = row[8];
        
        if (PKFK_TAX_TIP == "S" && PKFK_TAX_POR1 != "" && PKFK_TAX_POR2 != "") {
            // This is a compound tax code (additive) - split into two individual codes
            
            // Get individual tax rates with error checking
            tax1Info = taxRateLookup[PKFK_TAX_POR1];
            tax2Info = taxRateLookup[PKFK_TAX_POR2];
            
            if (tax1Info == null) {
                MessageBox("Greška: Nije pronađen pojedinačni porez '" + PKFK_TAX_POR1 + "' za složeni porez!");
                return false;
            }
            if (tax2Info == null) {
                MessageBox("Greška: Nije pronađen pojedinačni porez '" + PKFK_TAX_POR2 + "' za složeni porez!");
                return false;
            }


            // Calculate individual tax amounts
            // For compound type 'S': total_rate = rate1 + rate2
            // So: tax1_amount = (rate1 / total_rate) * total_tax_amount
            //     tax2_amount = (rate2 / total_rate) * total_tax_amount
            
            rate1 = tax1Info["rate"];
            rate2 = tax2Info["rate"];
            totalCompoundRate = rate1 + rate2;
            
            if (totalCompoundRate > 0) {
                tax1Amount = (rate1 / totalCompoundRate) * POREZ;
                tax2Amount = (rate2 / totalCompoundRate) * POREZ;
            } else {
                tax1Amount = 0;
                tax2Amount = 0;
            }
            
            // Add first individual tax
            newRow1 = {};
            newRow1.Add(tax1Amount);                    // POREZ
            newRow1.Add(OSNOVICA);                      // OSNOVICA (same base amount)
            newRow1.Add(rate1);                         // NKPR_LN_PRNPR
            newRow1.Add(tax1Info["category"]);          // PKFK_TAX_OBJED
            newRow1.Add(PKFK_TAX_DOBOPC);              // PKFK_TAX_DOBOPC
            newRow1.Add("");                            // PKFK_TAX_TIP (empty for individual)
            newRow1.Add(tax1Info["type"]);             // PKFK_TAX_P_PORZ
            newRow1.Add("");                            // PKFK_TAX_POR1 (empty for individual)
            newRow1.Add("");                            // PKFK_TAX_POR2 (empty for individual)
            taxRes2.Add(newRow1);
            
            // Add second individual tax
            newRow2 = {};
            newRow2.Add(tax2Amount);                    // POREZ
            newRow2.Add(OSNOVICA);                      // OSNOVICA (same base amount)
            newRow2.Add(rate2);                         // NKPR_LN_PRNPR
            newRow2.Add(tax2Info["category"]);          // PKFK_TAX_OBJED
            newRow2.Add(PKFK_TAX_DOBOPC);              // PKFK_TAX_DOBOPC
            newRow2.Add("");                            // PKFK_TAX_TIP (empty for individual)
            newRow2.Add(tax2Info["type"]);             // PKFK_TAX_P_PORZ
            newRow2.Add("");                            // PKFK_TAX_POR1 (empty for individual)
            newRow2.Add("");                            // PKFK_TAX_POR2 (empty for individual)
            taxRes2.Add(newRow2);
            
        } elif (PKFK_TAX_TIP == "Z" && PKFK_TAX_POR1 != "" && PKFK_TAX_POR2 != "") {
            // This is a compound tax code (multiplicative) - Z type: rate1 * (1 + rate2)
            
            // Get individual tax rates with error checking
            tax1Info = taxRateLookup[PKFK_TAX_POR1];
            tax2Info = taxRateLookup[PKFK_TAX_POR2];
            
            if (tax1Info == null) {
                MessageBox("Greška: Nije pronađen pojedinačni porez '" + PKFK_TAX_POR1 + "' za složeni porez!");
                return false;
            }
            if (tax2Info == null) {
                MessageBox("Greška: Nije pronađen pojedinačni porez '" + PKFK_TAX_POR2 + "' za složeni porez!");
                return false;
            }

            rate1 = tax1Info["rate"];
            rate2 = tax2Info["rate"];
            
            // For type Z: effective_rate = rate1 * (1 + rate2/100)
            // Calculate base amounts for each tax proportionally
            baseForTax1 = OSNOVICA;
            tax1Amount = (baseForTax1 * rate1) / 100;
            
            baseForTax2 = OSNOVICA;
            tax2Amount = (baseForTax2 * rate2) / 100;
            
            // Add first individual tax
            newRow1 = {};
            newRow1.Add(tax1Amount);                    // POREZ
            newRow1.Add(baseForTax1);                   // OSNOVICA
            newRow1.Add(rate1);                         // NKPR_LN_PRNPR
            newRow1.Add(tax1Info["category"]);          // PKFK_TAX_OBJED
            newRow1.Add(PKFK_TAX_DOBOPC);              // PKFK_TAX_DOBOPC
            newRow1.Add("");                            // PKFK_TAX_TIP (empty for individual)
            newRow1.Add(tax1Info["type"]);             // PKFK_TAX_P_PORZ
            newRow1.Add("");                            // PKFK_TAX_POR1 (empty for individual)
            newRow1.Add("");                            // PKFK_TAX_POR2 (empty for individual)
            taxRes2.Add(newRow1);
            
            // Add second individual tax
            newRow2 = {};
            newRow2.Add(tax2Amount);                    // POREZ
            newRow2.Add(baseForTax2);                   // OSNOVICA
            newRow2.Add(rate2);                         // NKPR_LN_PRNPR
            newRow2.Add(tax2Info["category"]);          // PKFK_TAX_OBJED
            newRow2.Add(PKFK_TAX_DOBOPC);              // PKFK_TAX_DOBOPC
            newRow2.Add("");                            // PKFK_TAX_TIP (empty for individual)
            newRow2.Add(tax2Info["type"]);             // PKFK_TAX_P_PORZ
            newRow2.Add("");                            // PKFK_TAX_POR1 (empty for individual)
            newRow2.Add("");                            // PKFK_TAX_POR2 (empty for individual)
            taxRes2.Add(newRow2);
            
        } else {
            // This is already an individual tax code, copy as-is
            taxRes2.Add(row);
        }
    }

    

    //tu sada treba dodatno razdraditi poreze prema HR zahtjevima, za slučaj da je to sastavljeni porez od dva poreza, jedan PDV a drugi porez na potrošnju
    //zadržati treba vrstu iz Table PKFKPORZ - PKFK_TAX_P_PORZ
    //ako je samo jedan porez onda je sve ok kao do sada, a ako je dva onda treba razdvojiti


    

    
    // -----------------------------------------------------------
    // 4. Start XML Builder
    // -----------------------------------------------------------
    xml = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n";

    if (profileID == "P9") {
        xml += "<CreditNote xmlns=\"urn:oasis:names:specification:ubl:schema:xsd:CreditNote-2\"\n";
    } elif (NKPR_GL_OZNAKA == 'T') {
        xml += "<DebitNote xmlns=\"urn:oasis:names:specification:ubl:schema:xsd:DebitNote-2\"\n";
    } else {
        xml += "<Invoice xmlns=\"urn:oasis:names:specification:ubl:schema:xsd:Invoice-2\"\n";
    }
    
    xml += "    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n";
    xml += "    xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"\n";
    
    xml += "    xmlns:cac=\"urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2\"\n";
    xml += "    xmlns:cbc=\"urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2\"\n";
    xml += "    xmlns:ext=\"urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2\"\n";

    xml += "    xmlns:hrextac=\"urn:mfin.gov.hr:schema:xsd:HRExtensionAggregateComponents-1\">\n";
    
    // xml += "    xsi:schemaLocation=\"urn:oasis:names:specification:ubl:schema:xsd:Invoice-2 ../xsd/ubl/maindoc/UBL-Invoice-2.1.xsd\">\n";

    // BT-1..126 Extension point; 0..n // ???
    xml += "<ext:UBLExtensions>\n";
    xml += "  <ext:UBLExtension>\n";
    xml += "    <ext:ExtensionContent>\n";
    //OVO treba urediti prema HR zahtjevima, za sada je samo primjer
    //potrebno je poreze potražit iz linija i sa for petljom popunit linije ispod

    xml += "        <hrextac:HRFISK20Data>\n";
    xml += "            <hrextac:HRTaxTotal>\n";
    xml += "                <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(totalPorez, 2, ".") + "</cbc:TaxAmount>\n";
    



    for (i = 1; i < Size(taxRes2); i++) {
        row = taxRes2[i];

        POREZ = row[0];
        OSNOVICA = row[1];
        NKPR_LN_PRNPR = row[2];
        PKFK_TAX_OBJED = Substring(row[3], 0, 2).trim();
        PKFK_TAX_P_PORZ = row[6]; // Get tax type (P=PDV, T=Consumption tax, etc.)

        xml += "                <hrextac:HRTaxSubtotal>\n";
        
        if (PKFK_TAX_P_PORZ == "T") {
            taxName = "HR:PP" + FormatNum(NKPR_LN_PRNPR, 0, ".");
            taxSchemeID = "LOC";
            xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(OSNOVICA, 2, ".") + "</cbc:TaxableAmount>\n";
            xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + 0 + "</cbc:TaxAmount>\n";
            xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(OSNOVICA, 2, ".") + "</cbc:TaxableAmount>\n";
            xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(POREZ, 2, ".") + "</cbc:TaxAmount>\n";
            xml += "                    <hrextac:HRTaxCategory>\n";
            xml += "                        <cbc:ID>" + PKFK_TAX_OBJED + "</cbc:ID>\n";
            xml += "                        <cbc:Name>" + taxName + "</cbc:Name>\n";
            xml += "                        <cbc:TaxExemptionReason>" + "Find in PKFKPORZ napomena" + "</cbc:TaxExemptionReason>\n";
            xml += "                        <cbc:Percent>" + 0.00 + "</cbc:Percent>\n";
            xml += "                        <hrextac:HRTaxScheme>\n";
            xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
            xml += "                        </hrextac:HRTaxScheme>\n";
            xml += "                    </hrextac:HRTaxCategory>\n";
        } elif (PKFK_TAX_P_PORZ == "O") {
            taxName = "HR:OTH" + FormatNum(NKPR_LN_PRNPR, 0, ".");
            taxSchemeID = "LOC";
            xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(OSNOVICA, 2, ".") + "</cbc:TaxableAmount>\n";
            xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + 0 + "</cbc:TaxAmount>\n";
            xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(OSNOVICA, 2, ".") + "</cbc:TaxableAmount>\n";
            xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(POREZ, 2, ".") + "</cbc:TaxAmount>\n";
            xml += "                    <hrextac:HRTaxCategory>\n";
            xml += "                        <cbc:ID>" + PKFK_TAX_OBJED + "</cbc:ID>\n";
            xml += "                        <cbc:Name>" + taxName + "</cbc:Name>\n";
            xml += "                        <cbc:TaxExemptionReason>" + "Find in PKFKPORZ napomena" + "</cbc:TaxExemptionReason>\n";
            xml += "                        <cbc:Percent>" + 0.00 + "</cbc:Percent>\n";
            xml += "                        <hrextac:HRTaxScheme>\n";
            xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
            xml += "                        </hrextac:HRTaxScheme>\n";
            xml += "                    </hrextac:HRTaxCategory>\n";
        }
        else{
            //default je PDV
            taxName = "HR:PDV" + FormatNum(NKPR_LN_PRNPR, 0, ".");
            taxSchemeID = "VAT";
            xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(OSNOVICA, 2, ".") + "</cbc:TaxableAmount>\n";
            xml += "                    <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(POREZ, 2, ".") + "</cbc:TaxAmount>\n";
            xml += "                    <hrextac:HRTaxCategory>\n";
            xml += "                        <cbc:ID>" + PKFK_TAX_OBJED + "</cbc:ID>\n";
            xml += "                        <cbc:Name>" + taxName + "</cbc:Name>\n";
            xml += "                        <cbc:Percent>" + FormatNum(NKPR_LN_PRNPR, 0, ".") + "</cbc:Percent>\n";
            xml += "                        <hrextac:HRTaxScheme>\n";
            xml += "                            <cbc:ID>" + taxSchemeID + "</cbc:ID>\n";
            xml += "                        </hrextac:HRTaxScheme>\n";
            xml += "                    </hrextac:HRTaxCategory>\n";
        }
        xml += "                </hrextac:HRTaxSubtotal>\n";
    }

        // xml += "                <hrextac:HRTaxSubtotal>\n";
        // xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">6.25</cbc:TaxableAmount>\n";
        // xml += "                    <cbc:TaxAmount currencyID=\"EUR\">1.56</cbc:TaxAmount>\n";
        // xml += "                    <hrextac:HRTaxCategory>\n";
        // xml += "                        <cbc:ID>S</cbc:ID>\n";
        // xml += "                        <cbc:Name>HR:PDV0</cbc:Name>\n";
        // xml += "                        <cbc:Percent>0.00</cbc:Percent>\n";
        // xml += "                        <hrextac:HRTaxScheme>\n";
        // xml += "                            <cbc:ID>VAT</cbc:ID>\n";
        // xml += "                        </hrextac:HRTaxScheme>\n";
        // xml += "                    </hrextac:HRTaxCategory>\n";
        // xml += "                </hrextac:HRTaxSubtotal>\n";

        // xml += "                <hrextac:HRTaxSubtotal>\n";
        // xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">0.00</cbc:TaxableAmount>\n";
        // xml += "                    <cbc:TaxAmount currencyID=\"EUR\">0.00</cbc:TaxAmount>\n";
        // xml += "                    <hrextac:HRTaxCategory>\n";
        // xml += "                        <cbc:ID>S</cbc:ID>\n";
        // xml += "                        <cbc:Name>HR:PDV0</cbc:Name>\n";
        // xml += "                        <cbc:Percent>0.00</cbc:Percent>\n";
        // xml += "                        <hrextac:HRTaxScheme>\n";
        // xml += "                            <cbc:ID>VAT</cbc:ID>\n";
        // xml += "                        </hrextac:HRTaxScheme>\n";
        // xml += "                    </hrextac:HRTaxCategory>\n";
        // xml += "                </hrextac:HRTaxSubtotal>\n";

        // xml += "                <hrextac:HRTaxSubtotal>\n";
        // xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">0.19</cbc:TaxableAmount>\n";
        // xml += "                    <cbc:TaxAmount currencyID=\"EUR\">0.00</cbc:TaxAmount>\n";
        // xml += "                    <hrextac:HRTaxCategory>\n";
        // xml += "                        <cbc:ID>O</cbc:ID>\n";
        // xml += "                        <cbc:Name>HR:PP</cbc:Name>\n";
        // xml += "                        <cbc:Percent>0.00</cbc:Percent>\n";
        // xml += "                        <hrextac:HRTaxScheme>\n";
        // xml += "                            <cbc:ID>LOC</cbc:ID>\n";
        // xml += "                        </hrextac:HRTaxScheme>\n";
        // xml += "                    </hrextac:HRTaxCategory>\n";
        // xml += "                </hrextac:HRTaxSubtotal>\n";

        // xml += "                <hrextac:HRTaxSubtotal>\n";
        // xml += "                    <cbc:TaxableAmount currencyID=\"EUR\">0.00</cbc:TaxableAmount>\n";
        // xml += "                    <cbc:TaxAmount currencyID=\"EUR\">0.00</cbc:TaxAmount>\n";
        // xml += "                    <hrextac:HRTaxCategory>\n";
        // xml += "                        <cbc:ID>S</cbc:ID>\n";
        // xml += "                        <cbc:Name>HR:PDV5</cbc:Name>\n";
        // xml += "                        <cbc:Percent>5.00</cbc:Percent>\n";
        // xml += "                        <hrextac:HRTaxScheme>\n";
        // xml += "                            <cbc:ID>VAT</cbc:ID>\n";
        // xml += "                        </hrextac:HRTaxScheme>\n";
        // xml += "                    </hrextac:HRTaxCategory>\n";
        // xml += "                </hrextac:HRTaxSubtotal>\n";

    xml += "            </hrextac:HRTaxTotal>\n";
    xml += "            <hrextac:HRLegalMonetaryTotal>\n";
    xml += "              <cbc:TaxExclusiveAmount currencyID=\"EUR\">" + "0.00" + "</cbc:TaxExclusiveAmount>\n";
    xml += "              <hrextac:OutOfScopeOfVATAmount currencyID=\"EUR\">" + "0.00" + "</hrextac:OutOfScopeOfVATAmount>\n";
    xml += "            </hrextac:HRLegalMonetaryTotal>\n";
    xml += "        </hrextac:HRFISK20Data>\n";

    // xml += "      <sig:UBLDocumentSignatures xmlns:sig=\"urn:oasis:names:specification:ubl:schema:xsd:CommonSignatureComponents-2\">\n";
    // xml += "        <sac:SignatureInformation xmlns:sac=\"urn:oasis:names:specification:ubl:schema:xsd:SignatureAggregateComponents-2\"></sac:SignatureInformation>\n";
    // xml += "      </sig:UBLDocumentSignatures>\n";

    xml += "    </ext:ExtensionContent>\n";
    xml += "  </ext:UBLExtension>\n";
    xml += "</ext:UBLExtensions>\n";

    xml += "<cbc:CustomizationID>urn:cen.eu:en16931:2017#compliant#urn:mfin.gov.hr:cius-2025:1.0#conformant#urn:mfin.gov.hr:ext-2025:1.0</cbc:CustomizationID>\n"; // BT-24; 1..1
    xml += "<cbc:ProfileID>" + profileID + "</cbc:ProfileID>\n"; // BT-23; 1..1

    // BT-1; Invoice number; 1..1
    // Invoice Number (8 digits: 90100002 -->> 00002-90-1)
    invNumStr = String(NKPR_GL_NUM); // 
    invID = Substring(invNumStr, 3, 5) + "-" + Substring(invNumStr, 0, 2) + "-" + Substring(invNumStr, 2, 1);
    xml += "<cbc:ID>" + invID + "</cbc:ID>\n";
    xml += "<cbc:CopyIndicator>false</cbc:CopyIndicator>\n"; // HR-BT-1; 0..1
    xml += "<cbc:IssueDate>" + NKPR_GL_INVDTE + "</cbc:IssueDate>\n"; // BT-2; 1..1
    xml += "<cbc:IssueTime>" + NKPR_GL_TIMECR + "</cbc:IssueTime>\n"; // HR-BT-2; 1..1

    // CreditNote: BillingReference
    if (profileID == "P9") {
        xml += "<cbc:CreditNoteTypeCode>381</cbc:CreditNoteTypeCode>\n"; // BT-3; 1..1
        xml += "<cbc:DocumentCurrencyCode>EUR</cbc:DocumentCurrencyCode>\n"; // BT-5; 1..1 
        /*
        // BillingReference for CreditNote (always required for P9)
        xml += "<cac:BillingReference>\n";
        xml += "  <cac:InvoiceDocumentReference>\n"; // BG-3; 0..n
        refStr = String(NKPR_GL_REZ3);
        refID = Substring(refStr, 3, 5) + "-" + Substring(refStr, 0, 2) + "-" + Substring(refStr, 2, 1);
        xml += "    <cbc:ID>" + refID + "</cbc:ID>\n"; // BT-25; 1..1
        //xml += "    <cbc:IssueDate>" + NKPR_GL_INVDTE + "</cbc:IssueDate>\n"; // BT-26; 1..1
        xml += "  </cac:InvoiceDocumentReference>\n";
        xml += "</cac:BillingReference>\n";
        */
    } else {
        // dueDate = NKPR_GL_DUE_DATE;
        if (NKPR_GL_DUE_DATE != '1900-01-01') {
            xml += "<cbc:DueDate>" + NKPR_GL_DUE_DATE + "</cbc:DueDate>\n";
        }
        xml += "<cbc:InvoiceTypeCode>" + typeCode + "</cbc:InvoiceTypeCode>\n";
        // xml += "<cbc:InvoiceType>" + invType + "</cbc:InvoiceType>\n";

        note = "\n";
        if (NKPR_GL_BROPIS != "") {
            sql_note = "SELECT kppr_op_text FROM " + databaseName + ".dbo.KPPROPIS WHERE KPPR_OP_BROJ = @p1 ORDER BY KPPR_OP_BROJ, kppr_op_lin;";
            sqlParams = {};
            sqlParams.Add({"@p1", NKPR_GL_BROPIS});
            noteRes = sqlQuery(sql_note, sqlParams);
            if (Size(noteRes) >= 2) {
                for (j = 1; j < Size(noteRes); j++) {   
                    note += noteRes[j][0];
                }
            }    
        }
        note += "\n";
        if (nkpr_gl_bropis1 != "") {
            sql_note = "SELECT kppr_op_text FROM " + databaseName + ".dbo.KPPROPIS WHERE KPPR_OP_BROJ = @p1 ORDER BY KPPR_OP_BROJ, kppr_op_lin;";
            sqlParams = {};
            sqlParams.Add({"@p1", NKPR_GL_bropis1});
            noteRes = sqlQuery(sql_note, sqlParams);
            if (Size(noteRes) >= 2) {
                for (j = 1; j < Size(noteRes); j++) {   
                    note += noteRes[j][0];
                }
            }
        }
        note += "  ";
        if(NKPR_GL_ENTBY != ""){
            note += NKPR_GL_ENTBY + ": " + KPSY_USER_NAZIV;
        }
        if (note != "") {
            xml += "<cbc:Note>" + note + "#AAI#" + "</cbc:Note>\n"; // BT-21, 0..1 (note code) and BT-22; 1..1 note text
        }

        xml += "<cbc:TaxPointDate>" + NKPR_GL_ESD + "</cbc:TaxPointDate>\n";
        
        xml += "<cbc:DocumentCurrencyCode>EUR</cbc:DocumentCurrencyCode>\n";
        
        // BillingReference for all document types (except standard invoices with NKPR_GL_OZNAKA = 'S')
        // Required when referencing another document (Credit Note, Corrective Invoice, Debit Note, etc.)
        if (NKPR_GL_OZNAKA != 'S') {
            // Parse multiple invoice references from Note field using #REF() format
            referencedInvoices = {};
            
            // First, add primary reference from NKPR_GL_REZ3 if exists
            if (NKPR_GL_REZ3 != "" && NKPR_GL_REZ3 != "0") {
                referencedInvoices.Add(NKPR_GL_REZ3);
            }
            
            // Parse additional references from Note field using #REF() format
            if (note != "") {
                // Look for #REF( pattern
                refStartPos = IndexOf(note, "#REF(");
                if (refStartPos >= 0) {
                    // Find the closing parenthesis
                    refEndPos = IndexOf(note, ")", refStartPos);
                    if (refEndPos >= 0) {
                        // Extract the content between #REF( and )
                        refContent = Substring(note, refStartPos + 5, refEndPos - refStartPos - 5);
                        
                        // Split by comma and process each reference
                        refNumbers = Split(refContent, ",");
                        for (refIdx = 0; refIdx < Size(refNumbers); refIdx++) {
                            refNum = refNumbers[refIdx].trim();
                            if (refNum != "" && refNum != "0") {
                                // Add to references list if not already present
                                found = false;
                                for (existIdx = 0; existIdx < Size(referencedInvoices); existIdx++) {
                                    if (referencedInvoices[existIdx] == refNum) {
                                        found = true;
                                        break;
                                    }
                                }
                                if (!found) {
                                    referencedInvoices.Add(refNum);
                                }
                            }
                        }
                    }
                }
            }
            
            // Generate BillingReference elements for each referenced invoice
            for (refIdx = 0; refIdx < Size(referencedInvoices); refIdx++) {
                xml += "<cac:BillingReference>\n";
                xml += "  <cac:InvoiceDocumentReference>\n"; // BG-3; 0..n
                refStr = String(referencedInvoices[refIdx]);
                refID = Substring(refStr, 3, 5) + "-" + Substring(refStr, 0, 2) + "-" + Substring(refStr, 2, 1);
                xml += "    <cbc:ID>" + refID + "</cbc:ID>\n"; // BT-25; 1..1
                //xml += "    <cbc:IssueDate>" + NKPR_GL_INVDTE + "</cbc:IssueDate>\n"; // BT-26; 1..1
                xml += "  </cac:InvoiceDocumentReference>\n";
                xml += "</cac:BillingReference>\n";
            }
        }
        xml += "<cbc:TaxCurrencyCode>EUR</cbc:TaxCurrencyCode>\n";



        // if (profileID != "P4") {
        //     ptDesc = "Rok plaćanja je " + NKPR_GL_NOKAM + " dana";
        //     if (NKPR_GL_ROKPL != 0) {
        //         ptDesc += " nakon roka za provjeru od " + NKPR_GL_ROKPL + " dana";
        //     }
        //     ptDesc += ". Rok plaćanja teče od: " + NKPR_GL_DVO;
        //     // xml += "<cbc:PaymentTermsDescription>" + ptDesc + "</cbc:PaymentTermsDescription>\n";

        //     // xml += "<cac:PaymentTerms>\n";
        //     // xml += "  <cbc:Note>Rok plaćanja teče od datuma " + NKPR_GL_DVO + "</cbc:Note>\n";
        //     // xml += "  <cbc:SettlementPeriodMeasure unitCode=\"DAY\">" + NKPR_GL_NOKAM + NKPR_GL_ROKPL + "</cbc:SettlementPeriodMeasure>\n";
        //     // xml += "</cac:PaymentTerms>\n";
        // }
    }


    // -----------------------------------------------------------
    // Header Attachments
    // -----------------------------------------------------------
    if (NKPR_GL_PICTHDR != 0) {
        sql_pic = "SELECT SY_SL_PATH, SY_SL_OPIS FROM " + databaseName + ".dbo.NKSYPICT WHERE SY_SL_CODE = @p1;";
        sqlParams = {};
        sqlParams.Add({"@p1", NKPR_GL_PICTHDR});
        picRes = sqlQuery(sql_pic, sqlParams);
        SY_SL_PATH = picRes[1][0];
        SY_SL_OPIS = picRes[1][1];
        if (Size(picRes) >= 2 && Exists(SY_SL_PATH)) {
            mime = GetMimeType(SY_SL_PATH);
            b64 = File2Base64(SY_SL_PATH);
            xml += "<cac:AdditionalDocumentReference>\n";
            xml += "  <cbc:ID>" + NKPR_GL_PICTHDR + "</cbc:ID>\n"; 
            xml += "  <cbc:DocumentTypeCode>130</cbc:DocumentTypeCode>\n"; //130 must be used for INVOICE type document
            xml += "  <cbc:DocumentDescription>" + SY_SL_OPIS + "</cbc:DocumentDescription>\n";
            xml += "  <cac:Attachment>\n";
            xml += "    <cbc:EmbeddedDocumentBinaryObject mimeCode=\"" + mime + "\" filename=\"" + ParseFile(SY_SL_PATH, "pfName") + "." + ParseFile(SY_SL_PATH, "pfExt") + "\">" + b64 + "</cbc:EmbeddedDocumentBinaryObject>\n";
            xml += "  </cac:Attachment>\n";
            xml += "  <hr:DocumentValidationRef>" + NKPR_GL_PICTHDR + "</hr:DocumentValidationRef>\n";
            xml += "</cac:AdditionalDocumentReference>\n";
        }
    }

    // -----------------------------------------------------------
    // Footer Attachments
    // -----------------------------------------------------------
    if (NKPR_GL_PICTFTR != 0) {
        sql_pic = "SELECT SY_SL_PATH, SY_SL_OPIS FROM " + databaseName + ".dbo.NKSYPICT WHERE SY_SL_CODE = @p1;";
        sqlParams = {};
        sqlParams.Add({"@p1", NKPR_GL_PICTFTR});
        picRes = sqlQuery(sql_pic, sqlParams);
        SY_SL_PATH = picRes[1][0];
        SY_SL_OPIS = picRes[1][1];
        if (Size(picRes) >= 2 && Exists(SY_SL_PATH)) {
            mime = GetMimeType(SY_SL_PATH);
            b64 = File2Base64(SY_SL_PATH);
            xml += "<cac:AdditionalDocumentReference>\n";
            xml += "  <cbc:ID>" + NKPR_GL_PICTFTR + "</cbc:ID>\n";
            xml += "  <cbc:DocumentTypeCode>130</cbc:DocumentTypeCode>\n";
            xml += "  <cbc:DocumentDescription>" + SY_SL_OPIS + "</cbc:DocumentDescription>\n";
            xml += "  <cac:Attachment>\n";
            xml += "    <cbc:EmbeddedDocumentBinaryObject mimeCode=\"" + mime + "\" filename=\"" + ParseFile(SY_SL_PATH, "pfName") + "." + ParseFile(SY_SL_PATH, "pfExt") + "\">" + b64 + "</cbc:EmbeddedDocumentBinaryObject>\n";
            xml += "  </cac:Attachment>\n";
            xml += "  <hr:DocumentValidationRef>" + NKPR_GL_PICTHDR + "</hr:DocumentValidationRef>\n";
            xml += "</cac:AdditionalDocumentReference>\n";
        }
    }

    // -----------------------------------------------------------
    // Supplier
    // -----------------------------------------------------------
    supName = KPSY_COMP_NAME;
    supAddr = KPSY_COMP_ADD1 + (KPSY_GL_RETEARN != "" ? " " + KPSY_GL_RETEARN : "");
    supCity = KPSY_COMP_CSZ;
    supZip = KPSY_COMP_ZIP;

    KPSYSTEMQuery = "SELECT TOP 1 SY_SY_SIF_DRZAV FROM " + databaseName + ".dbo.KPSYSTEM;";
    KPSYSTEMResult = sqlQuery(KPSYSTEMQuery);
    if (Size(KPSYSTEMResult) > 1) {
        SY_SY_SIF_DRZAV = KPSYSTEMResult[1][0].trim();
    }else{
        SY_SY_SIF_DRZAV = "HR";
    }
    supCountry = SY_SY_SIF_DRZAV;

    IniPath = strtrim(wpath()) + SY_CC_USER + ".ini";
    if(!regedit("regOpen", IniPath, "rtFile")){
        MessageBox("Datoteka " + IniPath + " nije dostupna.");
        return false;
    }
    NazivFirme = regedit("regReadStr", 'COMPANY', 'NazivFirme');
    // SavePath = regedit("regReadStr", 'EMAIL', 'EmailFilePath');
    regedit("regClose");

    xml += "<cac:AccountingSupplierParty>\n";
    xml += "  <cac:Party>\n";
    
    // Use GLN (0088 scheme) if available and valid (13 characters), otherwise use OIB (9934 scheme)
    supSchemeID = "9934";
    supEndpointID = supOIB;
    supPartyID = "9934:" + supOIB;
    
    if (KPSY_REZERVAX != "" && KPSY_REZERVAX.length == 13) {
        supSchemeID = "0088";
        supEndpointID = KPSY_REZERVAX;
        supPartyID = "0088:" + KPSY_REZERVAX;
    }
    
    xml += "    <cbc:EndpointID schemeID=\"" + supSchemeID + "\">" + supEndpointID + "</cbc:EndpointID>\n"; // !!! // ???
    xml += "    <cac:PartyIdentification><cbc:ID>" + supPartyID + "</cbc:ID></cac:PartyIdentification>\n";
    xml += "    <cac:PartyName><cbc:Name>" + supName + "</cbc:Name></cac:PartyName>\n";
    
    xml += "    <cac:PostalAddress>\n";
    xml += "      <cbc:StreetName>" + supAddr + "</cbc:StreetName>\n";
    xml += "      <cbc:CityName>" + supCity + "</cbc:CityName>\n";
    xml += "      <cbc:PostalZone>" + supZip + "</cbc:PostalZone>\n";
    xml += "      <cac:Country><cbc:IdentificationCode>" + supCountry + "</cbc:IdentificationCode></cac:Country>\n";
    xml += "    </cac:PostalAddress>\n";
    
    xml += "    <cac:PartyTaxScheme><cbc:CompanyID>" + KPSY_PO_FREIGHT + supOIB + "</cbc:CompanyID><cac:TaxScheme><cbc:ID>VAT</cbc:ID></cac:TaxScheme></cac:PartyTaxScheme>\n";

    RegistrationName = (NazivFirme != "" ? NazivFirme : KPSY_COMP_NAME);
    RegistrationName = RegistrationName.trim();


    xml += "    <cac:PartyLegalEntity>\n";
    xml += "      <cbc:RegistrationName>" + RegistrationName + "</cbc:RegistrationName>\n";
    if (KPSY_COMP_JMBFI != "") {
        // xml += "      <cbc:CompanyID schemeID=\"MBS\">" + KPSY_COMP_JMBFI + "</cbc:CompanyID>\n";
        xml += "      <cbc:CompanyID>" + KPSY_COMP_JMBFI + "</cbc:CompanyID>\n";
    }
    xml += "    </cac:PartyLegalEntity>\n";


    // ??? - ovo ne?
    if (KPSY_COMP_PHONE != "" || KPSY_COMP_EMAIL != "") {
        xml += "    <cac:Contact>\n";
        if (KPSY_COMP_PHONE != "") { xml += "      <cbc:Telephone>" + KPSY_COMP_PHONE + "</cbc:Telephone>\n"; }
        if (KPSY_COMP_EMAIL != "") { xml += "      <cbc:ElectronicMail>" + KPSY_COMP_EMAIL + "</cbc:ElectronicMail>\n"; }
        xml += "    </cac:Contact>\n";
    }

    xml += "  </cac:Party>\n";


    
    xml += "  <cac:SellerContact>"; //možda bi tu trebalo zapravo OIB i naziv prodavača a ne operatera???? ali u dokumentaciji piše operatera!
    xml += "    <cbc:ID>" + UserOib + "</cbc:ID>"; //HR-BT-5; 1..1 ; OIB operatera
    xml += "    <cbc:Name>" + KPSY_USER_NAZIV + "</cbc:Name>"; //HR-BT-4; 0..1 ; naziv operatera
    xml += "  </cac:SellerContact>";


    xml += "</cac:AccountingSupplierParty>\n";

    // -----------------------------------------------------------
    // Customer
    // -----------------------------------------------------------
    xml += "<cac:AccountingCustomerParty>\n";
    xml += "  <cac:Party>\n";
    


    // !!!
    NKPR_GL_JMBG = "26389058739";
    // NKPR_GL_JMBG = "2631289058739";



    // Use GLN (0088 scheme) if available and valid (13 characters), otherwise use OIB (9934 scheme)
    cusSchemeID = "9934";
    cusEndpointID = NKPR_GL_JMBG;
    cusPartyID = "9934:" + NKPR_GL_JMBG;
    
    if (nksc_sop != "" && nksc_sop.length == 13) {
        cusSchemeID = "0088";
        cusEndpointID = nksc_sop;
        cusPartyID = "0088:" + nksc_sop;
    }
    
    xml += "    <cbc:EndpointID schemeID=\"" + cusSchemeID + "\">" + cusEndpointID + "</cbc:EndpointID>\n";
    xml += "    <cac:PartyIdentification><cbc:ID>" + cusPartyID + "</cbc:ID></cac:PartyIdentification>\n";

    xml += "    <cac:PartyName><cbc:Name>" + NKPR_GL_CUSNME + "</cbc:Name></cac:PartyName>\n";

    xml += "    <cac:PostalAddress>\n";

    gl_ro = (NKPR_GL_RO != "" ? " " + NKPR_GL_RO : "");
    StreetName = NKPR_GL_CUSA1 + gl_ro;

    xml += "      <cbc:StreetName>" + StreetName + "</cbc:StreetName>\n";
    // xml += "      <cbc:AdditionalStreetName>***put 6***</cbc:AdditionalStreetName>\n";
    xml += "      <cbc:CityName>" + NKPR_GL_CUSCTY + "</cbc:CityName>\n";
    xml += "      <cbc:PostalZone>" + NKPR_GL_CUSZIP + "</cbc:PostalZone>\n";
    // xml += "      <cbc:CountrySubentity>***Grad Zagreb***</cbc:CountrySubentity>\n";
    xml += "      <cac:Country><cbc:IdentificationCode>" + NKPR_GL_DRZAVA + "</cbc:IdentificationCode></cac:Country>\n";
    xml += "    </cac:PostalAddress>\n";

    if(NKPR_GL_CUSST == ""){
        MessageBox("Kupac nema unesenu oznaku države uz OIB!");
        return false;
    }
    xml += "    <cac:PartyTaxScheme><cbc:CompanyID>" + NKPR_GL_CUSST + NKPR_GL_JMBG + "</cbc:CompanyID><cac:TaxScheme><cbc:ID>VAT</cbc:ID></cac:TaxScheme></cac:PartyTaxScheme>\n";
    


    // ??? PartyLegalEntity
    xml += "    <cac:PartyLegalEntity>\n";
    xml += "      <cbc:RegistrationName>" + NKPR_GL_CUSNME + "</cbc:RegistrationName>\n";
    // if (KPSY_COMP_JMBFI != "") {
    //     // xml += "      <cbc:CompanyID schemeID=\"MBS\">" + KPSY_COMP_JMBFI + "</cbc:CompanyID>\n";
    //     // xml += "      <cbc:CompanyID>" +  + "</cbc:CompanyID>\n";
    // }
    xml += "    </cac:PartyLegalEntity>\n";

    
    xml += "  </cac:Party>\n";
    xml += "</cac:AccountingCustomerParty>\n";

    // // -----------------------------------------------------------
    // // Delivery Location (if specified)
    // // -----------------------------------------------------------
    // // Check if any delivery location information is present
    // if (NKPR_GL_SHPCOD != "" || NKPR_GL_SHPNME != "" || NKPR_GL_SHPRO != "") {
    //     xml += "<cac:Delivery>\n";
    //     xml += "  <cac:DeliveryLocation>\n";
        
    //     // Determine delivery location ID - preference: NKPR_AD_GLN (13 chars) > NKPR_GL_SHPCOD > 'ZZZZ'
    //     deliveryLocationID = "";
    //     deliverySchemeID = "";
        
    //     if (NKPR_AD_GLN != "" && Length(NKPR_AD_GLN) == 13) {
    //         // GLN number has preference (13 characters)
    //         deliveryLocationID = NKPR_AD_GLN;
    //         deliverySchemeID = "0088"; // GLN scheme
    //     } elif (NKPR_GL_SHPCOD != "") {
    //         // Internal delivery location code
    //         deliveryLocationID = NKPR_GL_SHPCOD;
    //         deliverySchemeID = "9934"; // Internal code scheme (Croatia)
    //     } else {
    //         // Ad hoc code when no specific ID available
    //         deliveryLocationID = "ZZZZ";
    //         deliverySchemeID = "9934";
    //     }
        
    //     xml += "    <cbc:ID schemeID=\"" + deliverySchemeID + "\">" + deliveryLocationID + "</cbc:ID>\n";
        
    //     // Add delivery address if any address components are present
    //     if (NKPR_GL_SHPA1 != "" || NKPR_GL_SHPCTY != "" || NKPR_GL_SHPZIP != "" || NKPR_GL_SHPST != "") {
    //         xml += "    <cac:Address>\n";
            
    //         if (NKPR_GL_SHPA1 != "") {
    //             xml += "      <cbc:StreetName>" + NKPR_GL_SHPA1 + "</cbc:StreetName>\n";
    //         }
            
    //         if (NKPR_GL_SHPCTY != "") {
    //             xml += "      <cbc:CityName>" + NKPR_GL_SHPCTY + "</cbc:CityName>\n";
    //         }
            
    //         if (NKPR_GL_SHPZIP != "") {
    //             xml += "      <cbc:PostalZone>" + NKPR_GL_SHPZIP + "</cbc:PostalZone>\n";
    //         }
            
    //         if (NKPR_GL_SHPST != "") {
    //             xml += "      <cac:Country>\n";
    //             xml += "        <cbc:IdentificationCode>" + NKPR_GL_SHPST + "</cbc:IdentificationCode>\n";
    //             xml += "      </cac:Country>\n";
    //         }
            
    //         xml += "    </cac:Address>\n";
    //     }
        
    //     xml += "  </cac:DeliveryLocation>\n";
        
    //     // Add delivery party information if name or province is available
    //     if (NKPR_GL_SHPNME != "" || NKPR_GL_SHPRO != "") {
    //         xml += "  <cac:DeliveryParty>\n";
            
    //         if (NKPR_GL_SHPNME != "") {
    //             xml += "    <cac:PartyName>\n";
    //             xml += "      <cbc:Name>" + NKPR_GL_SHPNME + "</cbc:Name>\n";
    //             xml += "    </cac:PartyName>\n";
    //         }
            
    //         // If province is different from delivery address, add it as party location
    //         if (NKPR_GL_SHPRO != "" && NKPR_GL_SHPRO != NKPR_GL_SHPST) {
    //             xml += "    <cac:PhysicalLocation>\n";
    //             xml += "      <cac:Address>\n";
    //             xml += "        <cbc:CountrySubentity>" + NKPR_GL_SHPRO + "</cbc:CountrySubentity>\n";
    //             xml += "      </cac:Address>\n";
    //             xml += "    </cac:PhysicalLocation>\n";
    //         }
            
    //         xml += "  </cac:DeliveryParty>\n";
    //     }
        
    //     xml += "</cac:Delivery>\n";
    // }




    // -----------------------------------------------------------
    // Payment Means
    // -----------------------------------------------------------
    payCode = "30";
    KPKS_PL_OPIS = "Plaćanje virmanom";
    sql_pay = "SELECT KPKS_PL_NAZIV2, KPKS_PL_OPIS FROM " + databaseName + ".dbo.KPKSVRPL WHERE KPKS_PL_SIF_PL = @p1;";
    sqlParams = {};
    sqlParams.Add({"@p1", NKPR_GL_SIF_PL});
    payRes = sqlQuery(sql_pay, sqlParams);
    if (Size(payRes) >= 2) {
        KPKS_PL_NAZIV2 = payRes[1][0].trim();
        KPKS_PL_OPIS = payRes[1][1].trim();

        code3 = int(Substring(payRes[1][0], 0, 2));
        if (code3 >= 30 && code3 <= 59) { // ???
            payCode = string(code3);
        }
    }

    xml += "<cac:PaymentMeans>\n";
    xml += "  <cbc:PaymentMeansCode>" + payCode + "</cbc:PaymentMeansCode>\n";
    xml += "  <cbc:InstructionNote>" + KPKS_PL_OPIS + "</cbc:InstructionNote>\n";
    xml += "  <cbc:PaymentID>" + NKPR_GL_MODEL + " " + NKPR_GL_POZIV + "</cbc:PaymentID>\n";

    sql_bank = "SELECT NKSC_ZR_KONTO, NKSC_ZR_NAZIV FROM " + databaseName + ".dbo.NKSCZIRO WHERE NKSC_ZR_BANKA = @p1;";
    sqlParams = {};
    sqlParams.Add({"@p1", NKPR_GL_RZRVA1});
    bankRes = sqlQuery(sql_bank, sqlParams);
    if (Size(bankRes) >= 2) {
        NKSC_ZR_KONTO = bankRes[1][0].trim();
        NKSC_ZR_NAZIV = bankRes[1][1].trim();
        xml += "  <cac:PayeeFinancialAccount>\n";
        xml += "    <cbc:ID>" + NKSC_ZR_KONTO + "</cbc:ID>\n";
        // xml += "    <cbc:AccountType>TRAN</cbc:AccountType>\n";
        xml += "    <cbc:Name>" + NKSC_ZR_NAZIV + "</cbc:Name>\n";
        xml += "  </cac:PayeeFinancialAccount>\n";
    }
    xml += "</cac:PaymentMeans>\n";



                //                     // -----------------------------------------------------------
                //                     // Tax Calculation
                //                     // -----------------------------------------------------------
                // sql_tax = "SELECT SUM(NKPR_LN_POREZ) AS POREZ, SUM(NKPR_LN_AMT) AS OSNOVICA, NKPR_LN_PRNPR, PKFK_TAX_OBJED " +
                //           "FROM " + databaseName + ".dbo.NKPRINVL LEFT JOIN " + databaseName + ".dbo.PKFKPORZ ON PKFK_TAX_CODE = NKPR_LN_TXBLE " +
                //           "WHERE NKPR_LN_INVNM = @p1 AND NKPR_LN_TXBLE <> 0 " +
                //           "GROUP BY NKPR_LN_PRNPR, PKFK_TAX_OBJED ORDER BY NKPR_LN_PRNPR;";
                // sqlParams = {};
                // sqlParams.Add({"@p1", invNum});
                // taxRes = sqlQuery(sql_tax, sqlParams);

                // totalPorez = 0;
                // totalOsnovica = 0;

                // for (i = 1; i < Size(taxRes); i++) {
                //     row = taxRes[i];
                //     totalPorez += row[0];
                //     totalOsnovica += row[1];
                // }



    // FORMAT mora bit npr. 123.45, ne 123,45... i 123.00 ne 123 // ???
    xml += "<cac:TaxTotal>\n";
    xml += "  <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(totalPorez, 2, ".") + "</cbc:TaxAmount>\n";
    for (i = 1; i < Size(taxRes2); i++) {
        row = taxRes2[i];

        POREZ = row[0];
        OSNOVICA = row[1];
        NKPR_LN_PRNPR = row[2];
        PKFK_TAX_OBJED = Substring(row[3], 0, 2).trim();
        PKFK_TAX_P_PORZ = row[6]; // Get tax type

        xml += "  <cac:TaxSubtotal>\n";
        xml += "    <cbc:TaxableAmount currencyID=\"EUR\">" + FormatNum(OSNOVICA, 2, ".") + "</cbc:TaxableAmount>\n";
        xml += "    <cbc:TaxAmount currencyID=\"EUR\">" + FormatNum(POREZ, 2, ".") + "</cbc:TaxAmount>\n";
        xml += "    <cac:TaxCategory>\n";
        xml += "      <cbc:ID>" + PKFK_TAX_OBJED + "</cbc:ID>\n";
        xml += "      <cbc:Percent>" + FormatNum(NKPR_LN_PRNPR, 0, ".") + "</cbc:Percent>\n";
        
        // Use appropriate tax scheme based on tax type
        taxSchemeID = "VAT";
        if (PKFK_TAX_P_PORZ == "T" || PKFK_TAX_P_PORZ == "O") {
            taxSchemeID = "LOC";
        }
        xml += "      <cac:TaxScheme><cbc:ID>" + taxSchemeID + "</cbc:ID></cac:TaxScheme>\n";
        xml += "    </cac:TaxCategory>\n";
        xml += "  </cac:TaxSubtotal>\n";
    }
    xml += "</cac:TaxTotal>\n";

    // LegalMonetaryTotal
    total = NKPR_GL_TOTAL;
    prepaid = (profileID == "P11" ? NKPR_GL_REZ1 : 0);
    payable = total - prepaid;
    rounding = total - (totalOsnovica + totalPorez);

    xml += "<cac:LegalMonetaryTotal>\n";
    xml += "  <cbc:LineExtensionAmount currencyID=\"EUR\">" + FormatNum(totalOsnovica, 2, ".") + "</cbc:LineExtensionAmount>\n";
    xml += "  <cbc:TaxExclusiveAmount currencyID=\"EUR\">" + FormatNum(total - totalPorez, 2, ".") + "</cbc:TaxExclusiveAmount>\n";
    xml += "  <cbc:TaxInclusiveAmount currencyID=\"EUR\">" + FormatNum(total, 2, ".") + "</cbc:TaxInclusiveAmount>\n";
    if (prepaid > 0) { xml += "  <cbc:PrepaidAmount currencyID=\"EUR\">" + FormatNum(prepaid, 2, ".") + "</cbc:PrepaidAmount>\n"; }
    xml += "  <cbc:PayableAmount currencyID=\"EUR\">" + FormatNum(payable, 2, ".") + "</cbc:PayableAmount>\n";
    // if (rounding != 0) { xml += "  <cbc:PayableRoundingAmount currencyID=\"EUR\">" + FormatNum(rounding, 2, ".") + "</cbc:PayableRoundingAmount>\n"; }
    xml += "</cac:LegalMonetaryTotal>\n";
    

    // -----------------------------------------------------------
    // Invoice Lines
    // -----------------------------------------------------------
    for (j = 1; j < Size(linRes); j++) {

        fillInvoiceLine(j);

        grossAmount = NKPR_LN_PQTY * NKPR_LN_PPRCE;
        netAmount = NKPR_LN_AMT;
        
        // Calculate different discount components
        // a. Invoice level discount (NKPR_GL_SCONTO) - only if NKPR_GL_DANSC = 0
        invoiceLevelDiscountAmount = 0;
        if (NKPR_GL_DANSC == "0" && NKPR_LN_POPU != 0) {
            invoiceLevelDiscountAmount = NKPR_LN_POPU; // Amount from invoice discount distributed to this line
        }
        
        // b. Line level discounts - NKPR_LN_POPL contains total discount including invoice discount
        // So line discount amount = NKPR_LN_POPL - NKPR_LN_POPU
        lineLevelDiscountAmount = NKPR_LN_POPL - NKPR_LN_POPU;
        
        // Current discountTotal calculation for verification
        discountTotal = grossAmount - netAmount;

        if (profileID == "P9") {
            xml += "<cac:CreditNoteLine>\n";
            xml += "  <cbc:ID>" + NKPR_LN_BR_LN + "</cbc:ID>\n";
            xml += "  <cbc:CreditedQuantity unitCode=\"" + GetUNUnitCode(NKPR_LN_JEDMJ) + "\">" + FormatNum(NKPR_LN_PQTY, 4, ".") + "</cbc:CreditedQuantity>\n";
        } elif (nkpr_gl_oznaka == 'T') {
            xml += "<DebitNoteLine>\n";
            xml += "  <cbc:ID>" + NKPR_LN_BR_LN + "</cbc:ID>\n";
            xml += "  <cbc:DebitedQuantity unitCode=\"" + GetUNUnitCode(NKPR_LN_JEDMJ) + "\">" + FormatNum(NKPR_LN_PQTY, 4, ".") + "</cbc:DebitedQuantity>\n";
        } else {
            xml += "<cac:InvoiceLine>\n";
            xml += "  <cbc:ID>" + NKPR_LN_BR_LN + "</cbc:ID>\n";
            xml += "  <cbc:InvoicedQuantity unitCode=\"" + GetUNUnitCode(NKPR_LN_JEDMJ) + "\">" + FormatNum(NKPR_LN_PQTY, 4, ".") + "</cbc:InvoicedQuantity>\n";
        }
        noteText= "";
        if (NKPR_LN_BROPI1 != "") {
            sql_note = "SELECT kppr_op_text FROM " + databaseName + ".dbo.KPPROPIS WHERE KPPR_OP_BROJ = @p1 ORDER BY KPPR_OP_BROJ, kppr_op_lin;";
            sqlParams = {};
            sqlParams.Add({"@p1", NKPR_LN_BROPI1});
            noteRes = sqlQuery(sql_note, sqlParams);
            if (Size(noteRes) >= 2) {
                for (j = 1; j < Size(linRes); j++) {   
                    noteText += noteRes[j][0];
                }
            }    
        }
        if (NKPR_LN_BROPI != "") {
            sql_note = "SELECT kppr_op_text FROM " + databaseName + ".dbo.KPPROPIS WHERE KPPR_OP_BROJ = @p1 ORDER BY KPPR_OP_BROJ, kppr_op_lin;";
            sqlParams = {};
            sqlParams.Add({"@p1", NKPR_LN_BROPI});
            noteRes = sqlQuery(sql_note, sqlParams);
            if (Size(noteRes) >= 2) {
                noteText += 
                for (j = 1; j < Size(linRes); j++) {   
                    noteText += noteRes[j][0];
                }
            }    
        }
        if(noteText != ""){
            xml += "  <cbc:Note>" + noteText + "</cbc:Note>\n"; //BT-127, 0..1   
        }
        xml += "  <cbc:LineExtensionAmount currencyID=\"EUR\">" + FormatNum(NKPR_LN_AMT, 2, ".") + "</cbc:LineExtensionAmount>\n";
        // xml += "  <cbc:ItemInternalID>" + NKPR_LN_PCODE + "</cbc:ItemInternalID>\n";

        // Line discount - standardni popust na IZNOS stavke!
        //ako je u nksysyco - 'IR','','','PopustNaCijenu'= 'D' onda se popust ne prikazuje ovdje nego u cijeni malo niže, i to samo prvi popust u polju nkpr_ln_disc
        //inače se oba popusta prikazuju ovdje - nkpr_ln_disc i nkpr_ln_pstop
        //znači ako je discounttotal<> 0 i ako nije 'D' u nksysyco onda se prikazuje ovdje oba popusta
        //iznos popusta u linijama je u polju nkpr_ln_popl i to je ukupan popust koji uključuje polja nlpr_ln_disc, nkpr_ln_pstop i popust iz zaglavlja (na cijeli račun)
        //u plju nkpr_ln_popu je samo popust iz zaglavlja nkpr_gl_sconto koji je tu prenešen na linije, a računa se samo ako je u polju NKPR_GL_DANSC= 0
        
        // Generate AllowanceCharge elements for different discount types
        
        // 1. Invoice level discount (if NKPR_GL_DANSC = 0 and NKPR_LN_POPU > 0)
        if (invoiceLevelDiscountAmount > 0) {
            xml += "  <cac:AllowanceCharge>\n";
            xml += "    <cbc:ChargeIndicator>false</cbc:ChargeIndicator>\n";
            xml += "    <cbc:AllowanceChargeReason>Popust na osnovu računa (" + NKPR_GL_SCONTO + "%)</cbc:AllowanceChargeReason>\n";
            xml += "    <cbc:MultiplierFactorNumeric>" + FormatNum((invoiceLevelDiscountAmount / grossAmount) * 100, 2, ".") + "</cbc:MultiplierFactorNumeric>\n";
            xml += "    <cbc:Amount currencyID=\"EUR\">" + FormatNum(invoiceLevelDiscountAmount, 2, ".") + "</cbc:Amount>\n";
            xml += "    <cbc:BaseAmount currencyID=\"EUR\">" + FormatNum(grossAmount, 2, ".") + "</cbc:BaseAmount>\n";
            xml += "  </cac:AllowanceCharge>\n";
        }
        
        // 2. Line level discounts (NKPR_LN_PDISC and NKPR_LN_PSTOPA combined)
        if (lineLevelDiscountAmount > 0) {
            xml += "  <cac:AllowanceCharge>\n";
            xml += "    <cbc:ChargeIndicator>false</cbc:ChargeIndicator>\n";
            reasonText = "Popust na stavku";
            if (NKPR_LN_PDISC != 0 && NKPR_LN_PSTOPA != 0) {
                reasonText += " (" + FormatNum(NKPR_LN_PDISC, 2, ".") + "% + " + FormatNum(NKPR_LN_PSTOPA, 2, ".") + "%)";
            } elif (NKPR_LN_PDISC != 0) {
                reasonText += " (" + FormatNum(NKPR_LN_PDISC, 2, ".") + "%)";
            } elif (NKPR_LN_PSTOPA != 0) {
                reasonText += " (" + FormatNum(NKPR_LN_PSTOPA, 2, ".") + "%)";
            }
            xml += "    <cbc:AllowanceChargeReason>" + reasonText + "</cbc:AllowanceChargeReason>\n";
            xml += "    <cbc:MultiplierFactorNumeric>" + FormatNum((lineLevelDiscountAmount / grossAmount) * 100, 2, ".") + "</cbc:MultiplierFactorNumeric>\n";
            xml += "    <cbc:Amount currencyID=\"EUR\">" + FormatNum(lineLevelDiscountAmount, 2, ".") + "</cbc:Amount>\n";
            xml += "    <cbc:BaseAmount currencyID=\"EUR\">" + FormatNum(grossAmount, 2, ".") + "</cbc:BaseAmount>\n";
            xml += "  </cac:AllowanceCharge>\n";
        } elif (lineLevelDiscountAmount < 0) {
            // Negative line discount = charge
            xml += "  <cac:AllowanceCharge>\n";
            xml += "    <cbc:ChargeIndicator>true</cbc:ChargeIndicator>\n";
            xml += "    <cbc:AllowanceChargeReason>Naplata na stavku</cbc:AllowanceChargeReason>\n";
            xml += "    <cbc:MultiplierFactorNumeric>" + FormatNum((Math.abs(lineLevelDiscountAmount) / grossAmount) * 100, 2, ".") + "</cbc:MultiplierFactorNumeric>\n";
            xml += "    <cbc:Amount currencyID=\"EUR\">" + FormatNum(Math.abs(lineLevelDiscountAmount), 2, ".") + "</cbc:Amount>\n";
            xml += "    <cbc:BaseAmount currencyID=\"EUR\">" + FormatNum(grossAmount, 2, ".") + "</cbc:BaseAmount>\n";
            xml += "  </cac:AllowanceCharge>\n";
        }
        
        // 3. If no discounts, add a zero allowance for completeness (optional)
        if (invoiceLevelDiscountAmount == 0 && lineLevelDiscountAmount == 0) {
            xml += "  <cac:AllowanceCharge>\n";
            xml += "    <cbc:ChargeIndicator>false</cbc:ChargeIndicator>\n";
            xml += "    <cbc:AllowanceChargeReason>Bez popusta</cbc:AllowanceChargeReason>\n";
            xml += "    <cbc:MultiplierFactorNumeric>0.00</cbc:MultiplierFactorNumeric>\n";
            xml += "    <cbc:Amount currencyID=\"EUR\">0.00</cbc:Amount>\n";
            xml += "    <cbc:BaseAmount currencyID=\"EUR\">" + FormatNum(grossAmount, 2, ".") + "</cbc:BaseAmount>\n";
            xml += "  </cac:AllowanceCharge>\n";
        }
        
        // Verification: Check if our calculation matches the current discountTotal
        calculatedDiscountTotal = invoiceLevelDiscountAmount + lineLevelDiscountAmount;
        if (Math.abs(calculatedDiscountTotal - discountTotal) > 0.01) {
            // Add comment for debugging if there's a discrepancy
            xml += "  <!-- DISCOUNT VERIFICATION: Calculated=" + FormatNum(calculatedDiscountTotal, 2, ".") + 
                   " vs Current=" + FormatNum(discountTotal, 2, ".") + " -->\n";
        }

        // Line attachment
        if (NKPR_LN_SASTAV != 0) {
            sql_pic = "SELECT SY_SL_PATH, SY_SL_OPIS FROM " + databaseName + ".dbo.NKSYPICT WHERE SY_SL_CODE = @p1;";
            sqlParams = {};
            sqlParams.Add({"@p1", NKPR_LN_SASTAV});
            picRes = sqlQuery(sql_pic, sqlParams);
            if (Size(picRes) >= 2 && Exists(picRes[1][0])) {
                SY_SL_PATH = picRes[1][0];
                SY_SL_OPIS = picRes[1][1];
                mime = GetMimeType(SY_SL_PATH);
                b64 = File2Base64(SY_SL_PATH);
                xml += "  <cac:DocumentReference>\n";
                xml += "    <cbc:ID>" + NKPR_LN_SASTAV + "</cbc:ID>\n";
                xml += "    <cbc:DocumentDescription>" + SY_SL_OPIS + "</cbc:DocumentDescription>\n";
                xml += "    <cac:Attachment>\n";
                xml += "      <cbc:EmbeddedDocumentBinaryObject mimeCode=\"" + mime + "\" filename=\"" + ParseFile(SY_SL_PATH, "pfName") + "." + ParseFile(SY_SL_PATH, "pfExt") + "\">" + b64 + "</cbc:EmbeddedDocumentBinaryObject>\n";
                xml += "    </cac:Attachment>\n";
                xml += "  </cac:DocumentReference>\n";
            }
        }

        xml += "  <cac:Item>\n";
        xml += "    <cbc:Name>" + NKPR_LN_PDESC + "</cbc:Name>\n";

        // Item codes
        sql_art = "SELECT ARTI_ARTIKL, ARTI_SIFART_BAR, ARTI_PRELIMTEZ FROM " + databaseName + ".dbo.NKMKARTI WHERE ARTI_ARTIKL = @p1 ORDER BY ARTI_ARTIKL;";
        sqlParams = {};
        sqlParams.Add({"@p1", NKPR_LN_PCODE});
        artRes = sqlQuery(sql_art, sqlParams);
        ean = "";
        intCode = "";
        if (Size(artRes) >= 2) {
            ARTI_ARTIKL = artRes[1][0].trim();
            ARTI_SIFART_BAR = artRes[1][1].trim();
            ARTI_PRELIMTEZ = artRes[1][2].trim();

            if (ARTI_SIFART_BAR.length == 13) {
                ean = ARTI_SIFART_BAR;
                intCode = ARTI_ARTIKL;
            } elif(ARTI_ARTIKL.length == 13) {
                ean = ARTI_ARTIKL;
                intCode = ARTI_SIFART_BAR;
            } else {
                intCode = ARTI_ARTIKL;
                ean = "";
            }
        }
        xml += "    <cac:SellersItemIdentification><cbc:ID>" + intCode + "</cbc:ID></cac:SellersItemIdentification>\n";
        if (ean.length == 13) {
            xml += "    <cac:StandardItemIdentification><cbc:ID schemeID=\"0160\">" + ean + "</cbc:ID></cac:StandardItemIdentification>\n";
        }

        // KPD
        kpd = NKPR_LN_GRUPA;
        if (kpd == "" && Size(artRes) >= 2) { 
            kpd = ARTI_PRELIMTEZ; 
        }

        // ???
        //Uzimati samo tipove artikla R G S N P za KPD - redovni gotovi proizvodi, sastavljeni, usluge i povratna naknada!    
        if (kpd.length == 6 && (NKPR_LN_MA_US == "R" || NKPR_LN_MA_US == "G" || NKPR_LN_MA_US == "S" || NKPR_LN_MA_US == "N" || NKPR_LN_MA_US == "P")) {
            xml += "    <cac:CommodityClassification>\n";
            xml += "      <cbc:ItemClassificationCode listID=\"CG\">" + Substring(kpd, 0, 2) + "." + Substring(kpd, 2, 2) + "." + Substring(kpd, 4, 2) + "</cbc:ItemClassificationCode>\n";
            xml += "    </cac:CommodityClassification>\n";
        }

        // Tax
        sql_taxc = "SELECT PKFK_TAX_OBJED FROM " + databaseName + ".dbo.PKFKPORZ WHERE PKFK_TAX_CODE = @p1;";
        sqlParams = {};
        sqlParams.Add({"@p1", NKPR_LN_TXBLE});
        taxcRes = sqlQuery(sql_taxc, sqlParams);
        PKFK_TAX_OBJED = "S";
        if (Size(taxcRes) >= 2) {
            PKFK_TAX_OBJED = Substring(taxcRes[1][0], 0, 2).trim();
        }
        xml += "    <cac:ClassifiedTaxCategory>\n";
        xml += "      <cbc:ID>" + PKFK_TAX_OBJED + "</cbc:ID>\n";
        xml += "      <cbc:Percent>" + FormatNum(NKPR_LN_PRNPR, 0, ".") + "</cbc:Percent>\n";
        xml += "      <cac:TaxScheme><cbc:ID>VAT</cbc:ID></cac:TaxScheme>\n";
        xml += "    </cac:ClassifiedTaxCategory>\n";

        xml += "  </cac:Item>\n";

        // Price
        xml += "  <cac:Price>\n";
        xml += "    <cbc:PriceAmount currencyID=\"EUR\">" + FormatNum(NKPR_LN_PPRCE, 4, ".") + "</cbc:PriceAmount>\n";
        xml += "    <cbc:BaseQuantity unitCode=\"" + GetUNUnitCode(NKPR_LN_JEDMJ) + "\">1</cbc:BaseQuantity>\n";
        xml += "  </cac:Price>\n";

        if (profileID == "P9") {
            xml += "</cac:CreditNoteLine>\n"; // ???
        } elif (nkpr_gl_oznaka == 'T') {
            xml += "</cac:DebitNoteLine>\n";
        } else {
            xml += "</cac:InvoiceLine>\n";
        }

    }


    // Close root
    if (profileID == "P9") {
        xml += "</CreditNote>\n";
    } elif (nkpr_gl_oznaka == 'T') {
        xml += "</DebitNote>\n";
    } else {
        xml += "</Invoice>\n";
    }

    // -----------------------------------------------------------
    // ...Save xml BEFORE validation
    // -----------------------------------------------------------
    xmlFileName = FILESPATH + parsefile(attachmentPdfPath, "pfName") + ".xml";
    // msg(xmlFileName);
    SaveFile(xml, xmlFileName);


    // -----------------------------------------------------------
    // 8.0. VALIDATION 
    // -----------------------------------------------------------

    // IniPath = strtrim(wpath()) + "winx.ini";
    // if(!regedit("regOpen", IniPath, "rtFile")){
    //     MessageBox("Datoteka " + IniPath + " nije dostupna.");
    //     return false;
    // }
    // SchemasPath = regedit("regReadStr", 'ERACUN', 'SchemasPath');
    // regedit("regClose");
    

    xsdValidationResultOutputFile = FILESPATH + parsefile(attachmentPdfPath, "pfName") + "_XSD.err";
    schValidationResultOutputFile = FILESPATH + parsefile(attachmentPdfPath, "pfName") + "_SCH.err";
    

    // -----------------------------------------------------------
    // 8.1. DELETE OLDER VALIDATION OUTPUT FILES (IF EXIST)
    // -----------------------------------------------------------
    if(Exists(xsdValidationResultOutputFile)){
        Delete(xsdValidationResultOutputFile);
    }
    
    if(Exists(schValidationResultOutputFile)){
        Delete(schValidationResultOutputFile);
    }


    // -----------------------------------------------------------
    // 8.2. XSD VALIDATION 
    // -----------------------------------------------------------
    xsdFiles = {};
    xsdFiles.Add(SCHEMASPATH + "xsd\\maindoc\\UBL-Invoice-2.1.xsd");
    if (!ValidateXsd(xml, xsdFiles, xsdValidationResultOutputFile)) {
        // LogError("XSD_FAIL", "Validation failed for " + invNum, validationErrors);
        MessageBox("xml FAILED XSD validation\n\nSee _XSD.err file for details.");
        return false;
    }



    // // signature
    // MessageBox(SignXml(xmlFileName, "C:\\temp\\cert\\p12_aurasoft_demo.p12", "Aurasoft1", SavePath + parsefile(attachmentPdfPath, "pfName") + "_signed.xml"));
    // return false;




    // -----------------------------------------------------------
    // 8.3. SCH VALIDATION 
    // -----------------------------------------------------------
    schFiles = {};
    schFiles.Add(SCHEMASPATH + "schematron\\HR-CIUS-EXT-EN16931-UBL.sch");
    // schFiles.Add(SCHEMASPATH + "schematron\\preprocessed\\EN16931-UBL-validation-preprocessed.sch");
    if(!ValidateSch(xml, schFiles, SCHEMASPATH + "schematron\\transpile.xsl", schValidationResultOutputFile)){
        MessageBox("xml FAILED SCH validation\n\nSee _SCH.err file for details.");
        return false;
    }






    /// POTPISIVANJE XML-A
    /// 
    /// 
    // MSG(SignXml(xmlFileName, "C:\\Users\\User\\Documents\\__ERACUN_FISKALIZACIJA_2.0\\cert\\p12_aurasoft_demo.p12", "Aurasoft1", xmlFileName + ".sig.xml"));








    // schFiles = {};
    // // schFiles.Add(SchemasPath + "schematron\\EN16931-UBL-validation.sch");
    // schFiles.Add(SchemasPath + "schematron\\preprocessed\\EN16931-UBL-validation-preprocessed.sch");

    // if(!ValidateSch(xml, schFiles, SchemasPath + "schematron\\transpile.xsl", schValidationResultOutputFile)){
    //     MessageBox("xml FAILED SCH validation\n\nSee _SCH.err file for details.");
    //     return false;
    // }



    // //ako je sve prošlo bez greške, XML fajl je validiran, potpisan i poslat - u NKSYELOG treba upisati zapis o slanju, najprije status A pa konačno C
    // sql_ins = "INSERT INTO " + databaseName + ".dbo.NKSYELOG (sy_elog_date, sy_elog_num, sy_elog_status, sy_elog_person, sy_elog_estring, sy_elog_type, sy_elog_time,sy_elog_desc, sy_elog_rez3) " +
    //           "VALUES (@p1, @p2, @p3, @p4, @p5, @p6, @p7, @p8, @p9);";
    // sqlParams = {};
    // sqlParams.Add({"@p1", NKPR_GL_INVDTE});
    // sqlParams.Add({"@p2", invNum});
    // sqlParams.Add({"@p3", "A"});
    // sqlParams.Add({"@p4", userCode});
    // sqlParams.Add({"@p5", "" });
    // sqlParams.Add({"@p6", "IR"});
    // sqlParams.Add({"@p7", Now("HH:mm:ss")});
    // sqlParams.Add({"@p8", ""}); //"New Invoice/HOA Sent with attachment: " + xmlFileName});
    // sqlParams.Add({"@p9", Now("yyyy-MM-dd")});
    // sqlQuery(sql_ins, sqlParams);
    // //
    // sql_ins = "INSERT INTO " + databaseName + ".dbo.NKSYELOG (sy_elog_date, sy_elog_num, sy_elog_status, sy_elog_person, sy_elog_estring, sy_elog_type, sy_elog_time,sy_elog_desc, sy_elog_rez3) " +
    //           "VALUES (@p1, @p2, @p3, @p4, @p5, @p6, @p7, @p8, @p9);";
    // sqlParams = {};
    // sqlParams.Add({"@p1", NKPR_GL_INVDTE});
    // sqlParams.Add({"@p2", invNum});
    // sqlParams.Add({"@p3", "C"});
    // sqlParams.Add({"@p4", userCode});
    // sqlParams.Add({"@p5", "" });
    // sqlParams.Add({"@p6", "IR"});
    // sqlParams.Add({"@p7", Now("HH:mm:ss")}); 
    // sqlParams.Add({"@p8",""}); //"New Invoice/HOA Sent with attachment: " + xmlFileName});
    // sqlParams.Add({"@p9", Now("yyyy-MM-dd")});
    // sqlQuery(sql_ins, sqlParams);




    // if (Exists(path + fileName)) {
    //     MessageBox(2 + ": " + path + fileName);
    //     Copy(path + fileName, path + fileName + ".bak");
    // }
    // MessageBox(3);
    // SaveFile(xml);
    // //LogError("UBL_VALIDATED", "Generated & VALIDATED: " + fileName, "");
    // MessageBox("UBL generated & VALIDATED: " + fileName);
    return true;
}



function fillInvoiceLine(lineNum){
    NKPR_LN_PQTY = linRes[lineNum][0];
    NKPR_LN_INVNM = linRes[lineNum][1];
    NKPR_LN_AMT = linRes[lineNum][2];
    NKPR_LN_PCODE = linRes[lineNum][3].trim();
    NKPR_LN_SASTAV = linRes[lineNum][4];
    NKPR_LN_PDESC = linRes[lineNum][5].trim();
    NKPR_LN_GRUPA = linRes[lineNum][6].trim();
    NKPR_LN_TXBLE = linRes[lineNum][7];
    NKPR_LN_PRNPR = linRes[lineNum][8];
    NKPR_LN_JEDMJ = linRes[lineNum][9].trim();
    NKPR_LN_PPRCE = linRes[lineNum][10];
    NKPR_LN_PEXT = linRes[lineNum][11];
    NKPR_LN_PDISC = linRes[lineNum][12];
    NKPR_LN_DISC2 = linRes[lineNum][13];
    NKPR_LN_DISC2T = linRes[lineNum][14].trim();
    NKPR_LN_DISC3 = linRes[lineNum][15];
    NKPR_LN_DISC3T = linRes[lineNum][16].trim();
    NKPR_LN_MA_US = linRes[lineNum][17].trim();
    NKPR_LN_BR_LN = linRes[lineNum][18];
    NKPR_LN_BROPI = linRes[lineNum][19];
    NKPR_LN_BROPI1 = linRes[lineNum][20];
    NKPR_LN_PSTOPA = linRes[lineNum][21];
    NKPR_LN_POPU = linRes[lineNum][22];
    NKPR_LN_POPL = linRes[lineNum][23];
    return;
}


function GetUNUnitCode(jedmj) {
    if (jedmj == "KOM") { return "H87"; }
    if (jedmj == "KG")  { return "KGM"; }
    if (jedmj == "LIT") { return "LTR"; }
    if (jedmj == "MX2") { return "MTK"; }
    if (jedmj == "MX3") { return "MTQ"; }
    if (jedmj == "TON" || jedmj == "T") { return "TNE"; }
    if (jedmj == "GR"  || jedmj == "G") { return "GRM"; }
    if (jedmj == "SAT") { return "HUR"; }
    if (jedmj == "DAN") { return "DAY"; }
    if (jedmj == "MET" || jedmj == "M") { return "MTR"; }
    return "C62";
}


function GetMimeType(file) {
    ext = ParseFile(file, "pfExt").Lower(); // StrLower(string)
    if (ext == "pdf")  { return "application/pdf"; }
    if (ext == "doc")  { return "application/msword"; }
    if (ext == "docx") { return "application/vnd.openxmlformats-officedocument.wordprocessingml.document"; }
    if (ext == "xls")  { return "application/vnd.ms-excel"; }
    if (ext == "xlsx") { return "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"; }
    if (ext == "odt")  { return "application/vnd.oasis.opendocument.text"; }
    if (ext == "jpg" || ext == "jpeg") { return "image/jpeg"; }
    if (ext == "png")  { return "image/png"; }
    return "application/octet-stream";
}


// -----------------------------------------------------------
// SLANJE ERACUNA
// -----------------------------------------------------------

function SendERacun(){

    sql_erac = "SELECT
                ERAC_REZ1, ERAC_SERVER, ERAC_SERVERT, ERAC_USER, ERAC_PASS, ERAC_USERT, ERAC_PASST, ERAC_DESC 
                FROM " + databaseName + ".dbo.NKSYERAC WHERE ERAC_CODE = @p1;";
    sqlParams = {};
    // if(NKSC_POSREDNIK != ""){
    //     sqlParams.Add({"@p1", NKSC_POSREDNIK});
    //     PROVIDER = NKSC_POSREDNIK;
    // }else{
        sqlParams.Add({"@p1", PROVIDER});
    // }
    
    eracRes = sqlQuery(sql_erac, sqlParams);
    if (Size(eracRes) < 2) {
        MessageBox("Nema podataka o posredniku " + NKSC_POSREDNIK + "!");
        return false;
    }

    ERAC_REZ1 = eracRes[1][0].trim();
    ERAC_SERVER = eracRes[1][1].trim();
    ERAC_SERVERT = eracRes[1][2].trim();
    ERAC_USER = eracRes[1][3].trim();
    ERAC_PASS = eracRes[1][4].trim();
    ERAC_USERT = eracRes[1][5].trim(); // cer certificate
    ERAC_PASST = eracRes[1][6].trim(); // p12 certificate
    ERAC_DESC = eracRes[1][7].trim();



    if(PROVIDER == "MER" || PROVIDER == "MERDEMO"){
        //koristimo M.E.R. način slanja
        escapedXml = StrReplace(xml, "\n", " ");
        escapedXml = EscapeQuotesInXml(xml);
        
        jsonLoad = '{"Username": "' + ERAC_USER + '", "Password": "' + ERAC_PASS + '", "CompanyId": "' + supOIB + '"'/*uzet iz KPSYMSTR*/+', "SoftwareId": "' + ERAC_DESC + '", "File": "' + escapedXml + '"}';

        webRequestResult = WebRequest("POST", ERAC_SERVER + "send", jsonLoad, invNum,
                    "MERSuccess", "MERFailure", "application/json", null, 1000 * 20, false);

        // MSG("webRequestResult = " + webRequestResult); // !!! cijeli Json
    }
    elif(PROVIDER == "EPOS" || PROVIDER == "EPOSDEMO")
    {
        //koristimo ePoslovanje.hr način slanja
        SendToEPOS();
        return;
    }
    elif(PROVIDER == "FINA" || PROVIDER == "FINADEMO")
    {
        //koristimo FINA način slanja
        // za test koristimo račun "90100003"
        
        // MessageBox("Slanje putem FINA-e još nije implementirano.");
        SendToFINA();
        // ...

        return;
    }
    else
    {
        MessageBox("Nepoznat tip posrednika " + ERAC_REZ1 + " za slanje na eRačun: " + tip);
        return;
    }    
}

function MERSuccess(_invNum, responseCode, res) {
    MSG("MERSuccess");

    try{
        LogResponse(responseCode, res);

        resObject = DeserializeJson(res);    
        if(Contains(resObject, "StatusId") && resObject["StatusId"] == 20){
            MessageBox('resObject["StatusId"] == 20');
            LogNKSYELOG("C");
        }
        else{
            LogNKSYELOG("B", 'Debug: NEPOZNATA GREŠKA'); // !!!
        }

        // if(Contains(resObject, "File")){
        //     MessageBox("File = " + resObject["File"]);
        // }

        // MessageBox("ElectronicId = " + resObject["ElectronicId"]);
        // MessageBox("DocumentNr = " + resObject["DocumentNr"]);
        // MessageBox("DocumentTypeId = " + resObject["DocumentTypeId"]);
        // MessageBox("DocumentTypeName = " + resObject["DocumentTypeName"]);
        // MessageBox("StatusId = " + resObject["StatusId"]); // 20
        // MessageBox("StatusName = " + resObject["StatusName"]); // Odrađeno
        // MessageBox("RecipientBusinessNumber = " + resObject["RecipientBusinessNumber"]);
        // MessageBox("RecipientBusinessUnit = " + resObject["RecipientBusinessUnit"]);
        // MessageBox("RecipientBusinessName = " + resObject["RecipientBusinessName"]);
        // MessageBox("Created = " + resObject["Created"]);
        // MessageBox("Sent = " + resObject["Sent"]);
        // MessageBox("Modified = " + resObject["Modified"]);
        // MessageBox("Delivered = " + resObject["Delivered"]);        
    }
    catch(ex){
        MessageBox("MERSuccess - Greška pri parsiranju odgovora poslužitelja:\n" + ex);
        // LogNKSYELOG();
    }
    
}

function MERFailure(_invNum, responseCode, res) {
    MSG("MERFailure");

    try{
        LogResponse(responseCode, res);

        MSG("Slanje računa broj " + _invNum + " NEUSPJEŠNO!");

        // MessageBox("SendingFailure.ResponseCode = " + responseCode);

        resObject = DeserializeJson(res);
        MSG(resObject);

        // MessageBox("ElectronicId = " + resObject["ElectronicId"]);
        // MessageBox("DocumentNr = " + resObject["DocumentNr"]);
        // MessageBox("DocumentTypeId = " + resObject["DocumentTypeId"]);
        // MessageBox("DocumentTypeName = " + resObject["DocumentTypeName"]);
        // MessageBox("StatusId = " + resObject["StatusId"]);
        // MessageBox("StatusName = " + resObject["StatusName"]);
        // MessageBox("RecipientBusinessNumber = " + resObject["RecipientBusinessNumber"]);
        // MessageBox("RecipientBusinessUnit = " + resObject["RecipientBusinessUnit"]);
        // MessageBox("RecipientBusinessName = " + resObject["RecipientBusinessName"]);
        // MessageBox("Created = " + resObject["Created"]);
        // MessageBox("Sent = " + resObject["Sent"]);
        // MessageBox("Modified = " + resObject["Modified"]);
        // MessageBox("Delivered = " + resObject["Delivered"]);        
    }
    catch(ex){
        MessageBox("SendingFailure - Greška pri parsiranju odgovora poslužitelja:\n" + ex);
    }
}

function LogResponse(responseCode, response) {
    if(!DIR_EXISTS(FILESPATH + "responses\\")){
        MAKE_DIR(FILESPATH + "responses\\");
    }

    logFilePath = FILESPATH + "responses\\" + parsefile(attachmentPdfPath, "pfName") + ".response";
    appendText = Now("yyyy-MM-dd HH:mm:ss") + " -----------------------------------\n\n" + "StatusCode = " + responseCode + "\n\n" + "Response:\n" + response + "\n\n";
    try {
        SaveFile(appendText, logFilePath, "a");        
    } catch (ex) {
        MessageBox("CRITICAL: Cannot write to log file: " + logPath + "\nError: " + ex);
    }
}


/*
function SendToFINA() {

    endpoint = "https://prezdigitalneusluge.fina.hr/SendB2BOutgoingInvoicePKIWebService/services/SendB2BOutgoingInvoicePKIWebService";        // production
    // endpoint = "https://e-racun.fina.hr/services/InvoicingService";        // production
    // endpoint = "https://test.e-racun.fina.hr/services/InvoicingService"; // test

    base64Ubl = File2Base64(xmlFileName);

    soapEnvelope = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n";
    soapEnvelope += "<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:fin=\"http://www.fina.hr/e-racun/services\">\n";
    soapEnvelope += "  <soapenv:Header/>\n";
    soapEnvelope += "  <soapenv:Body>\n";
    soapEnvelope += "    <fin:SendB2BOutgoingInvoiceMsg>\n";
    soapEnvelope += "      <HeaderSupplier>\n";
    soapEnvelope += "        <MessageID>" + Math.Round(Math.Random() * 1000000000) + "</MessageID>\n";
    soapEnvelope += "        <SupplierID>9934:HR" + supOIB + "</SupplierID>\n";
    soapEnvelope += "        <AdditionalSupplierID>0088:" + KPSY_REZERVAX + "</AdditionalSupplierID>\n";
    soapEnvelope += "        <MessageType>9001</MessageType>\n";
    soapEnvelope += "      </HeaderSupplier>\n";
    soapEnvelope += "      <Data>\n";
    soapEnvelope += "        <B2BOutgoingInvoiceEnvelope>\n";
    soapEnvelope += "          <XMLStandard>UBL</XMLStandard>\n";
    soapEnvelope += "          <SpecificationIdentifier>urn:cen.eu:en16931:2017#compliant#urn:mfin.gov.hr:cius-2025:1.0</SpecificationIdentifier>\n";
    soapEnvelope += "          <SupplierInvoiceID>" + invNum + "</SupplierInvoiceID>\n";
    soapEnvelope += "          <BuyerID>9934:HR" + NKPR_GL_JMBG + "</BuyerID>\n";
    soapEnvelope += "          <InvoiceEnvelope>" + base64Ubl + "</InvoiceEnvelope>\n";
    soapEnvelope += "        </B2BOutgoingInvoiceEnvelope>\n";
    soapEnvelope += "      </Data>\n";
    soapEnvelope += "    </fin:SendB2BOutgoingInvoiceMsg>\n";
    soapEnvelope += "  </soapenv:Body>\n";
    soapEnvelope += "</soapenv:Envelope>";

    // Sign SOAP with client certificate (WS-Security)
    signedSoap = SignSoapWithCert(soapEnvelope, ERAC_PASST, ERAC_PASS);

    // if (signedSoap == "") {
    //     LogError("FINA_SIGN_FAIL", "SOAP signing failed", "");
    //     return false;
    // }

    headers = {};
    headers["Content-Type"] = "text/xml; charset=utf-8";
    headers["SOAPAction"] = "";

    try {
        response = WebRequest(
            "POST",                     // method
            endpoint,                   // URL
            signedSoap,                 // load
            invNum,                     // trackingId
            "FINASuccess",              // OnSuccess
            "FINAFailure",              // OnFailure
            "text/xml; charset=utf-8",  // contentType
            headers,                    // headers dictionary
            1000 * 30,                  // timeout (30 seconds)
            false                       // justFire
        );
        // SaveResponseLog(response, "FINA");

        // ackStatus = ExtractXML(response, "AckStatus");
        // zki = ExtractXML(response, "ZKI");
        // jir = ExtractXML(response, "JIR");

        // if (ackStatus == "10") {  // ACCEPTED
        //     LogError("FINA_OK", "Invoice accepted", "ZKI=" + zki + " JIR=" + jir);
        //     return true;
        // } else {
        //     errorMsg = ExtractXML(response, "ErrorMessage");
        //     LogError("FINA_REJECT", "Invoice rejected", "Status=" + ackStatus + " Msg=" + errorMsg);
        //     return false;
        // }
    } catch (ex) {
        // LogError("FINA_EXCEPTION", "WebRequest failed", ex);
        // return false;
    }
}

*/
function SendToEPOS() {
    // Determine endpoint based on provider configuration
    endpoint = ERAC_SERVER;
    if (PROVIDER == "EPOSDEMO") {
        endpoint = ERAC_SERVERT;
    }

    if (endpoint == "") {
        MessageBox("Endpoint za ePoslovanje provider nije definiran u NKSYERAC.");
        return;
    }

    // Read the XML file content
    xmlContent = ReadFile(xmlFileName);
    if (xmlContent == "") {
        MessageBox("Greška pri čitanju XML datoteke za ePoslovanje.");
        return;
    }

    // Prepare JSON payload for ePoslovanje API v2
    // Using DocumentSendRequest schema from API documentation
    jsonPayload = {
        "document": xmlContent,
        "softwareId": ERAC_DESC
    };

    jsonLoad = SerializeJson(jsonPayload);

    // Prepare headers with API key authentication
    headers = {};
    headers["Authorization"] = ERAC_USER; // API Key stored in ERAC_USER field
    headers["Content-Type"] = "application/json";

    try {
        // Send to ePoslovanje API v2 document send endpoint
        webRequestResult = WebRequest(
            "POST",                         // method
            endpoint + "/api/v2/document/send",  // URL with API v2 endpoint
            jsonLoad,                       // JSON payload
            invNum,                         // tracking ID
            "EPOSSuccess",                  // success callback
            "EPOSFailure",                  // failure callback
            "application/json",             // content type
            headers,                        // headers with API key
            1000 * 30,                      // 30 second timeout
            false                           // not fire-and-forget
        );
    } catch (ex) {
        MessageBox("Greška pri slanju na ePoslovanje: " + ex);
        LogNKSYELOG("B", "EPOS WebRequest exception: " + ex);
    }
}

function SendToFINA() {
    // Determine endpoint based on provider configuration
    endpoint = ERAC_SERVER;
    if (PROVIDER == "FINADEMO") {
        endpoint = ERAC_SERVERT;
    }

    if (endpoint == "") {
        MessageBox("Endpoint za FINA provider nije definiran u NKSYERAC.");
        return;
    }

    // 1. Prepare the XML body for the SOAP request
    base64Ubl = File2Base64(xmlFileName);

    xmlBody = "<fin:SendB2BOutgoingInvoiceMsg xmlns:fin=\"http://www.fina.hr/e-racun/services\">\n";
    xmlBody += "  <HeaderSupplier>\n";
    xmlBody += "    <MessageID>" + UUID() + "</MessageID>\n";
    xmlBody += "    <SupplierID>9934:HR" + supOIB + "</SupplierID>\n";
    xmlBody += "    <AdditionalSupplierID>0088:" + KPSY_REZERVAX + "</AdditionalSupplierID>\n";
    xmlBody += "    <MessageType>9001</MessageType>\n";
    xmlBody += "  </HeaderSupplier>\n";
    xmlBody += "  <Data>\n";
    xmlBody += "    <B2BOutgoingInvoiceEnvelope>\n";
    xmlBody += "      <XMLStandard>UBL</XMLStandard>\n";
    xmlBody += "      <SpecificationIdentifier>urn:cen.eu:en16931:2017#compliant#urn:mfin.gov.hr:cius-2025:1.0</SpecificationIdentifier>\n";
    xmlBody += "      <SupplierInvoiceID>" + invNum + "</SupplierInvoiceID>\n";
    xmlBody += "      <BuyerID>9934:HR" + NKPR_GL_JMBG + "</BuyerID>\n";
    xmlBody += "      <InvoiceEnvelope>" + base64Ubl + "</InvoiceEnvelope>\n";
    xmlBody += "    </B2BOutgoingInvoiceEnvelope>\n";
    xmlBody += "  </Data>\n";
    xmlBody += "</fin:SendB2BOutgoingInvoiceMsg>";

    // 2. Define the SOAPAction (often empty for FINA services)
    soapAction = "";

    // 3. Call the unified CreateSOAP function
    try {
        // CreateSOAP handles signing and sending the request, and returns the response.
        // It expects: xmlBody, soapAction, endpoint, certIdentifier, certPassword
        response = await CreateSOAP(
            xmlBody,
            soapAction,
            endpoint,
            ERAC_PASST, // Certificate path from NKSYERAC
            ERAC_PASS   // Certificate password from NKSYERAC
        );

        // 4. Process the response
        if (response.StartsWith("ERROR:") || response.StartsWith("HTTP_ERROR:") || response.StartsWith("EXCEPTION:")) {
            FINAFailure(invNum, 0, response);
        } else {
            FINASuccess(invNum, 200, response);
        }
    } catch (ex) {
        FINAFailure(invNum, 0, "Greška pri pozivu CreateSOAP funkcije: " + ex);
    }
}

function EPOSSuccess(_invNum, responseCode, res) {
    MSG("EPOSSuccess");

    try {
        LogResponse(responseCode, res);

        resObject = DeserializeJson(res);
        
        // ePoslovanje API v2 returns DocumentSendResponse
        if (Contains(resObject, "id") && Contains(resObject, "insertedOn")) {
            documentId = resObject["id"];
            insertedOn = resObject["insertedOn"];
            message = Contains(resObject, "message") ? resObject["message"] : "Dokument uspješno poslan";
            
            MSG("ePoslovanje Document ID: " + documentId);
            MSG("Inserted On: " + insertedOn);
            MSG("Message: " + message);
            
            // Log successful sending
            LogNKSYELOG("C", "EPOS Success - Doc ID: " + documentId);
            
            // Optional: Store document ID for future reference
            StoreEPOSDocumentId(_invNum, documentId, insertedOn);
        }
        else {
            MSG("ePoslovanje response structure unexpected");
            LogNKSYELOG("B", "EPOS Success but unexpected response structure");
        }
    }
    catch (ex) {
        MessageBox("EPOSSuccess - Greška pri parsiranju odgovora poslužitelja:\n" + ex);
        LogNKSYELOG("B", "EPOS Success parsing error: " + ex);
    }
}

function EPOSFailure(_invNum, responseCode, res) {
    MSG("EPOSFailure");

    try {
        LogResponse(responseCode, res);

        MSG("Slanje računa broj " + _invNum + " na ePoslovanje NEUSPJEŠNO!");
        MSG("Response Code: " + responseCode);

        // Try to parse error response
        if (res != "") {
            try {
                resObject = DeserializeJson(res);
                
                // ePoslovanje API v2 ErrorResponse structure
                if (Contains(resObject, "error")) {
                    errorMsg = resObject["error"];
                    details = Contains(resObject, "details") ? resObject["details"] : "";
                    
                    MSG("ePoslovanje Error: " + errorMsg);
                    if (details != "") {
                        MSG("Error Details: " + details);
                    }
                    
                    LogNKSYELOG("B", "EPOS Error: " + errorMsg + (details != "" ? " - " + details : ""));
                    MessageBox("Greška ePoslovanje:\n" + errorMsg + (details != "" ? "\n\nDetalji: " + details : ""));
                }
                else {
                    MSG("ePoslovanje error response format unknown");
                    LogNKSYELOG("B", "EPOS unknown error format: " + res);
                    MessageBox("Nepoznata greška ePoslovanje:\n" + res);
                }
            }
            catch (parseEx) {
                MSG("Cannot parse ePoslovanje error response: " + parseEx);
                LogNKSYELOG("B", "EPOS error parsing failed: " + parseEx);
                MessageBox("Greška ePoslovanje (unparseable):\n" + res);
            }
        }
        else {
            MSG("ePoslovanje error with empty response");
            LogNKSYELOG("B", "EPOS error with empty response, code: " + responseCode);
            MessageBox("ePoslovanje greška bez odgovora. Status kod: " + responseCode);
        }
    }
    catch (ex) {
        MessageBox("EPOSFailure - Greška pri obradi neuspjeha:\n" + ex);
        LogNKSYELOG("B", "EPOS Failure processing error: " + ex);
    }
}

// Helper function to store ePoslovanje document ID for future reference
function StoreEPOSDocumentId(invoiceNum, documentId, insertedOn) {
    try {
        sqlQueryString = "UPDATE " + databaseName + ".dbo.NKPRINV SET NKPR_EPOS_ID = @p1, NKPR_EPOS_DATE = @p2 WHERE NKPR_GL_NUM = @p3";
        sqlParams = {};
        sqlParams.Add({"@p1", documentId});
        sqlParams.Add({"@p2", insertedOn});
        sqlParams.Add({"@p3", invoiceNum});
        
        sqlQuery(sqlQueryString, sqlParams);
        MSG("ePoslovanje document ID stored in database");
    }
    catch (ex) {
        MSG("Warning: Could not store ePoslovanje document ID: " + ex);
        // Non-critical error, continue processing
    }
}

function FINASuccess(_invNum, responseCode, res) {
    MSG("FINASuccess");

    LogResponse(responseCode, res);
}

function FINAFailure(_invNum, responseCode, res) {
    MSG("FINAFailure");

    LogResponse(responseCode, res);
}






// -----------------------------------------------------------
// ERROR LOGGING
// -----------------------------------------------------------

function LogNKSYELOG(elogStatusCode, description = ""){
    sqlQueryString = "INSERT INTO " + databaseName + ".dbo.NKSYELOG 
    (sy_elog_num, sy_elog_date, sy_elog_status, sy_elog_person, sy_elog_estring, sy_elog_type, sy_elog_time, sy_elog_desc, sy_elog_rez3)
    VALUES (@p1, @p2, @p3, @p4, @p5, @p6, @p7, @p8, @p9);";

    sqlParams = {};
    sqlParams.Add({"@p1", NKPR_GL_NUM});
    sqlParams.Add({"@p2", NKPR_GL_INVDTE});
    sqlParams.Add({"@p3", elogStatusCode.Upper()});
    sqlParams.Add({"@p4", userCode});
    sqlParams.Add({"@p5", "" });
    sqlParams.Add({"@p6", "IR"});
    sqlParams.Add({"@p7", Now("HH:mm:ss")});
    sqlParams.Add({"@p8", description});
    sqlParams.Add({"@p9", Now("yyyy-MM-dd")});
    sqlQuery(sqlQueryString, sqlParams);
    return;
}

/*

//error logging

// // ---------------------------------------------------------------
// // Comprehensive Error Logging System for UBL Generation
// // ---------------------------------------------------------------
// function LogError(context, message, exception = "") {
//     logPath = "fiskal_error.log";
//     timestamp = FormatDate(Now(), "yyyy-MM-dd HH:mm:ss");
//     logLine = timestamp + " | " + context + " | " + message;
//     if (exception != "") {
//         logLine += " | Exception: " + exception;
//     }
//     logLine += "\r\n";
 
//     try {
//         SaveFile(logPath, logLine); ovo mi se čini da ni u sintaxi ali imamo i append
//     } catch (e) {
//         MessageBox("CRITICAL: Cannot write to log file: " + logPath + "\nError: " + e);
//     }
// }
 
//Primjer :
// LogError("INPUT", "Invalid invoice number", "invNum=" + invNum);
 
//I datoteke:
 
2025-11-06 23:05:11 | START | Generating UBL for invoice | invNum=90100002
2025-11-06 23:05:12 | DB_HEADER_RETRY | Attempt 1 failed | Connection timeout
2025-11-06 23:05:13 | LINE_PROCESS | Failed line 3 | Null reference
2025-11-06 23:05:14 | SUCCESS | UBL generated | UBL_90100002.xml

*/

/*

// ===============================================================
// ePOSLOVANJE PROVIDER CONFIGURATION SETUP GUIDE
// ===============================================================
//
// To set up ePoslovanje.hr as a provider, you need to configure:
//
// 1. NKSYSYCO table - Set provider type:
//    INSERT INTO NKSYSYCO (NKSYS_MODUL, NKSYS_GRUP, NKSYS_FIELD, NKSYS_VALUE)
//    VALUES ('WKSY', 'ERACUN', 'PROVIDER', 'EPOS');
//    -- For test environment use 'EPOSDEMO'
//
// 2. NKSYERAC table - Set endpoint and API key:
//    INSERT INTO NKSYERAC (
//        ERAC_CODE, ERAC_SERVER, ERAC_SERVERT, ERAC_USER, ERAC_PASS, ERAC_DESC
//    ) VALUES (
//        'EPOS',                                    -- Provider code
//        'https://eracun.eposlovanje.hr',          -- Production endpoint
//        'https://test.eposlovanje.hr',             -- Test endpoint
//        'your-api-key-here',                       -- API Key (získať z ePoslovanje.hr)
//        '',                                        -- Password not needed for API key auth
//        'YOUR-SOFTWARE-ID'                         -- Software identifier
//    );
//
// ePoslovanje API v2 Endpoints:
// - Production: https://eracun.eposlovanje.hr/api/v2/document/send
// - Test: https://test.eposlovanje.hr/api/v2/document/send
//
// API Key Authentication:
// - Register at: https://eracun.eposlovanje.hr/client/register (production)
//                https://test.eposlovanje.hr/client/register (test)
// - Get API key from account settings or via API
// - Store API key in ERAC_USER field
//
// Pricing (as of 2025):
// - 0.08 EUR + VAT per invoice
// - Prepaid: minimum 4.00 EUR + VAT (valid for 6 months)
// - Postpaid: 4.00 EUR + VAT monthly (includes 50 invoices)
//
// Features included:
// - Automatic fiscalization 2.0 for outgoing documents
// - eReporting to tax authorities
// - Archive of sent/received invoices (free)
// - Interconnection with other providers (FINA, Hrvatski Telekom, etc.)
//
// Database Schema Extensions (optional):
// ALTER TABLE NKPRINV ADD NKPR_EPOS_ID VARCHAR(50);    -- ePoslovanje document ID
// ALTER TABLE NKPRINV ADD NKPR_EPOS_DATE VARCHAR(50);  -- Insertion timestamp
//
// Testing:
// 1. Set PROVIDER to 'EPOSDEMO' in NKSYSYCO
// 2. Register test account at https://test.eposlovanje.hr/client/register
// 3. Configure NKSYERAC with test endpoint and API key
// 4. Send test invoices to Test d.o.o. (OIB: 50930104221)
//
// ===============================================================

*/



